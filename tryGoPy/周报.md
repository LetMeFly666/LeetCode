<!--
 * @Author: LetMeFly
 * @Date: 2025-01-10 21:26:23
 * @LastEditors: LetMeFly.xyz
 * @LastEditTime: 2025-01-14 18:30:07
-->
# 虚拟机迁移

进行了OWA的迁移操作，记录了一些想得到的踩坑记录。

## 1. 文件传输

首先如何将50G的虚拟机文件通过网络传输到项目机器上是个问题。

网盘？限速又不安全。

远程桌面？第三方远程桌面传文件太慢，微软自带远程桌面局域网传文件经常传到一半突然遇到“未知错误”，然后全部失败从来，搞人心态。

最终在我原本成功部署OWA虚拟机的电脑上配置了SMB，在项目服务器上通过局域网传了过去。网速几十M/s且很稳定

## 2. 导入虚拟机

虚拟机文件都已经就绪了，直接从Hyper-V管理器中导入虚拟机。

导入很顺利，很快就看到了在我电脑上熟悉的界面。按部就班，启动！

然后就就出意外了，OWA运行所需的一些服务说啥都启动不成功，一直卡在启动界面。

## 3. 再次启动虚拟机

中间被JunKe的项目搁置了一下，当我再次想部署这个虚拟机的时候，发现启动失败，说是不兼容。

于是我准备删除这个虚拟机重新导入一次，然后问题就来了，未在文件夹中监测到虚拟机。

打开文件夹和我本地机器对比，发现一些文件丢失。不知道是什么导致的。

![empty-machine](file:///C:/Users/LetMeFly/Desktop/M国J网/binaryFiles/pics/20250114/empty-machine.png)

于是我重新拷贝了这些文件，再次重新启动。

这次导入类型我选择了“就地注册”：

![就地注册](file:///C:/Users/LetMeFly/Desktop/M国J网/binaryFiles/pics/20250114/就地注册.png)

开局先创建一个检查点，误操时便于回滚：

![检查点](file:///C:/Users/LetMeFly/Desktop/M国J网/binaryFiles/pics/20250114/检查点.png)

这次连启动都失败了，报错`无法开机，因为发生了错误“另一个程序正在使用此文件，进程无法访问”`。

![启动失败](file:///C:/Users/LetMeFly/Desktop/M国J网/binaryFiles/pics/20250114/启动失败.png)

看上面也没运行什么东西，悄悄重启了一下(bushi)

虚拟机再次启动成功！

![熟悉的界面回来了](file:///C:/Users/LetMeFly/Desktop/M国J网/binaryFiles/pics/20250114/熟悉的界面回来了.png)

## 4. 服务一直在“启动中”

然后和之前一样，服务怎么都无法成功启动。

![服务启动失败](file:///C:/Users/LetMeFly/Desktop/M国J网/binaryFiles/pics/20250114/服务启动失败.png)

但是服务并不是无限启动中，等待时间比较久还是会显示启动失败的，于是决定让所有能启动的服务先启动再说。

同时查看了一下错误日志：

```
DC1	4000	错误	Microsoft-Windows-DNS-Server-Service	DNS Server	2025/1/07 22:13:18
DC1	4015	错误	Microsoft-Windows-DNS-Server-Service	DNS Server	2025/1/08 22:12:34
DC1	4007	错误	Microsoft-Windows-DNS-Server-Service	DNS Server	2025/1/09 22:08:48
```

还有启动了几十分钟最后还启动成功了的服务。

在服务启动的同时先访问一下OWA试试，加载五六分钟后显示`LDAP服务器启动失败`。

![LDAP服务器启动失败](file:///C:/Users/LetMeFly/Desktop/M国J网/binaryFiles/pics/20250114/LDAP服务器启动失败.png)

尝试用http访问，结果并无二样。

如果实在不行，准备不“迁移”了，从头重装一次试试。
