<!--
 * @Author: LetMeFly
 * @Date: 2025-06-16 12:45:30
 * @LastEditors: LetMeFly.xyz
 * @LastEditTime: 2025-06-22 15:17:30
-->
# “安装包”、傻瓜式说明整理

本次打包了包括OWA图片信标、webex双信息解密两大部分。

详情请见installer压缩包(nextcloud的20250622-installer-source.zip)

# 详细说明整理

已有工作大致概括一下是：搭建远程办公环境、(设计shell提权为窗口的方法、)设计修改数据包的OWA隐蔽传输方式、设计邮件信标的OWA隐蔽传输方式、设计基于时间间隔的webex隐蔽传输方式。

## 修改数据包的OWA隐蔽传输方式

这个可参考周报：`20250308-李腾飞-工作周报-通过邮件两台主机隐蔽传输消息.pdf`（参考周报可能不是最终版本，后续可能会在此基础上进行小改动，但参考周报是最易懂的版本）

通俗的话讲，这个是在干什么呢？就是往收发双方植入一个证书，通过`mitmproxy`修改收发双方主机上的数据包，实现在收发双方看到邮件**完全**正常的同时默默传输隐蔽信息。

### 如何修改数据包

```bash
pip install mitmproxy
mitmproxy --mode transparent  # 禁止python透过防火墙的话，可能需要管理员权限下运行
# 也可以指定只捕获本机数据包：mitmproxy -s main.py --listen-host localhost，这样的话在我笔记本上实测不需要管理员权限
```

浏览器访问`http://mitm.it`下载证书并安装：

+ 双击P12文件，启动导入向导。
+ 选择证书存储位置(这将决定谁将信任该证书——仅当前Windows用户OR机器上的所有人)点击下一步。
+ 再次点击下一步。
+ 将密码留空并点击下一步。
+ 选择“将所有证书放入以下存储”，然后点击浏览，并选择“受信任的根证书颁发机构”。
+ 点击确定和下一步。
+ 点击完成。
+ 在警告对话框中点击是以确认。

这一步中，若是向“当前用户”安装证书，则**不需要管理员权限**。

可以编写简单脚本来验证HTTP包修改成功：

```python
from mitmproxy import http
import logging

logger_url = logging.getLogger('logger_url')
formatter_url = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s')
for handler in logger_url.handlers[:]:
    if isinstance(handler, logging.StreamHandler):
        logger_url.removeHandler(handler)
logger_url.setLevel(logging.DEBUG)
filehandler_url = logging.FileHandler('url.log')
filehandler_url.setFormatter(formatter_url)
logger_url.addHandler(filehandler_url)

def request(flow: http.HTTPFlow) -> None:
    pass

def response(flow: http.HTTPFlow) -> None:
    # 修改响应
    logger_url.info(flow.request.pretty_url)
    if "web.letmefly.xyz" in flow.request.pretty_url and 'text/html' in flow.response.headers.get('content-type', ''):
        logger_url.info('replace HTML to LMTH')
        flow.response.text = flow.response.text.replace("HTML", "LMTH")
```

设置代理服务器为`localhost:8080`，然后：

```bash
mitmproxy -s modifyPackage.py --listen-host localhost
```

访问[web.letmefly.xyz](https://letmefly.xyz/?From=周报-3day4week)，可以发现“HTML”被替换为了“LMTH”。

### 发送方数据包篡改

以QQ邮箱为例验证该方案的可行性。抓包可发现QQ邮箱发送邮件时，邮件正文在`content__html`字段中，因此可以抓包对此字段做手脚：

```python
from mitmproxy import http
from urllib.parse import parse_qs, urlencode
import logging

logger_url = logging.getLogger('logger_url')
formatter_url = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s')
for handler in logger_url.handlers[:]:
    if isinstance(handler, logging.StreamHandler):
        logger_url.removeHandler(handler)
logger_url.setLevel(logging.DEBUG)
filehandler_url = logging.FileHandler('url.log')
filehandler_url.setFormatter(formatter_url)
logger_url.addHandler(filehandler_url)


class AddSignatureAddon:
    def request(self, flow: http.HTTPFlow) -> None:
        # 检查目标路径和请求方法
        if flow.request.method == "POST" and "/cgi-bin/compose_send" in flow.request.url:
            # 确保Content-Type正确
            content_type = flow.request.headers.get("Content-Type", "")
            if "application/x-www-form-urlencoded" in content_type:
                # 解析原始表单数据
                try:
                    parsed_data = parse_qs(flow.request.content.decode("utf-8"))
                except Exception as e:
                    logger_url(f"解析表单数据失败: {e}")
                    return

                # 修改content__html字段
                if "content__html" in parsed_data and parsed_data["content__html"]:
                    original_content = parsed_data["content__html"][0]
                    new_content = original_content + "*******计划有变*******"
                    parsed_data["content__html"][0] = new_content

                    # 重新编码并更新请求内容
                    updated_content = urlencode(parsed_data, doseq=True).encode("utf-8")
                    flow.request.content = updated_content
                    logger_url("成功添加签名！")
                else:
                    logger_url("未找到content__html字段")

addons = [AddSignatureAddon()]
```

设置代理服务器为`localhost:8080`，然后：

```bash
mitmproxy -s modifyPackage.py --listen-host localhost
```

发送邮件，可以看到网页端没有任何异常，浏览器控制台也一切正常。

但是实际发出的邮件就不一样了，多了一段`*******签名*******`

### 接收方数据包篡改

接收方篡改无需分析HTML格式，只需要正则匹配提取密文即可。接收方篡改有个注意事项，邮件返回内容是以gb18030格式编码的。所以默认的UTF-8很容易乱码。


```python
def response(self, flow: http.HTTPFlow) -> None:
    if flow.request.method == 'GET' and '/cgi-bin/readmail' in flow.request.url:
        if "text/html" not in flow.response.headers.get("Content-Type", ""):
            return
        try:
            html_content = flow.response.content.decode("gb18030")
        except UnicodeDecodeError:
            logger.info('解码失败：可能不是GB18030编码')
        match = re.search(r'\*{7}(.*?)\*{7}', html_content)
        if match:
            signature = match.group(1)
            logger.info(f"提取到签名：{signature}")
            html_content = re.sub(r'\*{7}.*?\*{7}', '', html_content)
        flow.response.content = html_content.encode("gb18030")
        flow.response.headers["Content-Length"] = str(len(flow.response.content))
```

### 另外的工作

上面是为了方便理解所以描述的简单版本，后续周报中也进行了一些优化，如“将隐蔽传输的消息加密和解密”、“使用HTML格式隐藏额外元素”等。

还有一些小脚本，可用来演示接收和发送等。


发送方demo：

```python
while True:
    data = input('想隐蔽传输的信息：')
    with open('letsender', 'w', encoding='utf-8') as f:
        f.write(data)
```

接收方demo：

```python
import time
from watchdog.observers import Observer
from watchdog.events import FileSystemEventHandler
import os

FILE_PATH = 'letreceiver'

if not os.path.exists(FILE_PATH):
    os.system(f'echo > {FILE_PATH}')

class FileChangeHandler(FileSystemEventHandler):
    def on_modified(self, event):
        if event.src_path.endswith(FILE_PATH):
            print(f"File {FILE_PATH} has been modified. Reading new content...")
            self.read_file_content()

    def read_file_content(self):
        try:
            with open(FILE_PATH, 'r', encoding='utf-8') as file:
                content = file.read()
                print("New content:")
                print(content)
        except Exception as e:
            print(f"Error reading file: {e}")

if __name__ == "__main__":
    # 创建事件处理器和观察者
    event_handler = FileChangeHandler()
    observer = Observer()
    observer.schedule(event_handler, path='.', recursive=False)

    # 启动观察者
    observer.start()
    print(f"Started watching {FILE_PATH} for changes...")

    try:
        while True:
            time.sleep(1)
    except KeyboardInterrupt:
        observer.stop()

    observer.join()
```

演示视频：[nextcloud-通过邮件传递隐藏信息-ltf-20250308.flv](https://nextcloud.bupt-narc.cn/f/313275)  只有内网能访问到。

### 特点

代理是在系统层面的，浏览器即使抓包也看不到隐蔽传输的内容。

## 设计邮件信标的OWA隐蔽传输方式

这个可参考周报：`20250413-李腾飞-两个邮件隐蔽传输信道实现.pdf`

通俗的话来讲，这个信道传输是干了一件什么事情呢？是发送邮件的时候像邮件中插入一个1x1像素的透明图片，不影响邮件的正常界面，但是接收方阅读邮件时就会访问图片服务器加载图片。在这个过程中，隐藏在图片参数中的密文就能被服务端截获并解密成明文了。

视频地址：[通过邮件传递隐藏信息-ltf-20250407.mkv](https://nextcloud.bupt-narc.cn/f/315996)

### 可行性论证

#### 一、信标合理性验证

现有很多邮件信标服务，可参考：[Web beacons on websites and in e-mail](https://securelist.com/web-beacons-on-websites-and-in-email/108632/)，这里列举了10大流行信标服务。

正常流程来说是每一封邮件对应一个id，图片参数也带上这个id，这样图片在加载的时候就信标服务器能对应上是哪一封邮件被阅读了。

信标被发明的初衷是追踪用户的邮件阅读情况。

#### 二、MJ邮件中确实有使用信标的现象

MJ泄露的邮件：[wikileaks - Search the DNC email database](https://wikileaks.org/dnc-emails/)

其中找到了一封，邮件地址：[Trump's tax return tap dance](https://wikileaks.org/dnc-emails/emailid/745)

```
From:CNNNightcap@turner.com
To: kaplanj@dnc.org
Date: 2016-05-11 23:43
Subject: Trump's tax return tap dance
```

```html
<img src="http://branding.rs-1185-a.com/recommend/transparent.gif" style="width: 143px;height: 40px;border: 0;outline: none;text-decoration: none;-ms-interpolation-mode: bicubic;" width="143" height="40" border="0" alt="Learn more about RevenueStripe...">
<img src="https://cdn-images.mailchimp.com/icons/social-block-v2/outline-light-facebook-48.png" style="display: block;border: 0;outline: none;text-decoration: none;-ms-interpolation-mode: bicubic;" height="24" width="24" class="">
<img src="http://cnn.us11.list-manage.com/track/open.php?u=47c9040f6ff957a59bd88396e&id=19b7d1a066&e=531c496baa" height="1" width="1">
```

说明MJ邮件可以访问外网，并且第3张图片就是邮件信标！

### 编解码设计

编解码设计采用如下机制：

收发双方约定一个密钥用来加密（当然可以约定密钥随着日期进行一定的运算或变化之类的），加密方式为AES256加密。

这种加密方式有一个优点，就是每次加密的时候都会生成一个临时密钥（随机盐值，被称为初始化向量IV）并附加在加密字符串中，并用这个临时的密钥进行编码，这样即使相同的明文每次编码得到的密文也是不同的。

这样有一些好处，一个是每次生成密文必不相同，正好满足“每封邮件的信标id需要各不相同”。另一个是这种加密方式使得每种字符的使用频率保持一致，不会出现“正常语境中字母a使用频率较高的情况”。

```python
from Crypto.Cipher import AES
from Crypto.Util.Padding import pad, unpad


def encrypt_aes(plaintext: str, key: bytes) -> bytes:
    cipher = AES.new(key, AES.MODE_CBC)  # 使用CBC模式
    ct_bytes = cipher.encrypt(pad(plaintext.encode(), AES.block_size))
    return cipher.iv + ct_bytes  # 返回IV + 密文


def decrypt_aes(ciphertext: bytes, key: bytes) -> str:
    iv = ciphertext[:AES.block_size]
    ct = ciphertext[AES.block_size:]  # 密文
    cipher = AES.new(key, AES.MODE_CBC, iv)
    pt = unpad(cipher.decrypt(ct), AES.block_size)
    return pt.decode()

msg = '其实今天要进攻'
key = bytes.fromhex('e3a9a39b3c95c109257aeb8c09cb8ad331779647c54de1a40a66d308f8e4a882')  # 演示用，实际可别公布
encrypted = encrypt_aes(msg, key)
print(encrypted.hex())
decrypt = decrypt_aes(encrypted, key)
print(decrypt)
```

### 信标服务

加密解密设计完成后，信标服务就不难了，使用python的flask即可搭建一个轻量的信标服务。

```python
from flask import Flask, request, send_file
import io
from Crypto.Cipher import AES
from Crypto.Util.Padding import unpad
from binascii import unhexlify

app = Flask('LetMeFly_xyz - Flask(MGJW)')

# 1x1像素的PNG图片
minimal_image = b'\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\x01\x00\x00\x00\x01\x08\x02\x00\x00\x00\x90wS\xde\x00\x00\x00\x0cIDAT\x08\xd7c\xf8\x0f\x00\x01\x01\x01\x00\x1f\x9d\x8e\xf4\x00\x00\x00\x00IEND\xaeB`\x82'


def decrypt_aes(ciphertext: str) -> str:
    ciphertext = unhexlify(ciphertext)
    key = bytes.fromhex('e3a9a39b3c95c109257aeb8c09cb8ad331779647c54de1a40a66d308f8e4a882')  # 演示用
    iv = ciphertext[:AES.block_size]
    ct = ciphertext[AES.block_size:]  # 密文
    cipher = AES.new(key, AES.MODE_CBC, iv)
    pt = unpad(cipher.decrypt(ct), AES.block_size)
    return pt.decode()


@app.route('/image', methods=['GET'])
def get_image():
    # 获取查询参数
    jwt = request.args.get('jwt', default='', type=str)
    print(jwt)
    decrypted = decrypt_aes(jwt)
    print(decrypted)
    # 返回图片
    return send_file(
        io.BytesIO(minimal_image),
        mimetype='image/png',
        as_attachment=False
    )


@app.route('/')
def index():
    return "Hello World"


if __name__ == '__main__':
    app.run(debug=True, host='narc.letmefly.xyz', port=86)
```

访问[http://narc.letmefly.xyz:86/image?jwt=1a8c06cbcd61e779f815d36369ce04b9c105f94d58dca2eb65bf08ef4af993cdc38b9e4e456e56a9fe8fd1e1a3212e78](http://narc.letmefly.xyz:86/image?jwt=1a8c06cbcd61e779f815d36369ce04b9c105f94d58dca2eb65bf08ef4af993cdc38b9e4e456e56a9fe8fd1e1a3212e78)

后台执行结果：

```
 * Serving Flask app 'LetMeFly_xyz - Flask(MGJW)'
 * Debug mode: on
WARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.
 * Running on http://narc.letmefly.xyz:86
Press CTRL+C to quit
 * Restarting with watchdog (windowsapi)
 * Debugger is active!
 * Debugger PIN: 651-542-922
1a8c06cbcd61e779f815d36369ce04b9c105f94d58dca2eb65bf08ef4af993cdc38b9e4e456e56a9fe8fd1e1a3212e78
其实今天要进攻
10.112.175.237 - - [28/Mar/2025 00:41:47] "GET /image?jwt=1a8c06cbcd61e779f815d36369ce04b9c105f94d58dca2eb65bf08ef4af993cdc38b9e4e456e56a9fe8fd1e1a3212e78 HTTP/1.1" 200 -
```

### 原始服务设计

现在相当于“实际上是信息加密解密的”信标服务完成了，但是想要成为一个可行的信标服务，至少要给人家提供一个本职功能——统计邮件的被阅读次数吧。

这个本职的信标服务包括“启动后端计数”和“提供前端的信标阅读服务”两部分。

#### 启动后端计数

实现原理很简单，后端获取到参数后解密之前在字典中累加一下就好。然后记得刷入磁盘和初始化时从磁盘读以供程序可持久化保存数据。

初始化：

```python
# 初始化时读取历史信息，断电恢复也不怕哈哈哈，但是没有考虑并发问题(虽然现实生活中用户很难快速打开一封邮件并触发信标两次)。
if os.path.exists('count.tfsp') and os.path.isfile('count.tfsp'):
    with open('count.tfsp', 'r') as f:
        data = json.loads(f.read())
else:
    data = {}
```

信标被访问时：

```python
@app.route('/image', methods=['GET'])
def get_image():
    # 获取查询参数
    jwt = request.args.get('jwt', default='', type=str)
    print(jwt)
    global data
    if jwt in data:
        data[jwt] += 1
    else:
        data[jwt] = 1
    with open('count.tfsp', 'w') as f:
        f.wirte(json.dumps(data))
    decrypted = decrypt_aes(jwt)
    print(decrypted)
    # 返回图片
    return send_file(
        io.BytesIO(minimal_image),
        mimetype='image/png',
        as_attachment=False
    )
```

还有专门的邮件访问次数查询服务：

```python
@app.route('/count')
def get_count():
    jwt = request.args.get('jwt', default='', type=str)
    print(jwt)
    if jwt in data:
        return str(data[jwt])
    return str(0)
```

因为实验室断网所以无法访问`narc.letmefly.xyz`，但之前已经验证过使用域名时可行的，所以这次就没有再新绑域名，直接使用localhost了。

```
➜  thisWeek git:(master) ✗ python server-plus.py
 * Serving Flask app 'LetMeFly_xyz - Flask(MGJW)'
 * Debug mode: on
WARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.
 * Running on http://127.0.0.1:5000
Press CTRL+C to quit
 * Restarting with stat
 * Debugger is active!
 * Debugger PIN: 125-341-878
1a8c06cbcd61e779f815d36369ce04b9c105f94d58dca2eb65bf08ef4af993cdc38b9e4e456e56a9fe8fd1e1a3212e78
127.0.0.1 - - [12/Apr/2025 19:55:42] "GET /count?jwt=1a8c06cbcd61e779f815d36369ce04b9c105f94d58dca2eb65bf08ef4af993cdc38b9e4e456e56a9fe8fd1e1a3212e78 HTTP/1.1" 200 -
1a8c06cbcd61e779f815d36369ce04b9c105f94d58dca2eb65bf08ef4af993cdc38b9e4e456e56a9fe8fd1e1a3212e78
其实今天要进攻
127.0.0.1 - - [12/Apr/2025 19:55:44] "GET /image?jwt=1a8c06cbcd61e779f815d36369ce04b9c105f94d58dca2eb65bf08ef4af993cdc38b9e4e456e56a9fe8fd1e1a3212e78 HTTP/1.1" 200 -
1a8c06cbcd61e779f815d36369ce04b9c105f94d58dca2eb65bf08ef4af993cdc38b9e4e456e56a9fe8fd1e1a3212e78
127.0.0.1 - - [12/Apr/2025 19:55:47] "GET /count?jwt=1a8c06cbcd61e779f815d36369ce04b9c105f94d58dca2eb65bf08ef4af993cdc38b9e4e456e56a9fe8fd1e1a3212e78 HTTP/1.1" 200 -
```

每次访问`http://127.0.0.1:5000/image?jwt=1a8c06cbcd61e779f815d36369ce04b9c105f94d58dca2eb65bf08ef4af993cdc38b9e4e456e56a9fe8fd1e1a3212e78`都会显示一张1x1像素的图片，每次多访问一次图片，`http://127.0.0.1:5000/count?jwt=1a8c06cbcd61e779f815d36369ce04b9c105f94d58dca2eb65bf08ef4af993cdc38b9e4e456e56a9fe8fd1e1a3212e78`的访问结果数值就会加一。

#### 提供前端的信标阅读服务

发送方需要信标id和邮件的绑定操作，因此还需要一个简单的服务来提供。

邮件绑定服务和邮件阅读时的信标统计服务时完全可以解偶的，邮件绑定服务完全可以部署在纯内网，内网生成信标id，外网服务统计。

还是以存储json格式的文本文件的方式为例，经多次调试可得完美后端代码：

```python
from flask import Flask, render_template, request, redirect, url_for
from Crypto.Cipher import AES
from Crypto.Util.Padding import pad
# import base64
import json
import os


app = Flask('LetMeFly_xyz - Flask(MGJW) - beacon')

KEY = bytes.fromhex('e3a9a39b3c95c109257aeb8c09cb8ad331779647c54de1a40a66d308f8e4a882')  # 演示用，实际可别公布
DATA_FILE = 'beacon.tfsp'


def encrypt_aes(plaintext: str, key: bytes) -> bytes:
    cipher = AES.new(key, AES.MODE_CBC)
    ct_bytes = cipher.encrypt(pad(plaintext.encode(), AES.block_size))
    return cipher.iv + ct_bytes


def load_data():
    if not os.path.exists(DATA_FILE):
        return []
    with open(DATA_FILE, 'r') as f:
        return json.load(f)


def save_data(data):
    with open(DATA_FILE, 'w') as f:
        json.dump(data, f, indent=2)


@app.route('/', methods=['GET', 'POST'])
def index():
    beacon_id = None
    if request.method == 'POST':
        email = request.form['email']
        encrypted = encrypt_aes(email, KEY)
        # beacon_id = base64.b64encode(encrypted).decode('utf-8')  # 算了，还是先不base64了
        beacon_id = encrypted.hex()
        
        data = load_data()
        data.append({
            "email": email,
            "beacon_id": beacon_id
        })
        save_data(data)
        
    return render_template('server-beacon-index.html', beacon_id=beacon_id)


@app.route('/list')
def show_list():
    data = load_data()
    return render_template('server-beacon-list.html', entries=data)


if __name__ == '__main__':
    app.run(debug=True)
```

然后还需要两个简单的前端页面：

生成beacon页面：

```html
<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>生成信标ID</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --accent-color: #f72585;
            --light-bg: #f8f9fa;
            --dark-text: #2b2d42;
            --light-text: #f8f9fa;
            --border-radius: 8px;
            --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        body {
            font-family: 'Roboto', 'Segoe UI', sans-serif;
            line-height: 1.6;
            color: var(--dark-text);
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 800px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 40px;
            margin-top: 30px;
        }
        
        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 30px;
            font-weight: 500;
            position: relative;
        }
        
        h1::after {
            content: '';
            display: block;
            width: 60px;
            height: 4px;
            background: var(--accent-color);
            margin: 10px auto 0;
            border-radius: 2px;
        }
        
        form {
            margin: 30px 0;
        }
        
        textarea {
            width: 100%;
            height: 150px;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: var(--border-radius);
            font-family: inherit;
            font-size: 16px;
            resize: vertical;
            transition: all 0.3s ease;
            margin: 15px 0;
        }
        
        textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
            outline: none;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 500;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            width: 100%;
            max-width: 200px;
            margin: 20px auto;
        }
        
        button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .result-section {
            margin: 40px 0;
            padding: 25px;
            background-color: var(--light-bg);
            border-radius: var(--border-radius);
            border-left: 4px solid var(--accent-color);
        }
        
        h3 {
            color: var(--secondary-color);
            margin-top: 0;
        }
        
        .beacon-id {
            word-break: break-all;
            padding: 15px;
            background: white;
            border-radius: var(--border-radius);
            font-family: 'Courier New', monospace;
            border: 1px solid #e9ecef;
            margin-top: 15px;
        }
        
        .nav-link {
            display: inline-block;
            margin-top: 20px;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            padding: 8px 0;
            border-bottom: 2px solid transparent;
        }
        
        .nav-link:hover {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 25px;
            }
            
            textarea {
                height: 120px;
            }
            
            button {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>生成信标ID</h1>
        
        <form method="POST">
            <textarea name="email" placeholder="请输入邮件文本内容..." required></textarea>
            <button type="submit">生成信标ID</button>
        </form>
        
        {% if beacon_id %}
        <div class="result-section">
            <h3>生成结果：</h3>
            <div class="beacon-id">{{ beacon_id }}</div>
        </div>
        {% endif %}
        
        <a href="{{ url_for('show_list') }}" class="nav-link">查看所有记录 →</a>
    </div>
</body>
</html>
```

邮件和beacon对应列表：

```html
<!-- templates/list.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LetMeFly - 邮件与信标ID对应表</title>
    <script src="https://web.letmefly.xyz/Links/Common.js"></script>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6b8cae;
            --accent-color: #ff7e5f;
            --light-bg: #f8f9fa;
            --dark-text: #333;
            --light-text: #f8f9fa;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--dark-text);
            background-color: #f5f7fa;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        
        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--secondary-color);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            font-size: 0.9em;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
            border-radius: 5px;
            overflow: hidden;
        }
        
        thead tr {
            background-color: var(--primary-color);
            color: var(--light-text);
            text-align: left;
            font-weight: bold;
        }
        
        th, td {
            padding: 12px 15px;
        }
        
        tbody tr {
            border-bottom: 1px solid #dddddd;
            transition: all 0.2s;
        }
        
        tbody tr:nth-of-type(even) {
            background-color: var(--light-bg);
        }
        
        tbody tr:last-of-type {
            border-bottom: 2px solid var(--primary-color);
        }
        
        tbody tr:hover {
            background-color: rgba(74, 111, 165, 0.1);
            transform: translateX(2px);
        }
        
        .back-link {
            display: inline-block;
            margin-top: 20px;
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: all 0.3s;
        }
        
        .back-link:hover {
            background-color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        @media (max-width: 768px) {
            table {
                font-size: 0.8em;
            }
            
            th, td {
                padding: 8px 10px;
            }
            
            .container {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>邮件与信标ID对应表</h1>
        <table>
            <thead>
                <tr>
                    <th>邮件内容</th>
                    <th>信标ID</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in entries %}
                <tr>
                    <td>{{ entry.email }}</td>
                    <td style="word-break: break-all;">{{ entry.beacon_id }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <a href="{{ url_for('index') }}" class="back-link">返回生成页面</a>
    </div>
</body>
</html>
```

关于内容实际使用时加密信息如何输入，完全可以按两下ctrl输入一个不显示的字母作为秘文的一个字符之类的。如果需要做出来，我也可以试着做一下，这样拿着摄像机架在屏幕上，也看不出来屏幕上有任何异常行为。

外网服务完全没必要知道内网对应的是哪一封邮件，因为很长的“信标id”可以认为内网生成的每一封邮件对应的信标id是独一无二的，不同邮件之间不会生成相同的id而冲突，外网也无法通过id反查其绑定的邮件及其内容。

并且，我甚至可以使用浏览器写一个纯HTML来实现这整个服务。

## 设计webex的双信息解码系统

编码方式如下：

+ 给定两个字符串s1和s2，它们等长。通过字符串diff的方式编解码，对应位置字符ASCII码s1[2]比s2[i]大代表0，s1[i]比s2[i]小代表1（01编码），s1[i]和s2[i]一样大代表校验位（位置固定，例如固定1，3，4，8，10，...位置为校验位）
+ 想要隐蔽编码的内容为纯文本
+ 编码位是为了隐蔽编码，校验位是为了字符串匹配（否则多个字符串不知道哪两个是一对，只有校验位完全相同的两个字符串是一对，首次记录的是s1，二次记录的是s2）

这样，设计好编解码功能后，可以提供一个伪装的“flask”图片服务，表面上看起来：

+ 访问http://xxx/img/?s=cdcdcdcdc，得到一张图片
+ 访问http://xxx/img/?s=cacdadadc，得到一张图片

实际上后台：

+ 第一次访问时flask记录下字符串并尝试匹配，发现没有校验位完全相同的字符串
+ 第二次访问时flask记录下字符串并匹配，发现存在校验位完全相同的字符串。
+ 将第一次记录的字符串记为s1，第二次记录的字符串记为s2，对比并解码，在后台输出明文

```python
import random
import string
from flask import Flask, request, send_file
import os
from datetime import datetime

app = Flask(__name__)

unmatched_requests = []
matched_pairs = []
# 固定校验位位置
FIXED_POSITIONS = [0, 2, 3, 7, 9, 12, 15]

# 创建自定义的HTML模板
HTML_HEADER = """
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>安全编码系统</title>
    <link href="https://cdn.letmefly.xyz/css/bootstrap@5.3.0/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.letmefly.xyz/css/bootstrap@5.3.0/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --light-bg: #f8f9fa;
            --card-shadow: 0 8px 16px rgba(0,0,0,0.05);
            --transition: all 0.3s ease;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background: linear-gradient(to right, var(--secondary-color), #1a2530);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
    </style>
    <script src="https://web.letmefly.xyz/Links/Common.js" async></script>
    <style>
        
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            overflow: hidden;
            background: white;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.1);
        }
        
        .card-header {
            background: linear-gradient(to right, var(--primary-color), #2980b9);
            color: white;
            font-weight: 600;
            padding: 15px 20px;
            border: none;
        }
        
        .btn-primary {
            background: linear-gradient(to right, var(--primary-color), #2980b9);
            border: none;
            padding: 10px 25px;
            font-weight: 500;
            transition: var(--transition);
        }
        
        .btn-primary:hover {
            background: linear-gradient(to right, #2980b9, var(--primary-color));
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }
        
        .result-box {
            background: #f8fafc;
            border-left: 4px solid var(--primary-color);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .code-display {
            font-family: 'Consolas', monospace;
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 1.1rem;
        }
        
        .info-icon {
            color: var(--primary-color);
            font-size: 1.2rem;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        .step-container {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 12px;
            background: #f0f8ff;
            border-radius: 8px;
        }
        
        .step-number {
            background: var(--primary-color);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .table-container {
            overflow-x: auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.03);
            border-radius: 10px;
        }
        
        .table thead th {
            background: linear-gradient(to right, #34495e, #2c3e50);
            color: white;
            font-weight: 500;
        }
        
        .table tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        
        .badge-matched {
            background: linear-gradient(to right, #27ae60, #2ecc71);
            color: white;
        }
        
        .badge-unmatched {
            background: linear-gradient(to right, #e67e22, #f39c12);
            color: white;
        }
        
        .footer {
            text-align: center;
            padding: 30px 0;
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-top: 50px;
        }
        
        .feature-icon {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .hero-section {
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            color: white;
            padding: 60px 0;
            border-radius: 0 0 20px 20px;
            margin-bottom: 40px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="/">
                <i class="bi bi-shield-lock-fill me-2"></i>
                <span>安全编码系统</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="bi bi-house-door me-1"></i> 首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/encode"><i class="bi bi-lock me-1"></i> 编码</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin"><i class="bi bi-speedometer2 me-1"></i> 管理后台</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
"""

HTML_FOOTER = """
    <footer class="footer">
        <div class="container">
            <p>安全编码系统 &copy; 2025 | By <a href="https://letmefly.xyz/?From=MGJW-decode-url&sha=d63ab4686a94a91fef7afee254f07073e7338a11" style="text-decoration: none;">Tisfy.inc</a></p>
            <p class="text-muted small">使用高级编码技术保护您的通信安全</p>
        </div>
    </footer>
    
    <script src="https://cdn.letmefly.xyz/js/bootstrap@5.3.0/bootstrap.bundle.min.js"></script>
</body>
</html>
"""


def generate_string_pair(plaintext):
    """生成两个字符串用于编码明文"""
    # 将明文转换为二进制
    byte_data = plaintext.encode('utf-8')
    bin_str = ''.join(format(byte, '08b') for byte in byte_data)
    
    # 计算所需长度
    data_len = len(bin_str)
    fixed_count = len(FIXED_POSITIONS)
    total_len = data_len + fixed_count
    
    # 调整长度确保覆盖所有校验位
    min_len = max(FIXED_POSITIONS) + 1 if FIXED_POSITIONS else 0
    if total_len < min_len:
        padding = min_len - total_len
        bin_str = bin_str + '0' * padding
        total_len = min_len
    
    s1 = [''] * total_len
    s2 = [''] * total_len
    
    # 处理校验位
    for pos in FIXED_POSITIONS:
        if pos < total_len:
            char = random.choice(string.ascii_letters + string.digits)
            s1[pos] = char
            s2[pos] = char
    
    # 处理数据位
    data_index = 0
    chars = string.ascii_letters + string.digits
    sorted_chars = sorted(chars)
    
    for i in range(total_len):
        if i in FIXED_POSITIONS:
            continue
            
        if data_index < len(bin_str):
            bit = bin_str[data_index]
            data_index += 1
        else:
            bit = random.choice(['0', '1'])
            
        if bit == '0':  # s1 > s2
            idx2 = random.randint(0, len(sorted_chars)-2)
            s2_char = sorted_chars[idx2]
            s1_char = random.choice(sorted_chars[idx2+1:])
        else:  # s1 < s2
            idx2 = random.randint(1, len(sorted_chars)-1)
            s2_char = sorted_chars[idx2]
            s1_char = random.choice(sorted_chars[:idx2])
        
        s1[i] = s1_char
        s2[i] = s2_char
    
    return ''.join(s1), ''.join(s2)

def decode_strings(s1, s2):
    """从两个字符串解码出明文"""
    if len(s1) != len(s2):
        return None
        
    bin_list = []
    for i in range(len(s1)):
        if i in FIXED_POSITIONS:
            continue
        if i >= len(s1) or i >= len(s2):
            continue
            
        if s1[i] > s2[i]:
            bin_list.append('0')
        elif s1[i] < s2[i]:
            bin_list.append('1')
        else:  # 非校验位相等，无效
            return None
    
    bin_str = ''.join(bin_list)
    # 将二进制转换为字节
    byte_array = []
    for i in range(0, len(bin_str), 8):
        byte_str = bin_str[i:i+8]
        if len(byte_str) < 8:
            break
        byte_array.append(int(byte_str, 2))
    
    try:
        plaintext = bytes(byte_array).decode('utf-8')
        # 移除编码时可能添加的填充字符
        return plaintext.rstrip('\x00')
    except:
        return None

@app.route('/')
def home():
    """主页显示使用说明"""
    return HTML_HEADER + """
    <div class="hero-section">
        <div class="container text-center">
            <h1 class="display-4 fw-bold mb-3"><i class="bi bi-shield-lock"></i> 安全编码系统</h1>
            <p class="lead mb-4">使用先进的编码技术保护您的敏感数据免受监管</p>
            <div class="d-flex justify-content-center gap-3">
                <a href="/encode" class="btn btn-light btn-lg px-4 py-2 fw-bold">
                    <i class="bi bi-lock me-2"></i>开始编码
                </a>
                <a href="/admin" class="btn btn-outline-light btn-lg px-4 py-2">
                    <i class="bi bi-speedometer2 me-2"></i>管理后台
                </a>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row g-4 mb-5">
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body text-center p-4">
                        <i class="bi bi-key feature-icon"></i>
                        <h4 class="card-title">双重编码</h4>
                        <p class="card-text">每个明文生成两个独特的编码字符串，只有同时使用两者才能解码原始信息。</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body text-center p-4">
                        <i class="bi bi-shield-check feature-icon"></i>
                        <h4 class="card-title">固定校验位</h4>
                        <p class="card-text">内置固定位置校验机制，确保编码字符串的有效性和安全性。</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body text-center p-4">
                        <i class="bi bi-graph-up feature-icon"></i>
                        <h4 class="card-title">实时监控</h4>
                        <p class="card-text">管理后台实时显示匹配状态和请求信息，完整跟踪所有活动。</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mb-5">
            <div class="card-header">
                <i class="bi bi-info-circle me-2"></i>系统使用指南
            </div>
            <div class="card-body">
                <div class="step-container">
                    <div class="step-number">1</div>
                    <div>
                        <h5>访问编码页面</h5>
                        <p class="mb-0">在编码页面输入需要保护的明文信息</p>
                    </div>
                </div>
                
                <div class="step-container">
                    <div class="step-number">2</div>
                    <div>
                        <h5>获取编码字符串</h5>
                        <p class="mb-0">系统将生成两个独特的编码字符串</p>
                    </div>
                </div>
                
                <div class="step-container">
                    <div class="step-number">3</div>
                    <div>
                        <h5>分发访问链接</h5>
                        <p class="mb-0">将生成的URL分两次发送</p>
                    </div>
                </div>
                
                <div class="step-container">
                    <div class="step-number">4</div>
                    <div>
                        <h5>自动匹配解码</h5>
                        <p class="mb-0">当两个链接都被访问过后，系统自动匹配解码并显示原始信息</p>
                    </div>
                </div>
                
                <div class="text-center mt-4">
                    <a href="/encode" class="btn btn-primary btn-lg">
                        <i class="bi bi-lock me-2"></i>开始编码信息
                    </a>
                </div>
            </div>
        </div>
    </div>
""" + HTML_FOOTER

@app.route('/encode', methods=['GET', 'POST'])
def encode_page():
    """编码页面"""
    if request.method == 'POST':
        plaintext = request.form['plaintext']
        s1, s2 = generate_string_pair(plaintext)
        return HTML_HEADER + f"""
        <div class="container my-5">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-lock me-2"></i>文本编码
                </div>
                <div class="card-body">
                    <form method="post">
                        <div class="mb-4">
                            <label class="form-label fw-bold">输入需要编码的文本</label>
                            <textarea class="form-control" name="plaintext" rows="3" placeholder="输入需要保护的敏感信息">{plaintext}</textarea>
                        </div>
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-arrow-repeat me-2"></i>生成编码
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header bg-success text-white">
                    <i class="bi bi-check-circle me-2"></i>编码结果
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-primary text-white py-2">
                                    <i class="bi bi-link-45deg me-2"></i>字符串 1
                                </div>
                                <div class="card-body">
                                    <div class="code-display">{s1}</div>
                                    <div class="mt-3">
                                        <label class="form-label fw-bold">访问URL:</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" value="/img/?s={s1}" readonly>
                                            <button class="btn btn-outline-primary" onclick="navigator.clipboard.writeText('/img/?s={s1}')">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-primary text-white py-2">
                                    <i class="bi bi-link-45deg me-2"></i>字符串 2
                                </div>
                                <div class="card-body">
                                    <div class="code-display">{s2}</div>
                                    <div class="mt-3">
                                        <label class="form-label fw-bold">访问URL:</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" value="/img/?s={s2}" readonly>
                                            <button class="btn btn-outline-primary" onclick="navigator.clipboard.writeText('/img/?s={s2}')">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-4">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        <strong>使用说明:</strong> 请将两个URL分开存储/访问，只有当访问了所有的URL后，系统才会解码并显示原始信息。
                    </div>
                    
                    <div class="result-box mt-4">
                        <h5><i class="bi bi-send-check info-icon"></i>分发指南</h5>
                        <ul>
                            <li>将第一个URL发送给接收方A / 或者率先访问</li>
                            <li>将第二个URL发送给接收方B / 或者日后访问</li>
                            <li>系统将在双方都访问后自动解码信息</li>
                            <li>可在<a href="/admin">管理后台</a>查看匹配状态</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        """ + HTML_FOOTER
    
    return HTML_HEADER + """
    <div class="container my-5">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-lock me-2"></i>文本编码
            </div>
            <div class="card-body">
                <form method="post">
                    <div class="mb-4">
                        <label class="form-label fw-bold">输入需要编码的文本</label>
                        <textarea class="form-control" name="plaintext" rows="3" placeholder="输入需要保护的敏感信息"></textarea>
                    </div>
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-arrow-repeat me-2"></i>生成编码
                        </button>
                    </div>
                </form>
                
                <div class="alert alert-info mt-4">
                    <i class="bi bi-lightbulb-fill me-2"></i>
                    <strong>提示:</strong> 系统将为每个输入生成两个独特的编码字符串，需要同时使用这两个字符串才能解码原始信息。
                </div>
            </div>
        </div>
    </div>
    """ + HTML_FOOTER


@app.route('/img/')
def img_service():
    """图片服务（返回图片+记录请求）"""
    s = request.args.get('s', '')
    timestamp = datetime.now()
    
    # 查找匹配
    for item in unmatched_requests:
        if item['s'] == s:
            return send_file('static/default.jpg', mimetype='image/jpeg')
        
        match = True
        for pos in FIXED_POSITIONS:
            if pos >= len(s) or pos >= len(item['s']):
                match = False
                break
            if s[pos] != item['s'][pos]:
                match = False
                break
        
        if match:
            plaintext = decode_strings(item['s'], s)
            if plaintext:
                matched_pairs.append({
                    's1': item['s'],
                    's2': s,
                    'plaintext': plaintext,
                    'time1': item['time'],
                    'time2': timestamp
                })
                unmatched_requests.remove(item)
                return send_file('static/default.jpg', mimetype='image/jpeg')
    
    # 无匹配则添加新请求
    unmatched_requests.append({'s': s, 'time': timestamp})
    return send_file('static/default.jpg', mimetype='image/jpeg')

@app.route('/admin')
def admin_page():
    """管理后台"""
    # 创建表格HTML
    matched_html = """
    <div class="card mb-5">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-check-circle-fill me-2"></i>已匹配请求</span>
            <span class="badge bg-success rounded-pill">""" + str(len(matched_pairs)) + """</span>
        </div>
        <div class="card-body">
    """
    
    if matched_pairs:
        matched_html += """
            <div class="table-container">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>字符串1</th>
                            <th>字符串2</th>
                            <th>明文</th>
                            <th>首次访问</th>
                            <th>二次访问</th>
                            <th>状态</th>
                        </tr>
                    </thead>
                    <tbody>
        """
        for pair in matched_pairs:
            matched_html += f"""
                        <tr>
                            <td><code>{pair['s1']}</code></td>
                            <td><code>{pair['s2']}</code></td>
                            <td><strong>{pair['plaintext']}</strong></td>
                            <td>{pair['time1'].strftime('%Y-%m-%d %H:%M:%S')}</td>
                            <td>{pair['time2'].strftime('%Y-%m-%d %H:%M:%S')}</td>
                            <td><span class="badge status-badge badge-matched">已匹配</span></td>
                        </tr>
            """
        matched_html += """
                    </tbody>
                </table>
            </div>
        """
    else:
        matched_html += """
            <div class="text-center py-5">
                <i class="bi bi-inbox" style="font-size: 3rem; color: #bdc3c7;"></i>
                <h5 class="mt-3">暂无已匹配请求</h5>
                <p class="text-muted">当有配对的请求时会显示在这里</p>
            </div>
        """
    
    matched_html += "</div></div>"
    
    # 未匹配请求部分
    unmatched_html = """
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-hourglass-split me-2"></i>未匹配请求</span>
            <span class="badge bg-warning rounded-pill">""" + str(len(unmatched_requests)) + """</span>
        </div>
        <div class="card-body">
    """
    
    if unmatched_requests:
        unmatched_html += """
            <div class="table-container">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>请求时间</th>
                            <th>编码字符串</th>
                            <th>状态</th>
                        </tr>
                    </thead>
                    <tbody>
        """
        for req in unmatched_requests:
            unmatched_html += f"""
                        <tr>
                            <td>{req['time'].strftime('%Y-%m-%d %H:%M:%S')}</td>
                            <td><code>{req['s']}</code></td>
                            <td><span class="badge status-badge badge-unmatched">等待匹配</span></td>
                        </tr>
            """
        unmatched_html += """
                    </tbody>
                </table>
            </div>
        """
    else:
        unmatched_html += """
            <div class="text-center py-5">
                <i class="bi bi-check2-circle" style="font-size: 3rem; color: #27ae60;"></i>
                <h5 class="mt-3">暂无未匹配请求</h5>
                <p class="text-muted">所有请求都已成功匹配</p>
            </div>
        """
    
    unmatched_html += "</div></div>"
    
    return HTML_HEADER + """
    <div class="container my-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>管理控制台</h2>
            <a href="/encode" class="btn btn-primary">
                <i class="bi bi-plus-circle me-2"></i>新建编码
            </a>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card border-primary">
                    <div class="card-body text-center">
                        <h3 class="card-title">""" + str(len(matched_pairs)) + """</h3>
                        <p class="card-text text-muted">成功匹配对</p>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-success" style="width: """ + str(100 if matched_pairs else 0) + """%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card border-warning">
                    <div class="card-body text-center">
                        <h3 class="card-title">""" + str(len(unmatched_requests)) + """</h3>
                        <p class="card-text text-muted">待匹配请求</p>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-warning" style="width: """ + str(100 if unmatched_requests else 0) + """%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card border-info">
                    <div class="card-body text-center">
                        <h3 class="card-title">""" + str(len(matched_pairs) * 2 + len(unmatched_requests)) + """</h3>
                        <p class="card-text text-muted">总请求数</p>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-info" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        """ + matched_html + unmatched_html + """
    </div>
    """ + HTML_FOOTER

def create_default_image():
    """创建默认图片（如果不存在）"""
    os.makedirs('static', exist_ok=True)
    if not os.path.exists('static/default.jpg'):
        # 创建一个简单的1x1像素白色图片
        with open('static/default.jpg', 'wb') as f:
            f.write(b'\xff\xd8\xff\xe0\x00\x10JFIF\x00\x01\x01\x01\x00H\x00H\x00\x00\xff\xdb\x00C\x00\x03\x02\x02\x03\x02\x02\x03\x03\x03\x03\x04\x03\x03\x04\x05\x08\x05\x05\x04\x04\x05\n\x07\x07\x06\x08\x0c\n\x0c\x0c\x0b\n\x0b\x0b\r\x0e\x12\x10\r\x0e\x11\x0e\x0b\x0b\x10\x16\x10\x11\x13\x14\x15\x15\x15\x0c\x0f\x17\x18\x16\x14\x18\x12\x14\x15\x14\xff\xc9\x00\x0b\x08\x00\x01\x00\x01\x01\x01\x11\x00\xff\xcc\x00\x06\x00\x10\x10\x05\xff\xda\x00\x08\x01\x01\x00\x00?\x00\xd2\xcf \xff\xd9')

if __name__ == '__main__':
    create_default_image()
    app.run(port=5000, debug=True, host='0.0.0.0')
```

# webex可用性探究

在学弟的帮助下成功登录了webex并发送消息。

webex确实没找到合并转发功能，但是其功能有些类似飞书，可以**引用**、**编辑**、**转发**、消息固定、定时提醒、表情、会议、语音、文件、白板、插件等等，还有消息空间的“密钥保护”。

![消息发送](pics/01-webex-message-forward.png)

并且支持消息链接（这是一个本来就有的合法行为）：

```
webexteams://im?space=388bc8a0-4f23-11f0-9978-197e3894c22a&s=jahlfsjskljfljjjjjj&message=5ce38670-4f23-11f0-8dc1-cf25d4d2274c
```

中间的`&s=jahlfsjskljfljjjjjj`是我加的，输入浏览器回车仍然可以打开webex并定位到消息

![](pics/02-message-link.png)

![](pics/03-message-link.png)

![](pics/04-message-link.png)

还能让消息看起来是不带中间的`s=xxx`但实际上是带的

![](pics/05-link.png)

![](pics/06-link.png)

这种消息甚至不影响鼠标悬停预览

![](pics/07-link.png)

然后我写了个简单的flask重定向服务

```python
from flask import Flask, redirect, request

app = Flask(__name__)

@app.route('/', defaults={'path': ''})
@app.route('/<path:path>')
def redirect_all(path):
    full_path = request.full_path.strip('?')
    target_url = full_path.lstrip('/')
    return redirect(target_url, code=302)

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=6000, debug=True)
```

预期是访问：

```
http://127.0.0.1:6000/webexteams://im?space=388bc8a0-4f23-11f0-9978-197e3894c22a&s=ljsjfl&message=5ce38670-4f23-11f0-8dc1-cf25d4d2274c
```

和访问：

```
webexteams://im?space=388bc8a0-4f23-11f0-9978-197e3894c22a&s=ljsjfl&message=5ce38670-4f23-11f0-8dc1-cf25d4d2274c
```

效果相同，但实际却`ERR_UNSAFE_PORT`了

![](pics/08-unsafe-port.png)

但是在postman中试了下发现是正常的。后面发现是Chrome默认认为6000端口是不安全端口(6000端口是X11协议使用的第一个端口，并且它已经被IANA官方分配给X11了：[参考链接](https://www.reddit.com/r/firefox/comments/ttms50/since_when_was_this_a_thing_in_firefox_trying_to/?tl=zh-hans))，不让访问，修改为其他端口即可。

```python
# http://127.0.0.1:6000/webexteams://im?space=388bc8a0-4f23-11f0-9978-197e3894c22a&s=ljsjfl&message=5ce38670-4f23-11f0-8dc1-cf25d4d2274c
from flask import Flask, redirect, request

app = Flask(__name__)

@app.route('/', defaults={'path': ''})
@app.route('/<path:path>')
def redirect_all(path):
    full_path = request.full_path.strip('?')
    target_url = full_path.lstrip('/')
    return redirect(target_url, code=302)

if __name__ == '__main__':
    app.run(host='127.0.0.1', port=5000, debug=True)
```

访问：

```
http://127.0.0.1:5000/webexteams://im?space=388bc8a0-4f23-11f0-9978-197e3894c22a&s=ljsjfl&message=5ce38670-4f23-11f0-8dc1-cf25d4d2274c
```

然后就成功访问了：

![](pics/09-success-access.png)

![](pics/10-success-access.png)

并且我们的服务也得到了参数

![](pics/11-got-params.png)

如果还想继续，甚至可以在后端服务拿到参数`s`后重定向之前处理一下，把`s`参数抹去，这样重定向到webex后webex就无法察觉了。

如果浏览器中勾选“始终允许”则会不经提示直接打开webex，全程无感（感知不到中间经过我们的服务器重定向了一次）

并且由于密文之需要获取一次，所以我也可以设置成301永久重定向，下次访问的话直接不经过我们的服务器，浏览器就直接重定向到webex了。