<!--
 * @Author: LetMeFly
 * @Date: 2025-02-21 16:54:45
 * @LastEditors: LetMeFly.xyz
 * @LastEditTime: 2025-02-21 21:44:07
-->
# Windows通过SSH远程执行带UI程序的实现

假设：能在目标主机上执行一些远程命令

发现：shell模式下启动的程序无法显示图形界面

下阶段：

1. 如何体现**被动**：使用第三方服务器，目标主机上植入木马，定期与第三方服务器通信。
2. 如何避免“仅在shell模式下执行”：

## Windows开启ssh登录

如果想要能够通过命令行执行一些操作，那么能开启ssh访问的话还是很方便的。

考虑到实际上很多主机的系统可能为Windows而非Linux，因此尝试在Windows上开启ssh并尝试登录。

Windows支持OpenSSH，直接在“Windows设置–>应用–>应用和功能-可选功能”安装就好。

![openOpenSSH](openOpenSSH.jpg)

但是安装过程十分缓慢。

## 登录失败

但是无论如何都不能登录成功。

安全组也尝试过、防火墙也临时关闭过、策略组也修改过，但都是不行。

账号密码输入的似乎没问题啊，但总是登录失败。

```bash
ssh LetMeFly@narc.letmefly.xyz
LetMeFly@narc.letmefly.xyz's password:
Permission denied, please try again.
LetMeFly@narc.letmefly.xyz's password:
```

后面一想，使用Windows自带的远程桌面的时候，似乎输入的是微软账户的账号和密码，所以就尝试着用微软账号密码登录了一下，然后就成功了！！！

```bash
C:\Users\LetMe>ssh 121112122@qq.com@narc.letmefly.xyz
121112122@qq.com@narc.letmefly.xyz's password:
Microsoft Windows [版本 10.0.19044.5371]
(c) Microsoft Corporation。保留所有权利。

letmefly@LETMEFLY-NARC C:\Users\LetMeFly>
```

并且显示的用户竟然还是用户名而不是微软账号。

## 设置服务类型为自启动

重启电脑后又无法连接了，每次输入命令后都是等待很久显示连接失败，猜测是由于相关服务非“开机自启”。

于是在服务列表里找到了一个相关的服务，启动，发现可以通过ssh登录了。

![openService](openService.png)

之后将其设置为了“自动（延时启动）”，在开机自启的同时不那么拖慢开机速度。

如果不想设置为开机自启的话，每次**管理员权限**执行`net start sshd`也可以。

![sshd](sshd.png)

但是每次手动开启服务仅限于模拟，实际上肯定没法保证能每次在目标主机上执行这条命令，所以实际操作时还是设置为“开机自启”比较好。

## 启动的程序无界面

之前写过一个“爱心小程序”并添加到了环境变量中，只要在命令行中输入`爱心`就能显示爱心，在命令行中输入`start 爱心`就会弹出一个独立的窗口并显示爱心。

![爱心](heart.png)

在ssh终端中输入`爱心`命令发现确实能运行目标主机环境变量中的程序（虽然终端样式有点怪异，和纯在目标主机上运行略有不同（例如小黑框右边滚动条等）。

![ssh中的爱心](heart-ssh.png)

但是这时候问题出现了，我使用命令`start 爱心`的时候，直接在主机上执行的话，是可以弹出新窗口并显示爱心的。

但是我在远程的ssh中执行，既没有在远程主机上弹出新窗口，又没有在远程主机上弹出新窗口。

没有在远程主机上弹出新窗口是理所应当的，要是弹出了就怪了。

但是，界面去哪里了呢？两边终端、界面上都没有出现。

使用`tasklist`命令查看：

```
taskhostw.exe                17412 RDP-Tcp#80                 1     32,920 K
HelpPane.exe                 18084 RDP-Tcp#80                 1     28,896 K
svchost.exe                  17716 RDP-Tcp#80                 1     11,740 K
EXCEL.EXE                    17872 RDP-Tcp#80                 1    102,464 K
svchost.exe                  13512 Services                   0      9,100 K
rundll32.exe                 14292 RDP-Tcp#80                 1     10,916 K
TextInputHost.exe            17536 RDP-Tcp#80                 1     85,276 K
svchost.exe                  18416 Services                   0      9,140 K
svchost.exe                  20304 Services                   0      9,868 K
splwow64.exe                 22344 RDP-Tcp#80                 1     19,056 K
svchost.exe                  21308 Services                   0     10,204 K
svchost.exe                  19508 Services                   0     12,400 K
dllhost.exe                  24444 RDP-Tcp#80                 1     23,164 K
RuntimeBroker.exe            22356 RDP-Tcp#80                 1     24,580 K
LockApp.exe                   4864 RDP-Tcp#80                 1     17,528 K
RuntimeBroker.exe            13832 RDP-Tcp#80                 1     33,444 K
rdpclip.exe                  16328 RDP-Tcp#80                 1     24,720 K
ctfmon.exe                   22024 RDP-Tcp#80                 1     64,468 K
TabTip.exe                   26092 RDP-Tcp#80                 1     18,780 K
csrss.exe                    16912 Console                    4      5,296 K
winlogon.exe                  4032 Console                    4      9,520 K
fontdrvhost.exe              19948 Console                    4      4,632 K
LogonUI.exe                  23764 Console                    4     65,124 K
dwm.exe                      24244 Console                    4     19,372 K
ChsIME.exe                     320 Console                    4      8,476 K
Code.exe                     19112 RDP-Tcp#80                 1     87,384 K
Code.exe                      3228 RDP-Tcp#80                 1     28,472 K
Code.exe                     14532 RDP-Tcp#80                 1     57,204 K
Code.exe                     23924 RDP-Tcp#80                 1     26,956 K
Code.exe                     13868 RDP-Tcp#80                 1    229,032 K
Code.exe                     26436 RDP-Tcp#80                 1     33,284 K
Code.exe                      8892 RDP-Tcp#80                 1     63,748 K
Feishu.exe                   21220 RDP-Tcp#80                 1    154,504 K
Feishu.exe                   16064 RDP-Tcp#80                 1     24,916 K
Feishu.exe                   16292 RDP-Tcp#80                 1     51,424 K
Feishu.exe                    8204 RDP-Tcp#80                 1     21,884 K
Feishu.exe                   22644 RDP-Tcp#80                 1    199,312 K
Feishu.exe                   13232 RDP-Tcp#80                 1     76,008 K
svchost.exe                  24412 Services                   0     11,276 K
svchost.exe                  16152 Services                   0     13,528 K
vmmem                        17196 Services                   0         暂缺
taskhostw.exe                24424 RDP-Tcp#80                 1     22,720 K
SearchApp.exe                15180 RDP-Tcp#80                 1    107,380 K
RuntimeBroker.exe             7616 RDP-Tcp#80                 1     25,572 K
Microsoft.ServiceHub.Cont    18484 RDP-Tcp#80                 1     52,708 K
ServiceHub.IdentityHost.e    11260 RDP-Tcp#80                 1     55,532 K
conhost.exe                  13380 Services                   0      1,396 K
bash.exe                     29012 Services                   0        628 K
MpDefenderCoreService.exe    10912 Services                   0     21,596 K
MsMpEng.exe                   7108 Services                   0    348,852 K
NisSrv.exe                   18840 Services                   0     46,496 K
chrome.exe                   27740 RDP-Tcp#80                 1    254,932 K
chrome.exe                   12356 RDP-Tcp#80                 1     10,848 K
chrome.exe                   27304 RDP-Tcp#80                 1    105,660 K
chrome.exe                   25388 RDP-Tcp#80                 1     54,452 K
chrome.exe                   14140 RDP-Tcp#80                 1     19,976 K
Feishu.exe                   27248 RDP-Tcp#80                 1    283,096 K
Feishu.exe                   10264 RDP-Tcp#80                 1     40,024 K
Feishu.exe                   21344 RDP-Tcp#80                 1     40,012 K
chrome.exe                   13024 RDP-Tcp#80                 1     23,188 K
chrome.exe                    8056 RDP-Tcp#80                 1     36,612 K
WeChat.exe                   11160 RDP-Tcp#80                 1    313,304 K
mmcrashpad_handler64.exe      9616 RDP-Tcp#80                 1      8,712 K
WeChatAppEx.exe              27132 RDP-Tcp#80                 1    108,332 K
WeChatAppEx.exe              23416 RDP-Tcp#80                 1     21,080 K
WeChatAppEx.exe              29456 RDP-Tcp#80                 1     44,816 K
WeChatAppEx.exe               5344 RDP-Tcp#80                 1    107,348 K
WeChatPlayer.exe              1224 RDP-Tcp#80                 1     17,628 K
WeChatUtility.exe            18720 RDP-Tcp#80                 1     30,548 K
WeChatOCR.exe                11388 RDP-Tcp#80                 1     34,816 K
WeChatAppEx.exe              10128 RDP-Tcp#80                 1    126,292 K
WeChatAppEx.exe              25180 RDP-Tcp#80                 1     48,036 K
WeChatAppEx.exe              27320 RDP-Tcp#80                 1     68,196 K
Code.exe                     29644 RDP-Tcp#80                 1    101,544 K
Code.exe                     12808 RDP-Tcp#80                 1     80,480 K
conhost.exe                  11012 RDP-Tcp#80                 1      6,684 K
powershell.exe                9592 RDP-Tcp#80                 1     51,840 K
conhost.exe                   3884 RDP-Tcp#80                 1      6,680 K
powershell.exe               18780 RDP-Tcp#80                 1     51,600 K
conhost.exe                  21612 RDP-Tcp#80                 1      6,676 K
powershell.exe               28332 RDP-Tcp#80                 1     51,724 K
conhost.exe                   5948 RDP-Tcp#80                 1      6,684 K
powershell.exe                3500 RDP-Tcp#80                 1     51,588 K
cpptools.exe                 27376 RDP-Tcp#80                 1     10,444 K
conhost.exe                  12940 RDP-Tcp#80                 1      6,276 K
Code.exe                     18056 RDP-Tcp#80                 1     83,148 K
Code.exe                      5924 RDP-Tcp#80                 1     81,304 K
cpptools.exe                 16928 RDP-Tcp#80                 1      3,632 K
Taskmgr.exe                   9024 RDP-Tcp#80                 1     68,412 K
svchost.exe                  29092 Services                   0      7,756 K
svchost.exe                  12948 Services                   0      7,512 K
Code.exe                     27360 RDP-Tcp#80                 1     81,540 K
PhotosService.exe              528 RDP-Tcp#80                 1     21,760 K
PhotosService.exe            18608 RDP-Tcp#80                 1     21,748 K
PhotosService.exe            20028 RDP-Tcp#80                 1     21,780 K
PhotosService.exe             6044 RDP-Tcp#80                 1     21,800 K
PhotosService.exe            23992 RDP-Tcp#80                 1     21,752 K
PhotosService.exe            14040 RDP-Tcp#80                 1     21,740 K
PhotosService.exe            27088 RDP-Tcp#80                 1     21,752 K
PhotosService.exe             8596 RDP-Tcp#80                 1     21,784 K
PhotosService.exe            22616 RDP-Tcp#80                 1     21,776 K
PhotosApp.exe                13096 RDP-Tcp#80                 1     55,704 K
PhotosService.exe            28956 RDP-Tcp#80                 1     21,776 K
WeChatAppEx.exe              18664 RDP-Tcp#80                 1    131,408 K
svchost.exe                  20512 Services                   0      7,024 K
WUDFHost.exe                 16048 Services                   0     34,356 K
audiodg.exe                  17124 Services                   0     15,880 K
chrome.exe                    3160 RDP-Tcp#80                 1     70,828 K
chrome.exe                   15700 RDP-Tcp#80                 1     68,000 K
chrome.exe                   22288 RDP-Tcp#80                 1     45,752 K
chrome.exe                    2684 RDP-Tcp#80                 1     24,316 K
python.exe                   23256 RDP-Tcp#80                 1     28,552 K
python.exe                   25136 RDP-Tcp#80                 1     29,804 K
TrustedInstaller.exe          9524 Services                   0      8,452 K
TiWorker.exe                 18016 Services                   0     22,056 K
SystemSettingsAdminFlows.     1072 RDP-Tcp#80                 1     12,552 K
WeChatAppEx.exe               8976 RDP-Tcp#80                 1     98,960 K
mmc.exe                      21684 RDP-Tcp#80                 1     52,456 K
sshd.exe                     12256 Services                   0      9,376 K
sshd.exe                     27128 Services                   0      9,648 K
conhost.exe                  26772 Services                   0      6,840 K
cmd.exe                      16420 Services                   0      5,472 K
svchost.exe                  15100 Services                   0     25,736 K
爱心.exe                     25516 Services                   0      5,404 K
conhost.exe                   4508 Services                   0     12,612 K
WmiPrvSE.exe                  6056 Services                   0     12,968 K
tasklist.exe                  6156 Services                   0     10,020 K
...
```

发现其实这个程序是有在后台执行的，只是没有界面而已。

目前看来**这个特性可以说有利有弊吧：**

1. 好处是目标主机完全不会发掘还有执行了这么个命令。
2. 坏处是这远程执行的程序完全么。

猜想：难道`爱心`进程是由远程`ssh`所`start`的，所以爱心进程是`ssh`进程的子进程，所以会像`Chrome`那样嵌套起来？

![chrome](chrome.png)

于是在目标主机上查看任务管理器，发现并非如此

![似乎不是子进程](heart-not-child.png)

但是我尝试退出了`ssh`登录，发现任务管理器中的`爱心`进程随之消失。

```
svchost.exe                  15100 Services                   0     25,736 K
爱心.exe                     25516 Services                   0      5,404 K
conhost.exe                   4508 Services                   0     12,612 K
WmiPrvSE.exe                  6056 Services                   0     12,968 K
tasklist.exe                  6156 Services                   0     10,020 K

letmefly@LETMEFLY-NARC C:\Users\LetMeFly\Desktop>exit
Connection to narc.letmefly.xyz closed.
```

问了问DeepSeek：

> ssh连接到Windows主机，使用start命令启动程序，发现无法显示程序界面，但是在tasklist中发现后台有此程序。

DeepSeek说：

> 在 Windows 系统中通过 SSH 启动 GUI 程序时无法显示界面，通常是因为 SSH 会话与图形界面会话隔离导致的。
> 
> SSH 连接默认运行在 非交互式控制台会话（通常为 Session 0），而图形界面程序需要运行在用户的 交互式桌面会话（如 Session 1）。

DeepSeek还给出了下面命令，还没敢试：

```batch
for /f "tokens=3" %i in ('query session ^| findstr "Active"') do set SESSIONID=%i
tscon %SESSIONID% /dest:console
```

于是想着能否以“计划任务”的方式启动，这样是不是就会有界面了

```batch
schtasks /create /tn "tempStartAiXin" /sc ONCE /tr "cmd /c start 爱心.exe" /ru %USERNAME% /st 00:00
schtasks /run /tn "tempStartAiXin"
schtasks /delete /tn "tempStartAiXin" /f
```

```batch
letmefly@LETMEFLY-NARC C:\Users\LetMeFly>schtasks /create /tn "tempStartAiXin" /
sc ONCE /tr "cmd /c start 爱心.exe" /ru %USERNAME% /st 00:00
警告: 因为 /ST 早于当前的时间，任务可能无法运行。
成功: 成功创建计划任务 "tempStartAiXin"。

letmefly@LETMEFLY-NARC C:\Users\LetMeFly>schtasks /run /tn "tempStartAiXin"
成功: 尝试运行 "tempStartAiXin"。

letmefly@LETMEFLY-NARC C:\Users\LetMeFly>schtasks /delete /tn "tempStartAiXin" /
f
成功: 计划的任务 "tempStartAiXin" 被成功删除。

letmefly@LETMEFLY-NARC C:\Users\LetMeFly>
```

远程主机上的爱心界面出现了！！！

![成功](heart-success.png)

故写[博文](https://blog.letmefly.xyz/2025/02/21/Other-Windows-OpenUIbySSH)以记之。

在测试期间强制还出现了如下现象，还挺好看的

```bash
start /b 爱心
Ctrl+C
Ctrl+C
Ctrl+C
```

![挺好看的](heart-colorful.png)