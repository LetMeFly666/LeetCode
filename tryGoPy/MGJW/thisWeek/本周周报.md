<!--
 * @Author: LetMeFly
 * @Date: 2025-02-28 09:33:07
 * @LastEditors: LetMeFly.xyz
 * @LastEditTime: 2025-03-03 16:54:37
-->
> [!CAUTION]
> 
> 上周组会没带电脑，不是因为“有高年级的架子”(完全没有这种想法)，更不是因为不尊重老师(如果不是因为上周组会，许老师开会我还真有可能不带电脑)。
>
> 而是没有意识到组会带电脑的重要性，因为我当时想的是“不带电脑就能完成的事情为什么要费劲带电脑”。

# 已有隐蔽传输方式

1. 通过shell连接到Windows并“提权”执行带有图形界面的程序
2. Windows自带远程连接-通过键盘大小写来实现零一传输

    远程连接的键盘大小写锁定和本机较为独立，更不能实时相互反映

    但是本机键盘在默认状态下大小写/数字锁定灯亮的情况下，若经过自然锁屏则对应指示灯不熄灭，一旦远程连接建立则立刻熄灭

3. 

# 改包

```bash
pip install mitmproxy
mitmproxy --mode transparent  # 禁止python透过防火墙的话，可能需要管理员权限下运行
# 也可以指定只捕获本机数据包：mitmproxy -s main.py --listen-host localhost
```

浏览器访问`http://mitm.it`下载证书并安装：

+ 双击P12文件，启动导入向导。
+ 选择证书存储位置(这将决定谁将信任该证书——仅当前Windows用户OR机器上的所有人)点击下一步。
+ 再次点击下一步。
+ 将密码留空并点击下一步。
+ 选择“将所有证书放入以下存储”，然后点击浏览，并选择“受信任的根证书颁发机构”。
+ 点击确定和下一步。
+ 点击完成。
+ 在警告对话框中点击是以确认。

若想编写脚本：

```python
from mitmproxy import http
import logging

logger_url = logging.getLogger('logger_url')
formatter_url = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s')
for handler in logger_url.handlers[:]:
    if isinstance(handler, logging.StreamHandler):
        logger_url.removeHandler(handler)
logger_url.setLevel(logging.DEBUG)
filehandler_url = logging.FileHandler('url.log')
filehandler_url.setFormatter(formatter_url)
logger_url.addHandler(filehandler_url)


logger_text = logging.getLogger('logger_text')
formatter_text = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s')
for handler in logger_text.handlers[:]:
    if isinstance(handler, logging.StreamHandler):
        logger_text.removeHandler(handler)
logger_text.setLevel(logging.DEBUG)
filehandler_text = logging.FileHandler('text.log')
filehandler_text.setFormatter(formatter_text)
logger_text.addHandler(filehandler_text)


def request(flow: http.HTTPFlow) -> None:
    # # 修改请求
    # if "letmefly.xyz" in flow.request.pretty_url:
    #     flow.request.headers["User-Agent"] = "Modified-Agent"
    pass

def response(flow: http.HTTPFlow) -> None:
    # 修改响应
    logger_url.info(flow.request.pretty_url)
    if "web.letmefly.xyz" in flow.request.pretty_url and 'text/html' in flow.response.headers.get('content-type', ''):
    # if flow.request.pretty_url == 'https://web.letmefly.xyz/':
        logger_url.info('replace HTML to LMTH')
        # logger_text.info(flow.response.text)
        flow.response.text = flow.response.text.replace("HTML", "LMTH")
```

设置代理服务器为`localhost:8080`，然后：

```bash
mitmproxy -s main.py --listen-host localhost
```

结果发现：请求替换成功！

代理前：

![代理前](pics/beforeChange.jpg)

代理后：

![代理后](pics/afterchange.jpg)

由于具有主机操作权限，所以主机信任mitm颁发的证书，浏览器也没有任何“不安全警告”，页面就这么悄无声息地被替换了。

# 邮件发送

# 邮件接收

# 消息验证

