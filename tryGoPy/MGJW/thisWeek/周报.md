<!--
 * @Author: LetMeFly
 * @Date: 2025-06-22 16:24:34
 * @LastEditors: LetMeFly.xyz
 * @LastEditTime: 2025-06-28 18:12:11
-->

# webex隐蔽传输后端融合



# 技术路线

技术路线分为OWA通过修改数据包的方式隐蔽传输（备用方案）、OWA通过信标的方式传输（主要方案）、webex通过双信息的方式传输（主要方案）这三部分。

以下将尽量以容易理解的语言讲述这三个部分。

## OWA通过修改数据包的方式隐蔽传输

**一句话描述** ：在邮件收发双方机器上都植入证书并运行改包脚本，发送方发送邮件时将要隐蔽传输的信息加密并隐藏插入邮件主体，接收方接收邮件时提取隐蔽信息解密并删除。由于代理是在系统层面的，所以应用层面看到的将会是与原始一模一样的邮件。

**具体方法**：

改包使用的是mitproxy，直接使用命令

```python
pip install mitmproxy
```

即可。

这部分的详细操作在`2025.3.8`的周报。

运行后需要访问`http://mitm.it`安装一个证书（不需要管理员权限），系统信任这个证书，浏览器就不会有“不安全警告”了。

然后只需要分析一下邮件收发时候的HTTP正文(HTML)格式，就能往指定部分插入加密后的数据了。

## OWA通过信标的方式隐蔽传输

**背景** 在美国国防部泄露的邮件中发现了使用公网信标这一行为的存在。所谓信标就是一个1x1像素的透明图片，不影响邮件的正常布局，但打开邮件就会加载图片，而每张图片都带有自己独一无二的参数，服务端返回图片的同时统计每张图片被访问了多少次，邮件发送者就可以通过服务端提供的数据确定这封邮件发出去后有没有被阅读过以及什么时候阅读的了。

**一句话描述** 自建信标服务，将密文作为信标id，除了提供信标功能外还能解码得到隐蔽消息。

**具体方法**

加密方式是AES加密，每次会自动生成临时密钥并用来加密，所以相同的内容每次加密结果不同。

这就具备一个天然优势，加密生成的密文就能直接作为信标ID，即使想要传输相同的内容也不会冲突。

这样还有一个好处，就是隐蔽信息的传出方（密级应该会相对严格）甚至可以不用联网，反正我生成的信标ID也是独一无二的，我只需要自己记录一下信标ID和邮件直接的对应关系就好了。

收发双方约定一个相同的密钥（也可以约定一套变动算法生成相同的动态密钥），发送方无需连接外网，直接通过内网OWA服务发送给低密级电脑，低密级电脑远程办公打开邮件就能在加载信标的同时让我们的服务端解密出原文了。

## webex通过双信息的方式传输

**背景** 灵感来源是gitdiff。两串字符串，字符串1如何在最小改动的情况下得到字符串2？git diff即可。git diff算法过程有依据表格计算路径的方法，因此可以将右移下移和右下移动分别定义为0、1和校验。更简单的，我们可以将两个等长字符串中对应位置ASCII码大小定义成0、1和校验。

**具体细节**

假如我想隐蔽传输一段代码，那么我可以依据这段代码生成两个等长字符串，使得两个字符串的编码结果记为想要传输消息的二进制。

这样做的一个优势是：由于IM消息的服务器无法永久性地保存消息，所以历史消息总有在服务器中过期的时候，而单一消息无法还原出隐藏信息。

我们可以约定一些位为校验位（例如3n+1），校验位用来匹配，其他位代表0和1。

webex有一个正常行为就是发送消息链接，接收方点击这个消息链接就能跳转到原始消息位置。例如：

`webexteams://im?space=388bc8a0-4f23-11f0-9978-197e3894c22a&message=5ce38670-4f23-11f0-8dc1-cf25d4d2274c`

我们可以修改其中的参数，例如修改为：

`webexteams://im?space=388bc8a0-4f23-11f0-9978-197e3894c22a&s=ljsjfl&message=5ce38670-4f23-11f0-8dc1-cf25d4d2274c`，这样仍不影响原有功能。而`s=`的值即可为编码字符串。

这样还需要接收方手动依据这些参数还原（虽然能ASCII码的话确实可以人肉计算还原），如果想要一个PLUS版本，还可以做一层转发服务。

转发服务可以直接重定向到原始地址，例如`https://letmefly.xyz/webexteams://im?space=388bc8a0-4f23-11f0-9978-197e3894c22a&s=ljsjfl&message=5ce38670-4f23-11f0-8dc1-cf25d4d2274c`可以直接重定向到`webexteams://im?space=388bc8a0-4f23-11f0-9978-197e3894c22a&s=ljsjfl&message=5ce38670-4f23-11f0-8dc1-cf25d4d2274c`。如果我想，我也可以在重定向时过滤掉`s`这个参数，但是没有什么意义，webex是不消费这个参数的。

用户勾选“允许浏览器打开webex”的话，访问这个链接就可以**无感**定位到原始消息的位置了。

而我们的重定向服务则可以拿到中间的参数了。

拿到参数后我们依据字符串长度和校验位匹配，如果匹配成功则可解密成功。

# 傻瓜式操作手册

1. OWA的信标系统 - 生成和查看信标（管理平台） - 5001
2. webex的双信息解码系统（管理平台） - 5002
3. OWA后端返回图片、解密服务 - 5003

TODO: 记录下outlook发送HTML的方案。