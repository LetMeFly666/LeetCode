<!--
 * @Author: LetMeFly
 * @Date: 2025-10-24 22:49:32
 * @LastEditors: LetMeFly.xyz
 * @LastEditTime: 2025-10-24 23:24:52
-->
# 一、通过提取特征层实现减少计算量的同时提高计算准确率
特征层提取是本研究实现提升检测效率的同时提升检测准确率的核心，其核心逻辑基于对 ViT 模型梯度数据特性的分析：ViT 模型客户端上传的梯度参数中，不同层对恶意攻击行为的响应敏感性存在显著差异，仅部分特定层包含能够表征攻击行为的关键信息，而其余大量层的梯度数据不仅占用冗余计算资源，还可能引入无关噪声，干扰后续检测模型对攻击特征的捕捉。因此，通过系统性筛选并提取对攻击行为敏感的特征层，可在数据预处理阶段实现对无效梯度信息的过滤，为后续检测流程的高效运行与精准识别提供数据支撑。

以 ViT-B/16 模型为例，单个客户端上传的原始梯度参数数量高达 85,806,346，若直接基于原始梯度进行检测，将导致内存占用超过 128GB，且其中大量 inactive 神经元的梯度信息与攻击检测任务无关，无法为恶意行为识别提供有效特征。为确定具有攻击敏感性的特征层，本研究设计了多场景验证实验：首先将 ViT 模型划分为 200 个候选层，各候选层平均包含数十万个参数；随后针对梯度上升攻击、标签翻转攻击、后门攻击等典型恶意场景，分别验证各候选层在不同攻击场景下的检测响应能力 —— 仅当某一候选层在特定攻击场景下的检测准确率达到 100% 时，将其纳入该攻击场景对应的敏感层列表；最终通过取多攻击场景敏感层列表的交集，并统计各层在多次重复实验中被选中的频次，筛选出对各类攻击均具有稳定敏感性的核心层（如编码器第 5 层的 attention.attention.key.bias 等）。

在实际特征层提取过程中，设第i个客户端上传的原始梯度为$g_i$，预设需保留的敏感层集合为$L_{keep}$，通过遍历$g_i$的所有层结构，仅保留名称属于$L_{keep}$的层，并将这些层的梯度信息重组为特征向量$\phi(g_i)$。实验结果表明，该提取过程可将单个客户端的梯度参数数量降至原始规模的$\frac{1}{10}$，即$\phi(g_i)$的参数数量约为 8.5×10⁶，显著减少后续检测流程的数据处理量；同时，由于$\phi(g_i)$仅保留对攻击行为敏感的梯度信息，有效剔除了无关噪声对检测结果的干扰，为后续维度压缩与异常识别的高精度实现奠定基础。

特征层提取完成后，需通过主成分分析（PCA）进一步降低数据维度，同时保留能够区分恶意与正常梯度的核心特征。首先对所有客户端的特征向量$\phi(g_i)$进行中心化处理，以消除不同客户端数据分布偏移对后续分析的影响，中心化计算公式为：

$$\hat{\phi}(g_i)=\phi(g_i)-\bar{\phi}$$
其中$\bar{\phi}$为所有客户端特征向量$\phi(g_i)$的均值，即$\bar{\phi}=\frac{1}{N}\sum_{i=1}^{N}\phi(g_i)$，$N$为参与训练的客户端总数。随后计算中心化后特征向量的协方差矩阵，以量化特征向量各维度间的相关性，协方差矩阵计算公式为：

$$C=\frac{1}{N}\sum_{i=1}^{N}\hat{\phi}(g_i)\hat{\phi}(g_i)^T$$

对协方差矩阵$C$进行特征值分解，得到特征值矩阵$\Lambda$与特征向量矩阵$V$，满足$C=V\Lambda V^T$，其中$\Lambda$为对角矩阵，其对角元素为特征值且按从大到小排序，$V$的每一列对应一个特征向量（即主成分方向）。选取前$r$个最大特征值对应的特征向量构建低维子空间$V_r=[v_1,v_2,...,v_r]$，将中心化后的特征向量投影至该子空间，得到降维后的特征向量：

$$\phi'(g_i)=V_r^T\hat{\phi}(g_i)$$

实验验证，该降维过程可将数据维度进一步降至原始规模的 0.4%，且未造成检测精度损失，为后续孤立森林算法的高效运行提供了数据条件。

在获得降维特征向量$\phi'(g_i)$后，采用孤立森林算法进行异常检测，以初步识别潜在的恶意客户端。孤立森林通过构建多棵隔离树（iTree）实现对异常数据的快速隔离，其核心原理在于：恶意客户端的梯度特征与正常客户端存在显著差异，在隔离树构建过程中更易被快速隔离，因此具有更短的平均路径长度。设构建的隔离树数量为$T$，对于每个降维特征向量$\phi'(g_i)$，计算其在每棵隔离树中的路径长度$h_t(\phi'(g_i))$（即从隔离树的根节点到该特征向量所在叶子节点的边数），则该特征向量的平均路径长度为：

$$h(\phi'(g_i))=\frac{1}{T}\sum_{t=1}^{T}h_t(\phi'(g_i))$$

为实现异常分数的标准化，引入归一化因子$c(n)$（其中$n$为构建单棵隔离树时所选取的样本数量），归一化因子计算公式为：

$$c(n)=2H(n-1)-\frac{2(n-1)}{n}$$
其中$H(x)$为调和数，可通过近似公式$H(x)=\ln(x)+\gamma$计算（$\gamma≈0.5772$为欧拉常数）。基于平均路径长度与归一化因子，计算第$i$个客户端的异常分数$s_i$：

$$s_i=2^{-\frac{h(\phi'(g_i))}{c(n)}}$$

当$s_i$趋近于 1 时，表明该客户端的梯度特征与正常特征差异显著，判定为恶意客户端的概率极高；当$s_i$趋近于 0 时，表明该客户端的梯度特征与正常特征高度一致，判定为正常客户端的概率极高，从而完成对恶意客户端的初步筛选。上述流程在 Fig. 1 中得到清晰呈现，从客户端上传梯度、敏感特征层提取、PCA 维度压缩，到孤立森林异常检测，形成了完整的 “梯度预处理 - 异常识别” 技术链路。

# 二、使用主观逻辑模型结合历史表现计算客户端权重
为降低单次异常检测的误判率，并实现对客户端行为的长期动态追踪，本研究引入主观逻辑模型，结合客户端的历史训练表现与当前轮次的异常检测结果，计算客户端的信任分数，进而确定其梯度在全局模型聚合中的权重，以保障全局模型的训练安全性与稳定性。

主观逻辑模型通过 “信任度（$b_i$）、不信任度（$d_i$）、不确定度（$u_i$）” 三个核心参数，量化客户端的信任状态，且满足约束条件$b_i+d_i+u_i=1$。在初始阶段，基于客户端过往训练轮次的梯度质量、历史检测结果等先验信息，初始化各客户端的信任参数$b_i(0)$、$d_i(0)$、$u_i(0)$；在第$t$轮训练过程中，结合当前轮次通过孤立森林算法得到的异常分数$s_i(t)$，对信任参数进行动态更新，具体更新公式如下：

$$b_i(t)=\frac{b_i(t-1)}{b_i(t-1)+d_i(t-1)+u_i(t-1)}$$

$$d_i(t)=\frac{d_i(t-1)\times s_i(t)}{b_i(t-1)+d_i(t-1)+u_i(t-1)}$$

$$u_i(t)=\frac{u_i(t-1)}{b_i(t-1)+d_i(t-1)+u_i(t-1)}$$

其中，$b_i(t)$表征对第$i$个客户端 “可信” 的信念强度，$d_i(t)$表征对该客户端 “不可信” 的信念强度，$u_i(t)$表征对该客户端信任状态的不确定程度。当客户端当前轮次的异常分数$s_i(t)$较高时，$d_i(t)$会相应增大，表明对该客户端 “不可信” 的信念增强；反之，若客户端当前轮次的异常分数$s_i(t)$较低，$b_i(t)$会维持在较高水平，表明对该客户端 “可信” 的信念保持稳定。

基于更新后的信任参数，计算第$i$个客户端在第$t$轮的综合信任分数$\sigma_i(t)$，该分数直接作为该客户端梯度在全局聚合过程中的权重，信任分数计算公式为：

$$\sigma_i(t)=\frac{b_i(t)}{b_i(t)+d_i(t)+u_i(t)}$$

由于$b_i(t)+d_i(t)+u_i(t)=1$，上述公式可简化为$\sigma_i(t)=b_i(t)$，即客户端的信任分数等价于其当前轮次的信任度参数，直观反映该客户端在当前训练阶段的可信程度。

在全局模型更新阶段，仅将信任分数较高的客户端梯度纳入聚合过程，以过滤恶意梯度对全局模型的干扰，全局模型参数$\theta$的更新公式为：

$$\theta←\theta-\eta\sum_{i=1}^{N}\sigma_i(t)\Delta\theta_i$$

其中，$\eta$为模型训练的学习率，$\Delta\theta_i$为第$i$个客户端上传的梯度更新量，$\sigma_i(t)$为该客户端的信任分数（即梯度聚合权重）。该更新过程通过信任分数对不同客户端的梯度进行加权，使高可信客户端的梯度对全局模型更新的贡献占比更高，低可信客户端的梯度贡献占比被削弱甚至排除，从而保障全局模型的训练稳定性与安全性。

此外，主观逻辑模型的引入实现了对客户端行为的 “时序积累” 效应：若某客户端在多轮训练中持续表现出正常行为（异常分数低、信任分数高），其信任度参数$b_i(t)$会逐渐优化，对应的梯度聚合权重趋于稳定；若某客户端因数据噪声等偶然因素导致单次异常分数偏高，由于历史信任参数的缓冲作用，其信任分数不会骤降，避免误判对正常训练流程的影响；而对于持续表现出异常行为的客户端，其不信任度参数$d_i(t)$会不断累积，信任分数逐渐降低至零，最终被排除在梯度聚合范围之外。这种 “长期追踪 - 动态调整” 的机制，进一步提升了恶意检测的鲁棒性，与 Fig. 1 中 “主观逻辑模型评分 - 可信客户端梯度聚合” 的流程形成技术闭环，构成了完整的恶意梯度防御体系。