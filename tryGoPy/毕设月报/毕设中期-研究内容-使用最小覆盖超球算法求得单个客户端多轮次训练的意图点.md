<!--
 * @Author: LetMeFly
 * @Date: 2025-10-23 23:07:04
 * @LastEditors: LetMeFly.xyz
 * @LastEditTime: 2025-10-24 22:49:41
-->

在本研究中，为了识别可能存在恶意更新行为的客户端并在聚合阶段降低其影响，我们采用基于局部离群因子（Local Outlier Factor, LOF）的异常检测方法对各客户端的意图点进行分布密度分析。LOF方法是一种典型的基于密度的异常检测算法，其核心思想是通过比较每个节点局部区域内的密度与其邻域密度的相对差异程度来判断其是否偏离簇结构，从而识别具有潜在恶意意图的客户端。

对于每个客户端，其训练过程中形成的模型更新方向可视为高维空间中的意图点 $O_i$。首先定义意图点 $O_i$ 的 $q$ 距离 $\widetilde{dis_i^q}$，即满足以下条件的意图点 $O_j$ 与 $O_i$ 的距离 $|O_i - O_j|$：

1. 在样本空间中至少存在 $q$ 个意图点，其到 $O_i$ 的距离不大于 $|O_i - O_j|$；
2. 在样本空间中至多存在 $q-1$ 个意图点，其到 $O_i$ 的距离严格小于 $|O_i - O_j|$。

因此，$\widetilde{dis_i^q}$ 表示高维空间中第 $q$ 个最近邻点对应的距离。以此距离为阈值，可构建意图点 $O_i$ 的第 $q$ 距离邻域 $Nei_i$，其包含所有与 $O_i$ 的距离不超过 $\widetilde{dis_i^q}$ 的意图点，且由于可能存在多个等距点，因此有 $|Nei_i| \geq q$。意图点分布越稀疏，其 $\widetilde{dis_i^q}$ 越大；分布越密集，其 $\widetilde{dis_i^q}$ 越小。

在此基础上定义可达距离：

$$rea_{i,j} = \max\left\{ \widetilde{dis_i^q}, \|O_i - O_j\| \right\}$$

即当 $O_j$ 与 $O_i$ 非常接近时，以 $\widetilde{dis_i^q}$ 表示有效局部尺度；当二者相距较远时，则采用其真实距离。进一步地，意图点 $O_i$ 的局部可达密度定义为：

$$lrd_i = \frac{1}{\frac{\sum_{j \in Nei_i} rea_{i,j}}{|Nei_i|}}$$

局部可达密度反映了意图点所在区域的紧密程度，密度越高，越可能与邻域点属于同一簇；密度越低，则越可能偏离正常分布。基于此，可得到局部离群因子：

$$lof_i = \frac{\sum_{j \in Nei_i} \frac{lrd_j}{lrd_i}}{|Nei_i|} = \frac{\sum_{j \in Nei_i} lrd_j}{|Nei_i| \cdot lrd_i}$$

当 $lof_i \approx 1$ 时，说明 $O_i$ 与周围邻域密度一致；当 $lof_i < 1$ 时，$O_i$ 所在区域比邻域更为密集；而当 $lof_i > 1$ 时，尤其是显著大于 $1$ 时，说明 $O_i$ 所在区域密度显著低于邻域，节点极有可能为恶意客户端。本研究中将所有满足 $lof_i > 1$ 的客户端视为异常客户端，并直接剔除其梯度更新。

在剔除异常客户端后，需要对剩余良性节点进行基于置信度的不确定性加权聚合。首先定义置信度：

$$cre_i = \frac{1}{r_i + \rho}$$

其中 $r_i$ 为第 $i$ 个客户端的最小覆盖超球半径，$\rho$ 为防止分母为零的极小正数。为了避免半径差值较大带来的置信度差异过度放大作用，进一步引入 Tanh 激活函数进行平滑处理：

$$cre_i' = \tanh\left( cre_i \right)$$

随后将处理后的置信度进行归一化，得到各客户端的聚合权重：

$$w_i = \frac{cre_i'}{\sum_{k=1}^{N} cre_k'}$$

因此，第 $t$ 轮全局模型更新为：

$$\theta_g^t = \theta_g^{t-1} + \sum_{i=1}^{N} w_i \nabla \theta_i^t$$

如图所示展示了异常检测和梯度聚合的计算流程示意图。图中每个球都是某个节点的意图范围。蓝色的球代表良性节点，红色的球代表异常节点。在进行异常检测时我们只考虑每个节点的意图点，即图中的球心位置。在计算可达距离时，由于意图点$O_{j_1}$距离意图点$O_i$较近，故二者之间的可达距离为意图点$O_i$的$q$距离$\widetilde{dis_i^q}$；由于意图点$O_{j_2}$距离$O_i$较远，所以二者之间的可达距离为二者之间的实际距离$\|O_i-O_{j_2}\|$。意图点$O_i$的密度高于其邻域意图点的密度，$lof_i<1$；而意图点$O_{j_2}$的密度低于其邻域意图点的密度，因此$lof_{j_2} > 1$。聚合过程中会将异常节点剔除，在聚合良性节点的梯度时，会依据正常节点的置信度进行加权处理。图中可以看出，虽然节点$j_1$被划分为了良性节点，但其置信度非常低，其超球甚至已经与异常节点$j_2$有所重合。因此在梯度聚合的时候，正常节点$j_1$的$j_1$聚合权重会比较小。