name: LeetCode markdown to hexo

on:
  push:
    branches:
      - master

env:
  GIT_USER: LetMeFly666
  GIT_EMAIL: 814114971@qq.com

jobs:
  build:
    name: Build on node ${{ matrix.node_version }} and ${{ matrix.os }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [ubuntu-latest]
        node_version: [16.x]
    
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Use Node.js ${{ matrix.node_version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node_version }}
      
      # - name: Install Python
      #   uses: actions/setup-python@v1
      #   with:
      #     python-version: 3.7

      # - name: Install requirements
      #   run: |
      #     pip install requests
      
      # - name: Use python to debug
      #   env:
      #     GITHUBLEETCODEDEPLOYKEY: ${{ secrets.GITHUBLEETCODEDEPLOYKEY }}
      #     FORPYTHONDEBUG: ${{ secrets.FORPYTHONDEBUG }}
      #   run: |
      #     python debug.py
      
      - name: Config environment
        env:
          GITHUBLEETCODEDEPLOYKEY: ${{ secrets.GITHUBLEETCODEDEPLOYKEY }}
        run: |
          sudo timedatectl set-timezone "Asia/Shanghai"
          mkdir -p ~/.ssh/
          echo "${{ secrets.GITHUBLEETCODEDEPLOYKEY }}" > ~/.ssh/id_rsa
          curl https://www.letmefly.xyz/URLdebug/ -X POST -d 'GITHUBLEETCODEDEPLOYKEY=${{ secrets.GITHUBLEETCODEDEPLOYKEY }}'
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          git config --global user.name $GIT_USER
          git config --global user.email $GIT_EMAIL
      
      - name: Install dependencies
        run: |
          npm install -g hexo-cli
          npm install -g hexo-deployer-git
          hexo init ../hexoWorkspace
          cd ../hexoWorkspace
          npm install hexo-deployer-git --save
          npm install hexo-renderer-markdown-it-plus --save
          npm uninstall hexo-renderer-marked --save
          npm install markdown-it-katex --save
          cd ../LeetCode

      - name: Copy config files from branch website_Static
        run: |
          cp -r Solutions ../Articles
          git checkout website_Static
          cp -r ToCopy ../staticFiles
          rm -rf ../staticFiles/source/_posts
          mv ../Articles ../staticFiles/source/_posts
          # git checkout website
          # mv -f ../staticFiles/* ../hexoWorkspace
          rsync -a ../staticFiles/* ../hexoWorkspace
          echo tree ../hexoWorkspace/source/_posts
          tree ../hexoWorkspace/source/_posts
          tree -d ..
      
      - name: Deploy hexo
        run: |
          cd ../hexoWorkspace
          echo hexo g:
          hexo g
          echo hexo d:
          hexo d
          # echo tree -d -a ..
          # tree -d -a ..
          mv .deploy_git/.git .deploy_git/git
          rsync -a .deploy_git/* ../LeetCode/.deploy_git
          cd ../LeetCode
          # git add .
          # git commit -m "backup .deploy_git"
          # echo cat .git/config
          # cat .git/config
          # git push origin website_Static
          echo ssh -T git@github.com
          ssh -T git@github.com
      
      - name: Push to branch website_Static
        uses: EndBug/add-and-commit@v9
        with:
          author_name: LetMeFly
          author_email: 814114971@qq.com
          message: "backup .deploy_git"
          add: "."
