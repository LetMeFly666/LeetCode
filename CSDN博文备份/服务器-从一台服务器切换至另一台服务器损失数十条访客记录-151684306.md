<h2><a id="__PV_1"></a>服务器 - 从一台服务器切换至另一台服务器(损失数十条PV记录为代价)</h2> <br><blockquote> <br> <p>看着四年的服务器正式到期，没什么轰轰烈烈的告别，就像目送老朋友转身走远，只默默记下：哦，原来它陪了我这么久啊。</p> <br></blockquote> <br><h3><a id="_5"></a>前言</h3> <br><p>一台陪伴了我4年的服务器昨天晚上到期了，数据和服务迁移到新服务器上有两点想尽可能保证的：</p> <br><ol><li>服务不中断</li><li>数据不丢失</li></ol> <br><p>最终结果是服务没中断，迁移过程中丢失了约数十条的PV记录。</p> <br><p>大致流程是：新服务器部署环境安装依赖同步静态数据 --> 新服务器上准备好服务启动命令准备按回车 --> 旧服务器导出数据库数据传输到新服务器上并导入新服务器数据库 --> 新服务器快速启动服务 --> 将流量切到新服务器上。</p> <br><p>中间从<code>旧服务器开始导出数据</code>到<code>流量切到新服务器上</code>这段时间的产生的十几条PV记录写到了旧服务器上并与新服务器数据库产生了冲突。由于影响不是很大就没去处理。</p> <br><p>当然想做到数据也不丢失似乎也可以通过主从数据库的方式来保证，但主要是我不会。</p> <br><h3><a id="_20"></a>过程</h3> <br><h4><a id="_22"></a>新服务器安装依赖部署环境同步旧服务器的静态数据</h4> <br><p>我有一个习惯，旧服务器上的配置几乎都存放在一个专门的文件夹<code>TFpath</code>，然后<code>ln -s</code>软链接到原始位置，这样不论我修改什么配置，实质上配置文件都会在<code>TFpath</code>文件夹下被修改。</p> <br><p>也就是说这些静态配置我只需要<code>scp</code>到新服务器上并在新服务器上将他们分别软链接到对应位置就好了。</p> <br><p>这样在新服务器上安装好各个服务后一启动，配置就和旧服务器一样了。 万物皆文件好啊(bushi)</p> <br><p>代码什么的统统复制到新服务器上，该安装的依赖安装好，坐等数据库改好后一键启动。</p> <br><h4><a id="_32"></a>旧服务器导出数据库数据传输到新服务器上并导入新服务器数据库</h4> <br><p>我所涉及的动态数据主要存储在MySQL中，<code>mysqldumps -u xx -p --all-databases > all.sql</code>可方便导出整个数据库，<code>scp all.sql user@ip:path</code>可将数据库文件拷贝到新服务器上，新服务器上在MySQL命令行中执行<code>source all.sql</code>即可一键将数据库变得和旧服务器相同，连用户名密码都会变得一致。</p> <br><p>有了数据之后，新服务器上的服务就可以启动，等待流量的到来了。</p> <br><h4><a id="_38"></a>将流量切换到新服务器上</h4> <br><p>我使用的是CloudFlare的DNS(以及CDN)，代理模式为完全。虽然名义上是CDN实际上在国内就是个减速器，这样做的目的主要是友好为数不多的国外用户以及隐匿我的真实IP。</p> <br><p>实质上当你访问我的域名如<code>https://letmefly.xyz</code>时，DNS服务器将请求定向到其中一个Cloudflare节点上，Cloudflare节点再去请求我的源服务器，这样第三方用户就不知道我的真实IP了。</p> <br><p>虽然通过一些特殊手段还是可能反映射到，但是cloudflare已经在很大程度上保证源服务器的安全了。请大家把赛博菩萨打在公屏上。</p> <br><p>这样还有一个好处，就是切流量异常地顺利，几乎可以说是秒级。因为这种机制导致切流量时无需更新DNS，用户仍然访问cloudflare节点，cloudflare直接把流量切到新机器上就好了。</p> <br><h3><a id="_48"></a>现在可以公开的情报</h3> <br><p>旧服务器IP是<code>123.56.114.139</code>，这个倒背如流的IP可以公开了。</p> <br><p>新服务器的IP还藏在坚强的CloudFlare护盾后面，以防一波应该不会出现的针对源IP服务器直接的DDoS。</p> <br><h3><a id="QA_54"></a>Q&A</h3> <br><p>有人说为何不借助云服务商的一键迁移或者镜像导入导出？</p> <br><blockquote> <br> <p>这样是很省事儿，一个是迁移过程中可能仍然会有部分数据修改到旧服务器上，一个是阿某云轻量应用服务器不支持大磁盘机器向小磁盘机器的一键迁移（想一键迁移还得氪金）。</p> <br></blockquote> <br><p>有人说备案问题怎么解决？新服务器会不会因为没有备案导致流量被拦截？</p> <br><blockquote> <br> <p>不会。个人备案主要备的是域名不是IP，工信部规定解析到中国IP的域名都需要进行备案否则将会被拦截，但是我这个域名在旧服务器上的时候已经备案过了，所以不会被拦截。</p> <br></blockquote> <br><h3><a id="Last_But_Not_Least_64"></a>Last But Not Least</h3> <br><p>陪伴了我4年的老战友，值得一个小小的纪念仪式。</p> <br><p><img src="https://i-blog.csdnimg.cn/direct/ad47918d32754204ada29783364cb2ad.png" alt="还有最后10分钟" /></p> <br><p><img src="https://i-blog.csdnimg.cn/direct/f5653230709e42428a74bba4b3e298c1.png" alt="时间归零" /></p> <br><p><img src="https://i-blog.csdnimg.cn/direct/70ef1566308b4e75b896980b800b7e16.png" alt="goodbye隐藏款" /></p> <br><p><img src="https://i-blog.csdnimg.cn/direct/77de92cccae346d88daa8d2f8899be00.png" alt="goodbye" /></p> <br><p>介绍后想起来两台同区域的阿里云服务器之间数据应该是可以通过局域网IP快速传，免受公网IP带宽限制。</p> <br><h3><a id="End_78"></a>End</h3> <br><p>当然这也许并非最优解，也许会有很多更简单好用的方法。如果有，请不要吝惜告诉我。</p> <br><center><br> <font size="6px" face="Ink Free">The Real End, Thanks!</font><br></center> <br><blockquote> <br> <p>同步发文于<a href="https://letmefly.blog.csdn.net/article/details/151684306" rel="nofollow">CSDN</a>和我的<a href="https://blog.letmefly.xyz/" rel="nofollow">个人博客</a>，原创不易，转载经作者同意后请附上<a href="https://blog.letmefly.xyz/2025/09/14/Other-Server-From1Server2Another/" rel="nofollow">原文链接</a>哦~</p> <br> <p>千篇源码题解<a href="https://github.com/LetMeFly666/LeetCode">已开源</a></p> <br></blockquote>