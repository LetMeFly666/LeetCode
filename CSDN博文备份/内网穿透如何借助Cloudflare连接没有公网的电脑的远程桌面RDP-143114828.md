<p><img src="https://i-blog.csdnimg.cn/direct/88c85b30e2074648b7130d3d5893a7fd.png" alt="在这里插入图片描述" /></p> <br><h2><a id="CloudflareRDP_1"></a>内网穿透：如何借助Cloudflare连接没有公网的电脑的远程桌面(RDP)-含详细原理配置说明介绍</h2> <br><h3><a id="_3"></a>前言</h3> <br><p>远程桌面协议(RDP, Remote Desktop Protocol)可用于远程桌面连接，Windows系统（家庭版除外）也是支持这种协议的，无需安装额外客户端即可实现类似向日葵、toDesk等的远程桌面访问与控制。</p> <br><p>但是前提是被控制的电脑有公网ip或者可以被局域网访问。没有公网ip又不在同一个局域网中的电脑如何使用这个协议进行远程连接呢？那就试试大名鼎鼎的cloudflare的内网穿透<code>零信任tunnel</code>技术吧！</p> <br><h3><a id="_9"></a>准备</h3> <br><ul><li>需要有两台电脑，一台配置好<a href="https://support.microsoft.com/zh-cn/windows/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E8%BF%9C%E7%A8%8B%E6%A1%8C%E9%9D%A2-5fe128d5-8fb1-7a23-3b8a-41e636865e8c" rel="nofollow">远程桌面</a>用于被<a href="https://blog.csdn.net/qq_44665283/article/details/122716174">远程访问</a>，一台电脑用于连接这台电脑。</li><li>需要注册<a href="https://dash.cloudflare.com/" rel="nofollow">Cloudflare</a>账号并且绑定一个<a href="https://www.cnblogs.com/eslzzyl/p/17765702.html" rel="nofollow">域名</a>。</li></ul> <br><h3><a id="_14"></a>方法</h3> <br><ol><li> <p>进入Cloudflare零信任控制台（<code>控制台主页</code> -> <code>ZeroTrust</code> -> <code>Networks</code> -> <code>Tunnels</code>）</p> <p><img src="https://i-blog.csdnimg.cn/direct/35682e0aa2a34253b55e605aadfe9232.png" alt="进入Cloudflare零信任控制台，并点击Create Tunnel" /></p> </li><li> <p>新建Tunnel（<code>Create Tunnel</code> -> <code>Select Cloudflared</code> -> <code>起个名字</code> -> <code>Save tunnel</code>）</p> <p><img src="https://i-blog.csdnimg.cn/direct/8c4cf63fea154cbba20980cbeac5a04d.png" alt="创建tunnel" /></p> </li><li> <p>两台电脑都下载并安装<a href="https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.msi">cloudflared客户端</a>，并且复制<code>命令行代码</code></p> <p><img src="https://i-blog.csdnimg.cn/direct/f8739f8f25194d429d46cc72710eb69e.png" alt="安装cloudflared客户端，并记录密钥(命令)" /></p> </li><li> <p>在被控制的电脑上运行刚才复制的命令（<code>Win + S</code> -> <code>cmd</code> -> <code>右键“命令提示符”</code> -> <code>以管理员身份运行</code> -> <code>在弹出的小黑框中输入刚才复制的命令并回车</code>）</p> <p><img src="https://i-blog.csdnimg.cn/direct/bdda499c3ac14011a92cc3f6d3b98ea4.png" alt="命令提示符" /></p> <p>配置成功后应该能在下方<code>Connectors</code>列表中看到一个“连接者”。</p> </li><li> <p>配置域名（外网访问与内网映射规则）（<code>点击网页上的Next</code> -> <code>选择一个域名</code> -> <code>协议选择RDP</code> -> <code>URL输入localhost://3389</code>因为rdp默认端口是3389 -> <code>Save Tunnel</code>）</p> <p><img src="https://i-blog.csdnimg.cn/direct/9b76b1b2466942a4b82c95fec61ba4b8.png" alt="Next" /></p> <p><img src="https://i-blog.csdnimg.cn/direct/b913ef86a84b46baa522ef386d21b2f1.png" alt="配置域名" /></p> </li><li> <p>在控制者电脑上同样打开“命令提示符”，输入命令<code>cloudflared.exe access rdp --hostname test.letmefly.xyz --url rdp://localhost:1234</code>，就可以远程连接另一台电脑了（<code>Win + R</code> -> <code>cmd</code> -> <code>回车</code> -> <code>替换这个命令并回车</code> -> <code>Win + R</code> -> <code>mstsc</code> -> <code>回车</code> -> <code>localhost:3089</code> -> <code>填写远程连接的用户名并回车</code> -> <code>输入密码并完成远程连接</code>）</p> </li></ol> <br><h3><a id="_42"></a>原理解释</h3> <br><blockquote> <br> <p>关于我为什么要写这篇文章，是因为网上很多现有文章之说操作步骤不讲原理。有的跟着配置下来在自己电脑上还会踩上不少坑。因此我想简单介绍下它的原理，以及为什么这么操作。</p> <br></blockquote> <br><p><strong>整体原理</strong></p> <br><p>被控制电脑没有公网IP也没有处于控制者电脑所在局域网中，控制者电脑想要连接它但是访问不到它。</p> <br><p>但是Cloudflare有公网IP，因此被控制电脑要安装<code>cloudflared</code>客户端并输入命令，其实是被控制电脑与cloudflare服务器建立了一个持久性连接（隧道）。</p> <br><p>控制者电脑访问配置的域名，流量到达cloudflare服务器，借助cloudflare服务器实现与被控制者的通信。</p> <br><p>准确来说，不知道这样能否被称为是内网穿透（因为所有流量大概都需要经过cloudflare服务器转发一下，并没有控制者与被控制者两台电脑的直接通信），应该是属于内网穿透的吧。</p> <br><p><strong>新建Tunnel是在干什么</strong></p> <br><p>新建<code>Tunnel</code>就是新建一个cloudflare与被控制者之间的“隧道”，二者通过“隧道”保持持久化连接。</p> <br><p><strong>被控制者电脑为何要安装cloudflared客户端并输入那一串命令</strong></p> <br><p>安装客户端是因为要借助客户端来建立与cloudflare服务器之间的隧道。</p> <br><p>那串命令是为了让cloudflare服务器知道这台电脑要连接哪个隧道（起识别作用的是命令最后的那串“乱码”）。</p> <br><p><strong>配置域名（外网访问与内网映射规则）是在干什么，具体应该怎么配置</strong></p> <br><p>配置了访问规则，cloudflare才知道流量到来时才能如何转发、通过哪个隧道以及什么规则转发给哪个机器。</p> <br><p>第一行是控制者(访问者)相关的配置。<code>子域名（Subdomain）</code>是自己定义的，<code>域名（Domain）</code>是你购买/拥有的绑定在Cloudflare的域名，<code>路径（Path）</code>是访问哪个路径时转发规则生效。</p> <br><p>第二行是被控制者(被访问者)相关的配置。<code>Type</code>是协议类型（RDP是微软远程桌面连接的协议），<code>URL</code>是流量要被转发到哪里（被访问者的RDP服务的地址）。</p> <br><p>例如我上述配置中，<code>Subdomain</code>是<code>test</code>，<code>Domain</code>是<code>letmefly.xyz</code>，<code>Type</code>是<code>RDP</code>，<code>URL</code>是<code>localhost:3389</code>。因此我在控制者电脑上使用<code>RDP</code>协议访问<code>test.letmefly.xyz</code>时，流量会被转发到被控制者的<code>localhost:3389</code>上。</p> <br><p><strong>访问者电脑上的配置是怎么回事</strong></p> <br><p>访问者电脑上输入的那串命令相当于是把对于<code>localhost:1234</code>的<code>RDP</code>访问转发到<code>test.letmefly.xyz</code>上，因此<code>mstsc</code>后输入<code>localhost:1234</code>流量就可以被转发到<code>test.letmefly.xyz</code>然后被通过隧道转发到被控制机器的<code>localhost:3389</code>上，从而实现了远程桌面连接。</p> <br><p>注意，命令中的<code>test.letmefly.xyz</code>需要修改成你所配置的域名，<code>1234</code>可以修改，但注意不要和其他端口冲突（比如控制者主机上也开启了RDP能被其他设备控制的话3389端口很可能被占用了）。</p> <br><h3><a id="_82"></a>后记</h3> <br><blockquote> <br> <p>同步发文于CSDN，原创不易，转载经作者同意后请附上<a href="https://blog.letmefly.xyz/2024/10/21/Other-Net_Traversal-How2UseCloudflareConnectingRDP%28RemoteDesktopProtocol%29WithoutPublicIP/" rel="nofollow">原文链接</a>哦~</p> <br> <p>Tisfy：<a href="https://letmefly.blog.csdn.net/article/details/143114828" rel="nofollow">https://letmefly.blog.csdn.net/article/details/143114828</a></p> <br></blockquote>